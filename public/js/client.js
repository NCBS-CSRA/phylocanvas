$(function(){"use strict";if(WGST.version="0.1.3","undefined"==typeof window.WGST.requestedCollectionId&&window.WGST.isNewCollection!==!0)return $(".wgst-page__landing").show(),void 0;if($(".wgst-page__app").show(),WGST.speak=!1,WGST.speak){var e=new SpeechSynthesisUtterance("Welcome to WGSA");window.speechSynthesis.speak(e)}window.onerror=function(e){"undefined"!=typeof e.message?console.error("[WGST][Error] "+e.message):(console.error("[WGST][Error]"),console.dir(e)),g(e)},WGST.panels={assembly:{top:80,left:90},collection:{top:80,left:90},collectionTree:{top:120,left:180},mergedCollectionTree:{top:120,left:180},representativeCollectionTree:{top:80,left:90},assemblyUploadNavigator:{top:70,left:110},assemblyUploadAnalytics:{top:70,left:726},assemblyUploadMetadata:{top:225,left:110},assemblyUploadProgress:{top:80,left:90},map:{top:"15%",left:"20%"}},WGST.assembly={analysis:{UPLOAD_OK:"UPLOAD_OK",METADATA_OK:"METADATA_OK",MLST_RESULT:"MLST_RESULT",PAARSNP_RESULT:"PAARSNP_RESULT",FP_COMP:"FP_COMP",CORE:"CORE"}},WGST.collection={analysis:{COLLECTION_TREE:"COLLECTION_TREE",CORE_MUTANT_TREE:"CORE_MUTANT_TREE"},representative:{tree:{},metadata:{}}},WGST.upload={collection:{},assembly:{}},WGST.settings=WGST.settings||{},WGST.settings.representativeCollectionId="1fab53b0-e7fe-4660-b34e-21d501017397",WGST.antibioticNameRegex=/[\W]+/g,WGST.socket={connection:io.connect(window.WGST.config.socketAddress),roomId:""},WGST.geo={map:{canvas:{},options:{zoom:5,center:new google.maps.LatLng(48.6908333333,9.14055555556),mapTypeId:google.maps.MapTypeId.ROADMAP,minZoom:2,maxZoom:11},markers:{assembly:{},metadata:{},representativeTree:[],group:{}},markerBounds:new google.maps.LatLngBounds,searchBoxBounds:new google.maps.LatLngBounds,init:function(){WGST.geo.map.canvas=new google.maps.Map($(".wgst-map")[0],WGST.geo.map.options),WGST.geo.map.markers.metadata=new google.maps.Marker({position:new google.maps.LatLng(51.511214,-.119824),map:WGST.geo.map.canvas,visible:!1}),google.maps.event.addListener(WGST.geo.map.canvas,"bounds_changed",function(){WGST.geo.map.searchBoxBounds=WGST.geo.map.canvas.getBounds()})}},placeSearchBox:{}},WGST.alert={status:{SUCCESS:"success",FAILURE:"failure"}},WGST.init={all:{SOCKET_CONNECT:"Socket connected",SOCKET_ROOM_ID:"Received socket room id",REPRESENTATIVE_COLLECTION_TREE_METADATA:"Loaded representative collectiontree metadata"},loaded:[]},WGST.dragAndDrop=WGST.dragAndDrop||{},WGST.dragAndDrop.files=[],WGST.dragAndDrop.fastaFileNameRegex=/^.+(.fa|.fas|.fna|.ffn|.faa|.frn|.fasta|.contig)$/i;var t=function(e){if(WGST.init.loaded.push(e),WGST.init.loaded.length===Object.keys(WGST.init.all).length){var t=$(".wgst-init");t.find(".wgst-init-status").html(""),setTimeout(function(){t.fadeOut("fast")},500),delete WGST.init}},a=function(e){var t=function(e){var t=$('[data-panel-name="'+e+'"] .wgst-panel-body-content');t.css("visibility","visible")};if($.isArray(e))for(var a,s=e.length;0!==s;)s-=1,a=e[s],t(a);else t(e)},s=function(e){var t=function(e){$('[data-panel-name="'+e+'"]').addClass("wgst-panel--visible").css("visibility","visible")};if($.isArray(e))for(var a,s=e.length;0!==s;)s-=1,a=e[s],t(a);else t(e)},o=function(e){var t=$('[data-panel-name="'+e+'"] .wgst-panel-loading');t.show()},l=function(e){var t=$('[data-panel-name="'+e+'"] .wgst-panel-loading');t.hide()};$(".tree-controls-draw-subtree").on("click",function(){var e=$(this).closest(".wgst-panel").attr("data-collection-id"),t=$(this).attr("data-selected-node");console.log("collectionId: "+e),console.log("selectedNode: "+t),WGST.collection[e].tree.canvas.redrawFromBranch(t)}),$(".collection-view-horizontal-split").on("click",function(){$(".wgst-paper__collection-tree"),$(".wgst-paper__collection-metadata")});var n=function(e){var t=$('[data-panel-name="'+e+'"]');return t.hasClass("wgst-panel--active")?!0:!1},i=function(e,t){var a=function(e){var t=$('[data-panel-name="'+e+'"]');t.css("top",WGST.panels[e].top),t.css("left",WGST.panels[e].left),t.css("visibility","hidden"),t.show(),t.addClass("wgst-panel--active")};if($.isArray(e))for(var s,o=e.length;0!==o;)o-=1,s=e[o],a(s);else a(e);"function"==typeof t&&t()},r=function(e){var t=function(e){{var t=$('[data-panel-name="'+e+'"]');t.find(".wgst-panel-body-content")}t.hide(),t.removeClass("wgst-panel--active"),t.removeClass("wgst-panel--visible")};if($.isArray(e))for(var a,s=e.length;0!==s;)s-=1,a=e[s],t(a);else t(e)},c=function(e){var t=0;$(".wgst-panel").each(function(){var e=parseInt($(this).css("zIndex"),10);e>t&&(t=e)}),$('[data-panel-name="'+e+'"]').css("zIndex",t+1)},d=function(e){i(e),l(e),a(e),s(e),c(e)},p=function(e){console.log("[WGST] Getting representative collection tree metadata"),$.ajax({type:"GET",url:"/api/collection/representative/metadata",datatype:"json"}).done(function(t){console.log("[WGST] Got representative collection tree metadata"),console.dir(t),e(null,t)}).fail(function(t,a,s){console.error("[WGST][Error] ✗ Failed to get representative collection tree metadata"),console.error(a),console.error(s),console.error(t),e(a,null)})},m=function(e,t,a){if(console.error("[WGST][Error] ✗ "+e),WGST.speak){var e=new SpeechSynthesisUtterance(e);window.speechSynthesis.speak(e),WGST.speak=!1}var s=$(".wgst-alert");s.attr("class","wgst-alert").addClass("wgst-alert__"+t),s.html(e).show(),a&&setTimeout(function(){s.fadeOut("fast")},3e3)},g=function(){var e=$(".wgst-notification__error");e.html("Please refresh your page.").show()};!function(){$(".wgst-draggable").draggable({handle:".wgst-draggable-handle",appendTo:"body",scroll:!1,start:function(){U=!0},stop:function(e,t){U=!1;var a=t.helper.attr("data-panel-name");WGST.panels[a].top=t.position.top,WGST.panels[a].left=t.position.left}}),$(".assembly-list-slider").slider({range:"max",min:0,max:10,value:0,animate:"fast",slide:function(){}}),$(".add-data button").popover({html:!0,placement:"bottom",title:"Add your data",content:'<div class="upload-data"><span>You can drag and drop your CSV files anywhere on the map.</span><input type="file" id="exampleInputFile"></div>'}),$(".timeline-toggle-button").on("click",function(){$(this).hasClass("active")?$("#timeline").hide():($("#timeline").css("bottom","0"),$("#timeline").show())}),$(".graph-toggle-button").on("click",function(){$(this).hasClass("active")?$(".tree-panel").hide():$(".tree-panel").show()}),$(".all-panels-toggle-button").on("click",function(){$(this).hasClass("active")?$(".wgst-panel--active").hide():$(".wgst-panel--active").show()}),$(".graph-toggle-button").trigger("click"),WGST.socket.connection.on("roomId",function(e){console.log("[WGST][Socket.io] Received room uuid"),console.log("[WGST][Socket.io] Ready"),WGST.socket.roomId=e,t(WGST.init.all.SOCKET_ROOM_ID)}),WGST.socket.connection.emit("getRoomId"),WGST.socket.connection.on("connect",function(){"undefined"!=typeof WGST.init&&t(WGST.init.all.SOCKET_CONNECT)}),WGST.socket.connection.on("error",function(){m("Unexpected error has occured.",WGST.alert.status.FAILURE,!1)}),WGST.socket.connection.on("disconnect",function(){m("Disconnected from the server.",WGST.alert.status.FAILURE,!1)}),WGST.socket.connection.on("reconnecting",function(){m("Reconnecting to the server...",WGST.alert.status.FAILURE,!1)}),WGST.socket.connection.on("reconnect",function(){m("Reconnected to the server.",WGST.alert.status.SUCCESS,!0)}),WGST.socket.connection.on("reconnect_failed",function(){m("Failed to reconnect to the server.",WGST.alert.status.FAILURE,!1)}),p(function(e,a){return e?(g(e),void 0):(WGST.collection.representative.metadata=a,i("representativeCollectionTree",function(){o("representativeCollectionTree"),jt()}),t(WGST.init.all.REPRESENTATIVE_COLLECTION_TREE_METADATA),void 0)})}();var u=function(e,t){var a,s,o,l,n,i,r,c="";for(s in t)if(t.hasOwnProperty(s)){a=t[s],o="  ",i="";for(l in a)a.hasOwnProperty(l)&&(n="","undefined"!=typeof e[s]?"undefined"!=typeof e[s][l]?(r=e[s][l].resistanceState,n+="RESISTANT"===r?"⦿":"SENSITIVE"===r?"○":"○"):n+="○":n+="○",i+=n);o+=i,c+=o}return c},b=function(e,t){var a,s,o,l,n,i,r,c="";for(s in t)if(t.hasOwnProperty(s)){a=t[s],o='<div class="antibiotic-group" data-antibiotic-group-name="'+s+'">{{antibioticsHtml}}</div>',i="";for(l in a)a.hasOwnProperty(l)&&(n="","undefined"!=typeof e[s]?"undefined"!=typeof e[s][l]?(r=e[s][l].resistanceState,n="RESISTANT"===r?n+'<span class="antibiotic resistance-fail" data-antibiotic-name="'+l+'" data-antibiotic-resistance-state="'+r+'" data-toggle="tooltip" data-placement="top" title="'+l+'"></span>':"SENSITIVE"===r?n+'<span class="antibiotic resistance-success" data-antibiotic-name="'+l+'" data-antibiotic-resistance-state="'+r+'" data-toggle="tooltip" data-placement="top" title="'+l+'"></span>':n+'<span class="antibiotic resistance-unknown" data-antibiotic-name="'+l+'" data-antibiotic-resistance-state="'+r+'" data-toggle="tooltip" data-placement="top" title="'+l+'"></span>'):(n=n+'<span class="antibiotic resistance-unknown" data-antibiotic-name="'+l+'" data-antibiotic-resistance-state="'+r+'" data-toggle="tooltip" data-placement="top" title="'+l+'"></span>',console.warn("[!] Assembly resistatance profile has no antibiotic: "+l)):(n=n+'<span class="antibiotic no-resistance-data" data-antibiotic-name="'+l+'" data-antibiotic-resistance-state="'+r+'" data-toggle="tooltip" data-placement="top" title="'+l+'"></span>',console.warn("[!] Assembly resistatance profile has no antibiotic group: "+s)),i+=n);o=o.replace(/{{antibioticsHtml}}/g,i),c+=o}return c},f=function(e,t){console.log("[WGST] Rendering assembly analysis list");for(var a,s,o,l,n,i,r,c=WGST.collection[e].assemblies,d=WGST.collection[e].sortedAssemblyIds,p=0,m=$(".collection-assembly-list"),g=$(".collection-assembly-list-full"),u=document.createDocumentFragment();p<d.length;)a=d[p],console.log("[?] Assembly resistance profile:"),console.dir(c[a].PAARSNP_RESULT.paarResult.resistanceProfile),s=c[a].PAARSNP_RESULT.paarResult.resistanceProfile,o=b(s,t),l=Et(c[a].FP_COMP.scores),WGST.collection[e].assemblies[a].FP_COMP.topScore=l,n=c[a].ASSEMBLY_METADATA.geography.position.latitude,i=c[a].ASSEMBLY_METADATA.geography.position.longitude,r=$((p%2===0?'<div class="row-stripe assembly-list-item" data-assembly-id="'+c[a].FP_COMP.assemblyId+'">':'<div class="assembly-list-item" data-assembly-id="'+c[a].FP_COMP.assemblyId+'">')+'<div class="show-on-tree-radio-button assembly-list-header-tree"><input type="radio" data-reference-id="'+l.referenceId+'" data-assembly-id="'+c[a].FP_COMP.assemblyId+'" name="optionsRadios" value="'+l.referenceId+'"></div><div class="show-on-map-checkbox assembly-list-header-map"><input type="checkbox" data-reference-id="'+l.referenceId+'" data-assembly-id="'+c[a].FP_COMP.assemblyId+'" data-latitude="'+n+'" data-longitude="'+i+'"></div><div class="assembly-list-header-id"><a href="#" class="open-assembly-button" data-assembly-id="'+c[a].FP_COMP.assemblyId+'" title="'+c[a].ASSEMBLY_METADATA.userAssemblyId+'">'+c[a].ASSEMBLY_METADATA.userAssemblyId+'</a></div><div class="assembly-list-header-nearest-representative"><a href="#" class="show-on-representative-tree" data-assembly-id="'+c[a].FP_COMP.assemblyId+'">'+l.referenceId+"</a> ("+Math.round(100*l.score.toFixed(2))+'%)</div><div class="assembly-list-header-st">'+(0===c[a].MLST_RESULT.stType.length?"Not found":c[a].MLST_RESULT.stType)+'</div><div class="assembly-list-header-resistance-profile"><div class="assembly-resistance-profile-container">'+o+"</div></div></div>"),u.appendChild(r[0]),p+=1;m[0].appendChild(u.cloneNode(!0)),g[0].appendChild(u.cloneNode(!0)),$('.antibiotic[data-toggle="tooltip"]').tooltip()},y=function(e){var t=$(".wgst-navigation-item__"+e);return t.hasClass("wgst-navigation-item--active")?!0:!1},h=function(e){var t=$(".wgst-navigation-item__"+e);y(e)||t.addClass("wgst-navigation-item--active")},v=function(e){var t=$(".wgst-navigation-item__"+e);y(e)&&t.removeClass("wgst-navigation-item--active")},S=function(e){console.log("[WGST] Clearing "+e+" collection assembly list"),$(".wgst-panel__collection .collection-assembly-list").html("")},T=function(e,t){var a="collectionTree__"+e+"__"+t,s=$('.wgst-panel[data-panel-name="'+a+'"]');s.remove()},w=function(e){var t=WGST.collection[e].tree;$.each(t,function(t){T(e,t)})},_=function(e){"undefined"!=typeof WGST.collection[e]&&(console.log("[WGST] Closing collection "+e),S(e),r(["collection","collectionTree"]),w(e),window.history.replaceState("Object","WGST Collection",""),$(".wgst-collection-controls__show-tree .btn-group").html(""),v("collection"),delete WGST.collection[e])},G=function(e,t){WGST.collection[e]={assemblies:{},tree:{}},$.isArray(t)&&t.forEach(function(t){WGST.collection[e].tree[t]={}})},W=function(e){var t=WGST.collection[e].tree;$.each(t,function(t){"CORE_TREE_RESULT"===t&&k(e,t)})},k=function(e,t){{var a,s=WGST.collection[e].tree[t],o=s.name,l='<button type="button" class="btn btn-sm btn-default wgst-collection-control__show-tree" data-tree-type="{{collectionTreeType}}" data-collection-id="{{collectionId}}">{{collectionTreeName}}</button>',n=$(".wgst-collection-controls__show-tree .btn-group");$(".wgst-collection-controls__show-data-table .btn-group")}a=l.replace(/{{collectionTreeType}}/g,t),a=a.replace(/{{collectionId}}/g,e),a=a.replace(/{{collectionTreeName}}/g,o),n.append($(a))},A=function(e,t){var a=WGST.collection[e].tree;$.each(a,function(a){L(e,a,t)})},C=function(e,t,a){G(e),WGST.collection[e].assemblies=t,$.each(a,function(t,a){WGST.collection[e].tree[t]={type:t,data:a.data,name:a.name}})},E=function(e){if(console.log("[WGST] Getting collection "+e),WGST.speak){var t=new SpeechSynthesisUtterance("Loading collection");window.speechSynthesis.speak(t)}_(e);var n=$(".wgst-panel__collection");n.attr("data-panel-id","collection_"+e),n.attr("data-collection-id",e),n.find(".collection-details").attr("data-collection-id",e),n.find(".wgst-collection-control__show-tree").attr("collection-id",e),i("collection",function(){o("collection"),s("collection")}),$.ajax({type:"POST",url:"/collection/",datatype:"json",data:{collectionId:e}}).done(function(t){if(console.log("[WGST] Got collection "+e+" data"),console.dir(t),Object.keys(t).length>0){WGST.antibiotics=t.antibiotics,C(e,t.collection.assemblies,t.collection.tree),A(e),W(e),Ot(e);var s=WGST.collection[e].assemblies,o=[],n=[];$.each(WGST.collection[e].tree.CORE_TREE_RESULT.leavesOrder,function(e,t){o.push(s[t.id]),n.push(t.id)}),WGST.collection[e].sortedAssemblyIds=n,f(e,WGST.antibiotics),console.log("[WGST] Collection "+e+" has "+Object.keys(s).length+" assemblies");var i=Object.keys(s),r=i[i.length-1],c=s[r].FP_COMP.timestamp;$(".assembly-created-datetime").attr("title",moment(c,"YYYYMMDD_HHmmss").format("YYYY-MM-DD HH:mm:ss")),$(".timeago").timeago(),$(".wgst-stats__collection .wgst-stats-value__total-number-of-assemblies").html(o.length),$(".wgst-stats__collection .wgst-stats-value__number-of-displayed-assemblies").html(o.length),$(".wgst-stats__collection .wgst-stats-value__number-of-selected-assemblies").html("0"),$(".wgst-stats__collection .wgst-stats-value__created-on").html(moment(new Date).format("DD/MM/YYYY")),$(".wgst-stats__collection .wgst-stats-value__author").html("Anonymous"),$(".wgst-stats__collection .wgst-stats-value__privacy").html("Public"),l("collection"),a("collection"),Object.keys(WGST.collection[e].assemblies).length>100&&(console.log("[WGST] Collection "+e+" will be displayed fullscreen"),zt(e)),h("collection"),window.history.replaceState("Object","WGST Collection","/collection/"+e)}}).fail(function(e,t,a){console.log("[WGST][ERROR] Failed to get collection id"),console.error(t),console.error(a),console.error(e),g(t)})};"undefined"!=typeof WGST.requestedCollectionId&&E(WGST.requestedCollectionId),$(".tree-controls-show-labels").on("click",function(){var e=$(this).closest(".wgst-panel").attr("data-collection-id");WGST.collection[e].tree.CORE_TREE_RESULT.canvas.displayLabels()}),$(".tree-controls-hide-labels").on("click",function(){var e=$(this).closest(".wgst-panel").attr("data-collection-id");WGST.collection[e].tree.CORE_TREE_RESULT.canvas.hideLabels()});var x=function(e,t){for(var a,s,o,l,n={},i=WGST.collection[e].assemblies,r=0;r<t.length;r++)a=t[r],s=i[a].ASSEMBLY_METADATA.geography.position.latitude,o=i[a].ASSEMBLY_METADATA.geography.position.longitude,l=new google.maps.LatLng(s,o),"undefined"==typeof n[l.toString()]&&(n[l.toString()]=[]),n[l.toString()].push(a);return console.log("[WGST] Grouped assemblies by position:"),console.dir(n),n},I=function(e,t,a,s){var o="//chart.apis.google.com/chart?chst=d_map_pin_letter&chld="+s+"|00FFFF|000000",l=new google.maps.LatLng(t,a),n=l.toString();WGST.geo.map.markers.group[n]={assemblyIds:e,marker:{}},WGST.geo.map.markers.group[n].marker=new google.maps.Marker({position:new google.maps.LatLng(t,a),map:WGST.geo.map.canvas,icon:o,optimized:!0}),google.maps.event.addListener(WGST.geo.map.markers.group[n].marker,"click",function(){1===WGST.geo.map.markers.group[n].assemblyIds.length&&Bt(WGST.geo.map.markers.group[n].assemblyIds[0])})},O=function(){var e,t,a=WGST.geo.map.markers.group;for(e in a)t=a[e].marker,t.setMap(null),delete WGST.geo.map.markers.group[e];$(".show-all-assemblies-on-map").prop("checked",!1)},R=function(e,t){var a=new google.maps.LatLngBounds;if(O(),t.length>0){var s,o,l,n,i,r=x(e,t),c=WGST.collection[e].assemblies;for(s in r)o=r[s],l=o[0],n=c[l].ASSEMBLY_METADATA.geography.position.latitude,i=c[l].ASSEMBLY_METADATA.geography.position.longitude,I(o,n,i,o.length),a.extend(new google.maps.LatLng(n,i))}a.isEmpty()?(WGST.geo.map.canvas.setCenter(new google.maps.LatLng(48.6908333333,9.14055555556)),WGST.geo.map.canvas.setZoom(5)):(WGST.geo.map.canvas.panToBounds(a),WGST.geo.map.canvas.fitBounds(a))},P=function(e,t){var a=WGST.collection[e].assemblies;$('.collection-assembly-list .assembly-list-item [type="radio"]').prop("checked",!1),$.each(a,function(e){-1!==$.inArray(e,t)?($('.collection-assembly-list .assembly-list-item[data-assembly-id="'+e+'"]').addClass("row-selected"),$('.collection-assembly-list .assembly-list-item[data-assembly-id="'+e+'"] [type="checkbox"]').prop("checked",!0)):($('.collection-assembly-list .assembly-list-item[data-assembly-id="'+e+'"]').removeClass("row-selected"),$('.collection-assembly-list .assembly-list-item[data-assembly-id="'+e+'"] [type="checkbox"]').prop("checked",!1))}),R(e,t),1===t.length&&$('.collection-assembly-list .assembly-list-item[data-assembly-id="'+t+'"] [type="radio"]').prop("checked",!0)};$("body").on("change",".wgst-tree-control__change-node-label",function(){var e,t=$(this),a=t.closest(".wgst-panel").attr("data-collection-id"),s=t.closest(".wgst-panel").attr("data-collection-tree-type"),o=WGST.collection[a].tree[s].canvas,l=WGST.collection[a].assemblies;if("1"===t.val())for(e in l)l.hasOwnProperty(e)&&o.branches[e]&&o.branches[e].leaf&&(o.branches[e].label=l[e].ASSEMBLY_METADATA.userAssemblyId);else if("2"===t.val())for(e in l)l.hasOwnProperty(e)&&o.branches[e]&&o.branches[e].leaf&&(o.branches[e].label=WGST.collection[a].assemblies[e].FP_COMP.topScore.referenceId);else if("3"===t.val())for(e in l)l.hasOwnProperty(e)&&o.branches[e]&&o.branches[e].leaf&&(o.branches[e].label=0===l[e].MLST_RESULT.stType.length?"Not found":l[e].MLST_RESULT.stType);else if("4"===t.val()){var n,i;for(e in l)l.hasOwnProperty(e)&&(n=l[e].PAARSNP_RESULT.paarResult.resistanceProfile,i=u(n,WGST.antibiotics),o.branches[e]&&o.branches[e].leaf&&(o.branches[e].label=i))}else if("5"===t.val())for(e in l)l.hasOwnProperty(e)&&o.branches[e]&&o.branches[e].leaf&&(o.branches[e].label=l[e].ASSEMBLY_METADATA.geography.address);o.draw()}),$("body").on("change",".wgst-tree-control__change-node-colour",function(){var e,t=$(this).find("option:selected"),a=t.closest(".wgst-panel").attr("data-collection-id"),s=t.closest(".wgst-panel").attr("data-collection-tree-type"),o=WGST.collection[a].tree[s].canvas,l=WGST.collection[a].assemblies;if("0"===t.val())for(e in l)l.hasOwnProperty(e)&&o.setNodeColourAndShape(e,"#ffffff");else{var n,i;for(e in l)l.hasOwnProperty(e)&&(n=l[e].PAARSNP_RESULT.paarResult.ungroupedResistanceProfile,i=n[t.text()],"undefined"!=typeof i?o.branches[e]&&o.branches[e].leaf&&("RESISTANT"===i.resistanceState?o.setNodeColourAndShape(e,"#ff0000"):"SENSITIVE"===i.resistanceState?o.setNodeColourAndShape(e,"#4dbd33"):"UNKNOWN"===i.resistanceState&&o.setNodeColourAndShape(e,"#ffffff")):o.branches[e]&&o.branches[e].leaf&&o.setNodeColourAndShape(e,"#ffffff"))}}),$("body").on("change",".wgst-tree-control__change-tree-type",function(){var e,t=$(this).find("option:selected"),a=t.closest(".wgst-panel").attr("data-collection-id"),s=t.closest(".wgst-panel").attr("data-collection-tree-type");e=WGST.collection[a].tree[s].canvas,e.setTreeType(t.val())});var L=function(e,t,a){console.log("[WGST] Rendering "+e+" collection "+t+" tree");var s,o,n="collectionTree__"+e+"__"+t,r=$('.wgst-template[data-template-id="collectionTreePanel"]').html(),c=Handlebars.compile(r),d=WGST.collection[e].tree[t].name,p={attributePanelId:n,attributeCollectionId:e,attributeCollectionTreeType:t,collectionTreeTitle:d};"undefined"!=typeof a&&$.extend(p,a),s=c(p),$("body").prepend(s),o=$('.wgst-panel[data-panel-name="'+n+'"]'),WGST.panels[n]=WGST.panels.collectionTree,i(n),o.draggable({handle:o.find(".wgst-draggable-handle"),appendTo:"body",scroll:!1,stop:function(e,t){var a=t.helper.attr("data-panel-name");WGST.panels[a].top=t.position.top,WGST.panels[a].left=t.position.left}});var m="phylocanvas_"+e+"_"+t;o.find(".wgst-tree-content").attr("id",m),o.find(".wgst-tree-content").attr("data-collection-tree-type",t),l(n);var g,u=WGST.collection[e].tree[t],b=WGST.collection[e].assemblies;u.canvas=new PhyloCanvas.Tree(document.getElementById(m),{history_collapsed:!0}),u.canvas.parseNwk(u.data),u.canvas.treeType="rectangular";var f=u.canvas;f.on("selected",function(t){var a=t.nodeIds;"string"==typeof a&&(a=[a]),P(e,a)});for(g in b)b.hasOwnProperty(g)&&f.branches[g].leaf&&(f.branches[g].label=b[g].ASSEMBLY_METADATA.userAssemblyId);f.resizeToContainer(),f.drawn=!1,f.draw();var y=f.leaves;y.sort(function(e,t){return e.centery-t.centery}),u.leavesOrder=y;var h=u.data;for(g in b)b.hasOwnProperty(g)&&(h=h.replace(g,b[g].ASSEMBLY_METADATA.userAssemblyId));console.debug("» [WGST][DEV] Parsed Newick String:"),console.log("» Uncomment to see."),WGST.collection[e].tree[t].newickStringWithLabels=h,Rt(o.find(".wgst-tree-control__change-node-colour")),f.resizeToContainer(),f.drawn=!1,f.draw()},M=function(e){var t=WGST.collection[e].tree.CORE_TREE_RESULT.canvas;t.selectNodes("")};$(".tree-controls-select-none").on("click",function(){var e=$(this).closest(".wgst-panel").attr("data-collection-id");M(e)}),$(".tree-controls-select-all").on("click",function(){for(var e,t=$(this).closest(".wgst-panel").attr("data-collection-id"),a=WGST.collection[t].tree.CORE_TREE_RESULT.canvas,s=a.leaves,o=s.length,l=[];0!==o;)o-=1,e=s[o].id,l.push(e);a.root.setSelected(!0,!0),a.draw(),D(t,l)});var N,D=function(e,t){WGST.collection[e].geo=WGST.collection[e].geo||{};for(var a=(WGST.collection[e].tree.canvas,WGST.collection[e].geo.markers),s=a.length;0!==s;)s-=1,a[s].setMap(null);if(WGST.collection[e].geo.markers=[],WGST.geo.map.markerBounds=new google.maps.LatLngBounds,t.length>0){for(var o=t.length,l="",n={},i={},r={};0!==o;)if(o-=1,l=t[o],n=WGST.collection[e].assemblies[l].ASSEMBLY_METADATA,i=n.geography.position.latitude,r=n.geography.position.longitude,i&&r){console.log("[WGST] Marker's latitude: "+i),console.log("[WGST] Marker's longitude: "+r);var c=new google.maps.Marker({position:new google.maps.LatLng(i,r),map:WGST.geo.map.canvas,icon:"http://maps.google.com/mapfiles/ms/icons/blue-dot.png",optimized:!0});WGST.collection[e].assemblies[l].geo=WGST.collection[e].assemblies[l].geo||{},WGST.collection[e].assemblies[l].geo.marker=c,WGST.collection[e].geo.markers.push(t),WGST.geo.map.markerBounds.extend(c.getPosition())}}else WGST.geo.map.canvas.panTo(new google.maps.LatLng(48.6908333333,9.14055555556)),WGST.geo.map.canvas.setZoom(5)},U=!1,F=!1;!function(){$('[data-wgst-js="ring"]').draggable({appendTo:"body",scroll:!1,containment:"window"}),$(".wgst-ring-content").on("mouseover",function(){U===!1&&(N=setTimeout(function(){"undefined"!=typeof N&&U===!1&&(N=void 0,$(".wgst-panel--visible").fadeOut())},300))}),$(".wgst-ring-content").on("mouseout",function(){U===!1&&F===!1&&(N=void 0,$(".wgst-panel--visible").fadeIn())}),$('[data-wgst-js="ring"]').on("mousedown",function(){console.log("mouse down"),N=void 0,U=!0,F===!1&&$(".wgst-ring-content").css("background-color","#999")}),$('[data-wgst-js="ring"]').on("mouseup",function(){console.log("mouse up"),N=void 0,U=!1,F===!1&&$(".wgst-ring-content").css("background-color","")}),$(".wgst-ring-content").on("click",function(){console.log("ring click"),F===!1?(F=!0,$(this).addClass("wgst-ring-fixed"),$(".wgst-panel--visible").fadeOut()):(F=!1,$(this).removeClass("wgst-ring-fixed"))}),$(".wgst-ring-content").on("mousedown",function(e){console.log("mouse down"),e.stopPropagation()})}();var B=function(e,t){for(var a,s=t,o='<option value="{{year}}">{{year}}</option>',l="";s!==e-1;)a=o.replace(/{{year}}/g,s),l+=a,s-=1;return l},j=function(){for(var e,t=0,a=["January","February","March","April","May","June","July","August","September","October","November","December"],s='<option value="{{monthCounter}}">{{month}}</option>',o="";t<a.length;)e=s.replace(/{{month}}/g,a[t]),e=e.replace(/{{monthCounter}}/g,t),o+=e,t+=1;return o},z=function(e,t){if("undefined"==typeof e||"undefined"==typeof t)return"";for(var a,s=Y(e,t),o=0,l='<option value="{{day}}">{{day}}</option>',n="";s>o;)o+=1,a=l.replace(/{{day}}/g,o),n+=a;return n},Y=function(e,t){return 32-new Date(e,t,32).getDate()},q=function(e,t,a){e.html("").append($('<option value="-1">Choose day</option>')).append(z(t,a))};$(".assembly-metadata-list-container").on("change",".assembly-timestamp-input",function(){var e=$(this),t=e.attr("data-file-id"),a=e.attr("data-file-name"),s=$('.assembly-timestamp-input-year[data-file-name="'+a+'"]').val(),o=$('.assembly-timestamp-input-month[data-file-name="'+a+'"]').val(),l=$('.assembly-timestamp-input-day[data-file-name="'+a+'"]'),n=l.val(),i=e.attr("data-timestamp-input");("year"===i||"month"===i)&&"-1"!==s&&"-1"!==o&&(q(l,s,o),"-1"!==n&&l.find('option:contains("'+n+'")').prop("selected",!0)),"year"===i?$('.assembly-metadata-timestamp-month[data-file-id="'+t+'"]').removeClass("hide-this"):"month"===i&&$('.assembly-metadata-timestamp-day[data-file-id="'+t+'"]').removeClass("hide-this");var r;"-1"!==s&&(r="-1"!==o?"-1"!==n?new Date(s,o,n):new Date(s,o):new Date(s),WGST.upload.assembly[a].metadata=WGST.upload.assembly[a].metadata||{},WGST.upload.assembly[a].metadata.datetime=r),"-1"!==s&&(e.closest(".assembly-metadata-block").next(".assembly-metadata-block").fadeIn(),e.closest(".assembly-metadata-block").animate({scrollTop:e.closest(".assembly-metadata-block").height()},400),Ct())});var V={},H="",K=document.getElementsByTagName("body")[0],Z=[],Q=0,J=function(e){var t=[];return t=e.trim().split(">").filter(function(e){return e.length>0})},X=function(e){var t=[];return t=e.split(/\n/).filter(function(e){return e.length>0}),t.map(function(e){return e.trim()}),t},et=function(e){var t=X(e),a=t[0].trim().replace(">","");return a};WGST.regex=WGST.regex||{},WGST.regex.DNA_SEQUENCE=/^[CTAGNUX]+$/i;var tt=function(e){var t=X(e),a=t.splice(1,t.length);WGST.regex.DNA_SEQUENCE.test(a[0].trim())||(a=a.splice(1,a.length));var s=a.join("").replace(/\s/g,"");return s},at=function(e){var t,a=[];return e.forEach(function(e){t=tt(e),a.push(t)}),a},st=function(e){return WGST.regex.DNA_SEQUENCE.test(e)},ot=function(e){var t=X(e),a=tt(e);return t.length>1&&st(a)},lt=function(e){for(var t=e.sort(function(e,t){return t.length-e.length}),a=[],s=0;s<t.length;s++)a.length>0?a.push(t[s].length+a[a.length-1]):a.push(t[s].length);for(var o=Math.floor(a[a.length-1]/2),l=0,n={},s=0;s<t.length;s++)if(l+=t[s].length,l>=o){n.sequenceNumber=s+1,n.sum=l,n.sequenceLength=t[s].length;break}return n},nt=function(e){var t=0;return e.forEach(function(e){t+=e.length}),t},it=function(e){var t=nt(e),a=e.length,s=Math.floor(t/a);return s},rt=function(e){var t=e.map(function(e){return e.length}),a=t.reduce(function(e,t){return Math.min(e,t)});return a},ct=function(e){var t=e.map(function(e){return e.length}),a=t.reduce(function(e,t){return Math.max(e,t)});return a},dt=function(e){var t=e.sort(function(e,t){return t.length-e.length}),a=[];return t.forEach(function(e){0===a.length?a.push(e.length):a.push(e.length+a[a.length-1])}),a},pt=function(e){var t={valid:[],invalid:[]};return e.forEach(function(e){var a=(X(e),tt(e)),s=et(e);ot(e)?t.valid.push({id:s,dnaString:a}):t.invalid.push({id:s,dnaString:a})}),t},mt=function(e,t,a,s,o,l){var n=$();WGST.upload.assembly[a.name]={metadata:{}};var i=e.target.result,r=J(i);pt(r),t+=1,Z[t]={name:a.name,id:"",contigs:{total:r.length,invalid:0,individual:[]}},V[a.name]={name:a.name,assembly:e.target.result,metadata:{}};var c=at(r),d=lt(c),c=at(r),p=nt(c),m=it(c),g=rt(c),u=ct(c);console.log("[WGST] * dev * dnaStrings:"),console.dir(c),console.log("[WGST] * dev * totalNumberOfNucleotidesInDnaStrings: "+p),console.log("[WGST] * dev * averageNumberOfNucleotidesInDnaStrings: "+m),console.log("[WGST] * dev * smallestNumberOfNucleotidesInDnaStrings: "+g),console.log("[WGST] * dev * biggestNumberOfNucleotidesInDnaStrings: "+u),Q+=r.length,$(".assembly-sequences-average").text(Math.floor(Q/s.length)),n=$('<li class="assembly-item wgst-upload-assembly__analytics hide-this" data-name="'+Z[t].name+'" data-file-id="'+t+'" data-file-uid="'+l+'" id="assembly-item-'+t+'"><div class="assembly-overview"><div class="assembly-stats-container"><div class="assembly-stats-label">total nt</div><div class="assembly-stats-number">'+p.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+'</div></div><div class="assembly-stats-container"><div class="assembly-stats-label">total contigs</div><div class="assembly-stats-number assembly-stats-number-contigs">'+r.length.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+'</div></div><div class="assembly-stats-container"><div class="assembly-stats-label">min contig</div><div class="assembly-stats-number">'+g.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+'<small>nt</small></div></div><div class="assembly-stats-container"><div class="assembly-stats-label">mean contig</div><div class="assembly-stats-number">'+m.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+'<small>nt</small></div></div><div class="assembly-stats-container"><div class="assembly-stats-label">max contig</div><div class="assembly-stats-number">'+u.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+'<small>nt</small></div></div><div class="assembly-stats-container"><div class="assembly-stats-label">contig N50</div><div class="assembly-stats-number assembly-stats-n50-number">'+d.sequenceLength.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+'<small>nt</small></div></div></div><div class="assembly-content-data"><div class="sequence-length-distribution-chart-'+t+'"></div></div></li>');var b=$('<div class="assembly-metadata"></div>'),f=$("<h4>Please provide mandatory assembly metadata:</h4>"),y=$("<div></div>"),h='<div class="form-block assembly-metadata-{{fileCounter}} assembly-metadata-block"><div class="form-group form-horizontal"><label for="assemblyTimestampInput{{fileCounter}}">When this assembly was sampled?</label><div class="assembly-metadata-timestamp-block assembly-metadata-timestamp-year" data-file-id="{{fileCounter}}"><select name="select" class="form-control assembly-timestamp-input assembly-timestamp-input-year" data-timestamp-input="year" data-file-id="{{fileCounter}}" data-file-name="'+a.name+'" id="assemblyTimestampInput{{fileCounter}}"><option value="-1">Choose year</option>{{listOfYears}}</select></div><div class="assembly-metadata-timestamp-block assembly-metadata-timestamp-month hide-this" data-file-id="{{fileCounter}}"><select name="select" class="form-control assembly-timestamp-input assembly-timestamp-input-month" data-timestamp-input="month" data-file-id="{{fileCounter}}" data-file-name="'+a.name+'"><option value="-1">Choose month</option>{{listOfMonths}}</select></div><div class="assembly-metadata-timestamp-block assembly-metadata-timestamp-day hide-this" data-file-id="{{fileCounter}}"><select name="select" class="form-control assembly-timestamp-input assembly-timestamp-input-day" data-timestamp-input="day" data-file-id="{{fileCounter}}" data-file-name="'+a.name+'"><option value="-1">Choose day</option>{{listOfDays}}</select></div></div></div>',v='<div class="form-block assembly-metadata-{{fileCounter}} assembly-metadata-block hide-this"><div class="form-group"><label for="assemblySampleLocationInput{{fileCounter}}">Where this assembly was sampled?</label><input type="text" class="form-control assembly-sample-location-input" id="assemblySampleLocationInput{{fileCounter}}" placeholder="E.g.: London, United Kingdom"></div></div>',S='<div class="form-block assembly-metadata-{{fileCounter}} assembly-metadata-block hide-this"><div class="form-group"><label for="assemblySampleSourceInput{{fileCounter}}">What is the source of this sample?</label><select name="select" class="form-control assembly-sample-source-input" id="assemblySampleSourceInput{{fileCounter}}"><option value="0" selected>Choose source</option><option value="1">Human</option><option value="2">Livestock</option><option value="3">Biosphere</option><option value="4">Environment</option></select></div></div>',T='<div class="form-block assembly-metadata-{{fileCounter}} hide-this"><div class="btn-group"><button type="button" class="btn btn-default wgst-dropped-assembly-list-navigation-button__previous"><i class="fa fa-chevron-left"></i></button><button type="button" class="btn btn-default wgst-dropped-assembly-list-navigation-button__next"><i class="fa fa-chevron-right"></i></button></div> <button class="btn btn-default copy-metadata-to-all-empty-assemblies">Copy to all empty metadata</button></div>',w='<div class="form-block assembly-metadata-{{fileCounter}} hide-this">Ready? Click "Upload" button to upload your assemblies and metadata.</div>';
h=h.replace(/{{listOfYears}}/g,B(1940,2014)),h=h.replace(/{{listOfMonths}}/g,j()),h=h.replace(/{{listOfDays}}/g,z()),h=h.replace(/{{fileCounter}}/g,t),v=v.replace(/{{fileCounter}}/g,t),S=S.replace(/{{fileCounter}}/g,t),T=T.replace(/{{fileCounter}}/g,t),w=w.replace(/{{fileCounter}}/g,t);{var _=$(h),G=$(v),W=$(S),k=$(T);$(w)}y.append(_),y.append(G),y.append(W),t<s.length&&y.append(k),b.append(f),b.append(y);var A=$('<li class="assembly-item wgst-upload-assembly__metadata hide-this" data-name="'+Z[t].name+'" data-file-id="'+t+'" data-file-uid="'+l+'" id="assembly-metadata-item-'+t+'"></li>');A.append(b),$(".assembly-metadata-list-container ul").append(A),$(".assembly-list-container ul").append(n);var C=dt(c);console.log("[WGST] * dev * assemblyN50:"),console.dir(d),gt(C,d,t),H=$(".assembly-item").eq("0").attr("data-name"),function(e){var t=$('.assembly-metadata-list-container li[data-name="'+e+'"] .assembly-sample-location-input');WGST.geo.placeSearchBox[e]=new google.maps.places.SearchBox(t[0],{bounds:WGST.geo.map.searchBoxBounds}),google.maps.event.addListener(WGST.geo.placeSearchBox[e],"places_changed",function(){var t=WGST.geo.placeSearchBox[e].getPlaces(),a=t[0];if("undefined"==typeof a||"undefined"==typeof a.geometry)return console.dir(WGST.geo.placeSearchBox[e]),void 0;var s=a.geometry.location.lat(),o=a.geometry.location.lng(),l=a.formatted_address;console.log("[WGST] Google Places API first SearchBox place:"),console.log(l);var n=$('.wgst-panel__assembly-upload-metadata .assembly-item[data-name="'+e+'"]').find(".assembly-sample-location-input");n.val().length>0&&(n.closest(".form-block").next(".form-block").fadeIn(),n.closest(".assembly-metadata").animate({scrollTop:n.closest(".assembly-metadata").height()},400)),Ct(),n.blur().val(l),WGST.geo.map.canvas.setCenter(a.geometry.location),WGST.geo.map.markers.metadata.setMap(WGST.geo.map.canvas),WGST.geo.map.markers.metadata.setPosition(a.geometry.location),WGST.geo.map.markers.metadata.setVisible(!0),WGST.upload.assembly[e]=WGST.upload.assembly[e]||{},WGST.upload.assembly[e].metadata=WGST.upload.assembly[e].metadata||{},WGST.upload.assembly[e].metadata.geography={address:l,position:{latitude:s,longitude:o},type:a.types[0]}}),$('li.assembly-item[data-name="'+e+'"] .assembly-sample-source-input').on("change",function(){WGST.upload.assembly[e].metadata=WGST.upload.assembly[e].metadata||{},WGST.upload.assembly[e].metadata.source=$(this).val()}),vt+=1,console.log("numberOfDroppedFastaFiles: "+ht),console.log("numberOfParsedFastaFiles: "+vt),ht===vt&&yt()}(a.name)},gt=function(e,t,a){var s=460,o=312,l=(d3.extent(e,function(e){return e.sequenceLength}),d3.scale.linear().domain([0,e.length]).range([40,s-50])),n=d3.scale.linear().domain([e[e.length-1],0]).range([30,o-52]),i=d3.svg.axis().scale(l).orient("bottom").ticks(10),r=d3.svg.axis().scale(n).orient("left").ticks(10),c=d3.select(".sequence-length-distribution-chart-"+a).append("svg").attr("width",s).attr("height",o);c.append("g").attr("class","x axis").attr("transform","translate(20, 260)").call(i),c.append("g").attr("class","y axis").attr("transform","translate(60, 0)").call(r),c.select(".x.axis").append("text").text("Ordered contigs").attr("class","axis-label").attr("text-anchor","end").attr("x",s/2+49).attr("y",45),c.select(".y.axis").append("text").text("Nucleotides sum").attr("class","axis-label").attr("transform","rotate(-90)").attr("x",-(o/2)-44).attr("y",398),c.selectAll("circle").data(e).enter().append("circle").attr("cx",function(e,t){return l(t+1)+20}).attr("cy",function(e){return n(e)}).attr("r",5);var d=d3.svg.line().x(function(e,t){return l(t+1)+20}).y(function(e){return n(e)});c.append("path").attr("d",d(e));{var p=[{x:l(0)+20,y:n(0)},{x:l(1)+20,y:n(e[0])}],m=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate("linear"),g=(c.append("path").attr("d",m(p)),c.selectAll(".n50-circle").data([t]).enter().append("g").attr("class","n50-group"));g.append("circle").attr("cx",function(e){return l(e.sequenceNumber)+20}).attr("cy",function(e){return n(e.sum)}).attr("r",6)}g.append("text").attr("dx",function(e){return l(e.sequenceNumber)+20+9}).attr("dy",function(e){return n(e.sum)+5}).attr("text-anchor","right").text("N50");var u=[{x:54,y:n(t.sum)},{x:l(t.sequenceNumber)+20,y:n(t.sum)},{x:l(t.sequenceNumber)+20,y:o-46}],b=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate("linear");g.append("path").attr("d",b(u))},ut=/csv/,bt=function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},ft=function(){},yt=function(){n("assemblyUploadNavigator")||(i("assemblyUploadNavigator"),s("assemblyUploadNavigator")),n("assemblyUploadAnalytics")||(i("assemblyUploadAnalytics"),s("assemblyUploadAnalytics")),n("assemblyUploadMetadata")||(i("assemblyUploadMetadata"),s("assemblyUploadMetadata"))},ht=0,vt=0,St=function(e){if(e.dataTransfer.files.length>0){e.stopPropagation(),e.preventDefault();var t="";if(n("collection")?(t=$(".wgst-panel__collection").attr("data-collection-id"),$(".wgst-panel__assembly-upload-navigator").attr("data-collection-id",t),r("collection"),S(t)):Pt("collection")&&(t=$(".wgst-fullscreen__collection .wgst-collection").attr("data-collection-id"),$(".wgst-panel__assembly-upload-navigator").attr("data-collection-id",t),S(t),Vt("map","map")),$(".assembly-upload-panel").trigger("mousedown"),WGST.speak){var a,s="";s=t.length>0?"You have dropped "+e.dataTransfer.files.length+" files to the existing collection.":"You have dropped "+e.dataTransfer.files.length+" files",a=new SpeechSynthesisUtterance(s),window.speechSynthesis.speak(a)}var o=e.dataTransfer.files;WGST.dragAndDrop.files=$.merge(WGST.dragAndDrop.files,o),WGST.dragAndDrop.loadedFiles=[];{var l=WGST.dragAndDrop.files,i=l[0],c=i.name;new FileReader}1===l.length?($(".upload-multiple-assemblies-label").hide(),$(".upload-single-assembly-file-name").text(c),$(".upload-single-assembly-label").show()):($(".upload-single-assembly-label").hide(),$(".upload-multiple-assemblies-label").show()),$(".total-number-of-dropped-assemblies").text(l.length),$(".assembly-list-slider").slider("option","max",l.length-1),$(".assembly-file-name").text(c),l.length>1&&($(".assembly-navigator").show(),$(".ui-slider-handle").focus()),ht=Object.keys(l).length,$.each(l,function(e,a){if(a.type.match(ut))console.log("Dropped CSV file"),console.dir(a),ft(a);else if(a.name.match(WGST.dragAndDrop.fastaFileNameRegex)){if(console.log("Dropped FASTA file"),0===$('.wgst-panel__assembly-upload-analytics .assembly-item[data-name="'+a.name+'"]').length){var s=new FileReader;s.addEventListener("load",function(s){console.log("[WGST] Loaded file "+s.target.name),WGST.dragAndDrop.loadedFiles.push({uid:uuid.v4(),event:s,fileCounter:e,file:a,droppedFiles:o,collectionId:t}),WGST.dragAndDrop.loadedFiles.length===WGST.dragAndDrop.files.length&&(WGST.dragAndDrop.loadedFiles.sort(function(e,t){return e.file.name>t.file.name?1:e.file.name<t.file.name?-1:0}),WGST.dragAndDrop.loadedFiles.forEach(function(e){mt(e.event,e.fileCounter,e.file,e.droppedFiles,e.collectionId,e.uid),$(".wgst-dropped-assembly-list").append('<option value="'+e.uid+'">'+e.file.name+"</option>")}),window.WGST.exports.showDroppedAssembly(WGST.dragAndDrop.loadedFiles[0].uid))}),s.readAsText(a)}}else React.renderComponent(WorkflowQuestion({title:"What type of data have you dropped?",buttons:[{label:"Assemblies in FASTA format",value:"fasta"},{label:"Metadata in CSV format",value:"csv"}]}),document.querySelectorAll(".wgst-react-component__workflow-question")[0])}),$(".assembly-upload-total-number").text(l.length),$(".assembly-upload-total-number-label").html(1===l.length?"assembly":"assemblies")}};K.addEventListener("dragover",bt,!1),K.addEventListener("drop",St,!1);var Tt=function(e){1===e?($(".nav-prev-item").attr("disabled","disabled"),$(".nav-next-item").removeAttr("disabled","disabled")):e===parseInt($(".total-number-of-dropped-assemblies").text())?($(".nav-next-item").attr("disabled","disabled"),$(".nav-prev-item").removeAttr("disabled","disabled")):($(".nav-next-item").removeAttr("disabled","disabled"),$(".nav-prev-item").removeAttr("disabled","disabled"))},wt=function(){var e=$(".wgst-panel__assembly-upload-navigator");e.find(".assembly-sequences-average").text("0"),e.find(".assembly-upload-total-number").text("0")},$t=function(){var e=$(".wgst-panel__assembly-upload-progress");e.find(".assemblies-upload-progress .progress-bar").attr("class","progress-bar").attr("aria-valuenow","0"),e.find(".assemblies-upload-progress .progress-bar").attr("style","width: 0%"),e.find(".assemblies-upload-progress .progress-bar").html(""),e.find(".assemblies-upload-progress .assemblies-upload-processed").html("0"),e.find(".assembly-list-upload-progress tbody").html("")},_t=function(){var e=$(".wgst-panel__assembly-upload-metadata");e.find(".assembly-metadata-list-container ul").html(""),e.find(".adding-metadata-progress-container .progress-container").show(),e.find(".adding-metadata-progress-container .upload-controls-container").hide(),e.find(".adding-metadata-progress-container .progress-bar").width("0%"),e.find(".adding-metadata-progress-container .progress-bar").attr("aria-valuenow",0),e.find(".adding-metadata-progress-container .progress-percentage").text("0%")},Gt=function(){var e=$(".wgst-panel__assembly-upload-analytics");e.find(".assembly-list-container ul").html("")},Wt=function(){V={},ht=0,vt=0,wt(),Gt(),_t()},kt=function(){var e=0;$.each($(".assembly-item"),function(t,a){e+=parseInt($(a).find(".assembly-stats-number-contigs").text(),10)}),$(".assembly-sequences-average").text(Math.floor(e/Object.keys(V).length)),$(".assembly-upload-total-number").text(Object.keys(V).length)},At=function(e){$(".selected-assembly-counter").text(e);var t=$(".assembly-item").eq(e-1).attr("data-name");$(".wgst-panel__assembly-upload-navigator .assembly-file-name").text(t),$(".wgst-panel__assembly-upload-metadata .header-title small").text(t),$(".wgst-panel__assembly-upload-analytics .header-title small").text(t),Tt(e)};$(".nav-prev-item").on("click",function(){var e=$(".assembly-list-slider"),t=e.slider("value");console.log("@@@ currentSliderValue: "+t),t>0&&e.slider("value",t-1)}),$(".nav-next-item").on("click",function(){var e=$(".assembly-list-slider"),t=e.slider("value");console.log("@@@ currentSliderValue: "+t),t<WGST.dragAndDrop.loadedFiles.length&&e.slider("value",t+1)}),$(".assembly-metadata-list-container").on("click",".not-sure-checkbox",function(){$(this).closest("label").find(".not-sure-hint").toggleClass("hide-this")});var Ct=function(){var e=+$(".assembly-timestamp-input-year").length+$(".assembly-sample-location-input").length+$(".assembly-sample-source-input").length,t=+$(".assembly-timestamp-input-year").filter(function(){return"-1"!==this.value}).length+$(".assembly-sample-location-input").filter(function(){return 0!==this.value.length}).length+$(".assembly-sample-source-input").filter(function(){return"0"!==this.value}).length,a=Math.floor(100*t/e);if($(".adding-metadata-progress-container .progress-bar").width(a+"%"),$(".adding-metadata-progress-container .progress-bar").attr("aria-valuenow",a),$(".adding-metadata-progress-container .progress-percentage").text(a+"%"),100===a&&($(".adding-metadata-progress-container .progress-container").hide(),$(".adding-metadata-progress-container .upload-controls-container").show(),WGST.speak)){var s=new SpeechSynthesisUtterance("Ready to upload");window.speechSynthesis.speak(s)}};$(".assembly-metadata-list-container").on("change",".assembly-sample-source-input",function(){0!==$(this).val()&&($(this).closest(".form-block").next(".form-block").fadeIn(),$(this).closest(".assembly-metadata").animate({scrollTop:$(this).closest(".assembly-metadata").height()},400)),Ct(),$(".adding-metadata-progress-container .progress-hint").fadeOut()}),$(".assembly-metadata-list-container").on("click",".assembly-metadata button.next-assembly-button",function(e){$(".nav-next-item").trigger("click");$(this).closest(".assembly-item").attr("id").replace("assembly-metadata-item-","");$(this).closest(".assembly-metadata-list-container").find('.assembly-metadata-block input:text[value=""]').focus(),e.preventDefault()});var Et=function(e){var t,a=[];for(t in e)e.hasOwnProperty(t)&&a.push({referenceId:e[t].referenceId,score:e[t].score});return a=a.sort(function(e,t){return t.score-e.score}),a[0]},xt=function(e,t,a,s){var o=$('.assembly-list-upload-progress tr[data-assembly-id="'+t+'"] '),l=o.find(".progress-bar"),n='<span class="glyphicon glyphicon-ok"></span>',i=parseFloat(o.find(".progress-bar").attr("aria-valuenow")),r=100/a,c=i+r;if(s===WGST.assembly.analysis.UPLOAD_OK?o.find(".assembly-upload-uploaded").html(n):s===WGST.assembly.analysis.MLST_RESULT?o.find(".assembly-upload-result-mlst").html(n):s===WGST.assembly.analysis.PAARSNP_RESULT?o.find(".assembly-upload-result-paarsnp").html(n):s===WGST.assembly.analysis.FP_COMP?o.find(".assembly-upload-result-fp-comp").html(n):s===WGST.assembly.analysis.CORE&&o.find(".assembly-upload-result-core").html(n),l.css("width",c+"%").attr("aria-valuenow",c),c>0&&l.text(Math.round(c)+"%"),c>=100){Lt-=1,o.find(".progress").removeClass("active").removeClass("progress-striped"),l.removeClass("progress-bar-info").addClass("progress-bar-success");var d=o.find(".assembly-upload-name").text();o.find(".assembly-upload-name").html('<a href="#" class="open-assembly-button" data-assembly-id="'+e+'">'+d+"</a>");var p=$(".assemblies-upload-processed");p.text(parseInt(p.text(),10)+1)}},It=function(e,t,a,s){var o=$(".assemblies-upload-progress").find(".progress-bar"),l=parseFloat(o.attr("aria-valuenow")),n=100/s,i=l+n;if(o.css("width",i+"%").attr("aria-valuenow",i),i>0&&o.text(Math.round(i)+"%"),i>=100&&o.addClass("progress-bar-success"),WGST.speak===!0&&i%30===0){var r=new SpeechSynthesisUtterance("Uploaded over "+i+" percent");window.speechSynthesis.speak(r)}},Ot=function(e){var t,a,s,o,l,n,i={};for(t in WGST.collection[e].assemblies){a=WGST.collection[e].assemblies[t],i=a.PAARSNP_RESULT.paarResult.resistanceProfile,l={};for(s in i){o=i[s];for(n in o)l[n]=o[n]}WGST.collection[e].assemblies[t].PAARSNP_RESULT.paarResult.ungroupedResistanceProfile=l,console.log("WGST.collection[collectionId].assemblies[assemblyId].PAARSNP_RESULT.paarResult.ungroupedResistanceProfile:"),console.dir(WGST.collection[e].assemblies[t].PAARSNP_RESULT.paarResult.ungroupedResistanceProfile)}},Rt=function(e){var t,a,s=[],o={};for(t in WGST.antibiotics)for(a in WGST.antibiotics[t])s.push(a),o[a]='<option value="'+a.replace(WGST.antibioticNameRegex,"_").toLowerCase()+'">'+a+"</option>";s.sort();var l=s.length;for(l=0;l<s.length;)a=s[l],e.append($(o[a])),l+=1};WGST.socket.connection.on("collectionTreeMergeNotification",function(e){if(console.log("[WGST] Received merged tree notification"),WGST.speak){var t=new SpeechSynthesisUtterance("Merged collections");window.speechSynthesis.speak(t)}var o=e.mergedCollectionTreeId,l=e.tree,n=e.assemblies,r=[];r=n.map(function(e){return e.assemblyId}),console.log("[WGST] Getting merged collection assemblies"),console.dir(r),$.ajax({type:"POST",url:"/api/assemblies/",datatype:"json",data:{assemblyIds:r}}).done(function(e){console.log("[WGST] Got merged collection assemblies"),console.dir(e),C(o,e,l),A(o,{matchAssemblyListButton:!0,mergeWithButton:!0});var t,n,r;for(t in WGST.collection[o].assemblies)WGST.collection[o].assemblies.hasOwnProperty(t)&&(n=WGST.collection[o].assemblies[t],r=n.FP_COMP.scores,WGST.collection[o].assemblies[t].FP_COMP.topScore=Et(r));Ot(o),Rt($("#select-tree-node-antibiotic-merged")),function(){var e=$(".wgst-tree-control__merge-collection-trees");e.find(".wgst-spinner").hide(),e.find(".wgst-spinner-label").show(),e.attr("disabled",!1)}(),$(".wgst-panel__collection .wgst-panel-control-button__close").trigger("click"),$(".wgst-panel__collection-tree .wgst-panel-control-button__close").trigger("click");var d="MERGED",p="collectionTree__"+o+"__"+d;i(p),s(p),a(p),c(p)}).fail(function(e,t,a){console.error("[WGST][Error] ✗ Failed to get assemblies"),console.error(t),console.error(a),console.error(e)})}),WGST.socket.connection.on("assemblyUploadNotification",function(e){var t=e.collectionId,a=e.assemblyId,s=e.userAssemblyId,o=e.result,l=t+"__"+a+"__"+o,n=Object.keys(V),i=Object.keys(WGST.assembly.analysis).length,c=i*n.length,d=Object.keys(WGST.collection.analysis).length,p=c+d;console.log("[WGST][Socket.io] Received assembly upload notification:"),console.log("[WGST][Socket.io] Assembly id: "+a),console.log("[WGST][Socket.io] Result: "+o),-1===Object.keys(WGST.upload.collection[t].notifications.all).indexOf(l)&&(WGST.upload.collection[t].notifications.all[l]="OK",console.debug("[WGST] » Received "+Object.keys(WGST.upload.collection[t].notifications.all).length+" out of "+p+" assembly results"),-1!==Object.keys(WGST.assembly.analysis).indexOf(o)&&xt(a,s,i,o),It(t,s,a,p,o),p===Object.keys(WGST.upload.collection[t].notifications.all).length&&(console.log("[WGST] ✔ Finished uploading and processing new collection "+t),setTimeout(function(){r("assemblyUploadProgress"),Wt(),E(t)},1e3)))});var Pt=function(e){var t=$('[data-fullscreen-name="'+e+'"]');return t.hasClass("wgst-fullscreen--active")?!0:!1};$('input[type="checkbox"].show-all-assemblies-on-map').on("change",function(){var e=$(this).closest(".collection-details").find('.collection-assembly-list .assembly-list-header-map input[type="checkbox"]');$(this).prop("checked")?e.prop("checked",!0).trigger("change"):e.prop("checked",!1).trigger("change")});$(".wgst-panel__collection .collection-assembly-list").on("change",'input[type="checkbox"]',function(){var e,t=($(this).attr("data-assembly-id"),$(this).closest(".wgst-collection").attr("data-collection-id")),a=$(this).closest(".collection-assembly-list").find('.show-on-map-checkbox [type="checkbox"]:checked'),s=[];a.each(function(){e=$(this).attr("data-assembly-id"),s.push(e)}),R(t,s),"map"!==$(".wgst-fullscreen--active").attr("data-fullscreen-name")&&($(".wgst-panel__map").hasClass("wgst-panel--active")||d("map")),0===$(this).closest(".collection-assembly-list").find('input[type="checkbox"]:not(:checked)').length?$('input[type="checkbox"].show-all-assemblies-on-map').prop("checked",!0):$('input[type="checkbox"].show-all-assemblies-on-map').prop("checked",!1)}),$(".collection-assembly-list").on("change",'input[type="radio"]',function(){var e=$(this).attr("data-assembly-id"),t=$(this).closest(".wgst-collection-info").attr("data-collection-id");$(".collection-assembly-list .assembly-list-item.row-selected").removeClass("row-selected"),$('.collection-assembly-list .assembly-list-item[data-assembly-id="'+e+'"]').addClass("row-selected"),WGST.collection[t].tree.canvas.selectNodes(e),i("collectionTree"),s("collectionTree"),a("collectionTree"),c("collectionTree")}),$(".assemblies-upload-cancel-button").on("click",function(){$(".assembly-upload-panel").hide(),V={},H="",$(".assembly-list-container ul").html(""),$(".assembly-metadata-list-container ul").html(""),$(".adding-metadata-progress-container .progress-bar").width("0%"),$(".adding-metadata-progress-container .progress-bar").attr("aria-valuenow",0),$(".adding-metadata-progress-container .progress-percentage").text("0%"),WGST.geo.map.markers.metadata.setMap(null)});var Lt=0,Mt=5,Nt=2e3,Dt=function(e){Mt>Lt?(console.log("[WGST] Uploading "+e.assemblyId+" assembly"),Lt+=1,e.socketRoomId=WGST.socket.roomId,console.log("About to upload assembly:"),console.dir(e),$.ajax({type:"POST",url:"/assembly/add/",datatype:"json",data:e}).done(function(){}).fail(function(e,t,a){console.log("[WGST][Error] Failed to send FASTA file object to server or received error message"),console.error(t),console.error(a),console.error(e),g(t)})):setTimeout(Dt,Nt,e)},Ut=2e3;$(".assemblies-upload-ready-button").on("click",function(){console.log("[WGST] Getting ready to upload assemblies and metadata"),_t(),$t(),WGST.geo.map.markers.metadata.setMap(null),r(["assemblyUploadNavigator","assemblyUploadAnalytics","assemblyUploadMetadata"]),WGST.dragAndDrop.files=[];var e,t,a;for(e in V)V.hasOwnProperty(e)&&(t='<tr data-assembly-id="{{userAssemblyId}}"><td class="assembly-upload-name">{{userAssemblyId}}</td><td class="assembly-upload-progress"><div class="progress progress-striped active"><div class="progress-bar progress-bar-info"  role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div></div></td><td class="assembly-upload-result assembly-upload-uploaded"><span class="glyphicon glyphicon-record"></span></td><td class="assembly-upload-result assembly-upload-result-mlst"><span class="glyphicon glyphicon-record"></span></td><td class="assembly-upload-result assembly-upload-result-fp-comp"><span class="glyphicon glyphicon-record"></span></td><td class="assembly-upload-result assembly-upload-result-paarsnp"><span class="glyphicon glyphicon-record"></span></td><td class="assembly-upload-result assembly-upload-result-core"><span class="glyphicon glyphicon-record"></span></td></tr>',a=t.replace(/{{userAssemblyId}}/g,e),$(".assembly-list-upload-progress tbody").append(a));var o=Object.keys(V).length;if($(".wgst-panel__assembly-upload-progress .header-title small").text(o),$(".wgst-panel__assembly-upload-progress .assemblies-upload-total").text(o),i("assemblyUploadProgress",function(){s("assemblyUploadProgress");var e=$(".wgst-panel__assembly-upload-navigator").attr("data-collection-id");console.log("[WGST] Getting collection id"),setTimeout(function(){$.ajax({type:"POST",url:"/collection/add/",datatype:"json",data:{collectionId:e,userAssemblyIds:Object.keys(V)}}).done(function(e){var t=e.collectionId,a=e.userAssemblyIdToAssemblyIdMap;WGST.upload.collection[t]={},WGST.upload.collection[t].notifications={assembly:{},all:{},tree:!1};var s=[];$.each(a,function(e){console.log("=============================================="),console.dir(a),console.log(e);var o=a[e];"undefined"!=typeof V[o]&&s.push([t,e,V[o]])}),s.sort(function(e,t){return e[2].name>t[2].name?1:e[2].name<t[2].name?-1:0}),V=s,V.forEach(function(e){{var t=e[0],a=e[1],s=e[2],o={},l=s.name;$('li[data-name="'+l+'"] .assembly-sample-location-input')}console.debug("userAssemblyId: "+l),console.dir(WGST.upload),console.debug("assemblyData: "),console.dir(s),o.collectionId=t,o.assemblyId=a,o.userAssemblyId=s.name,o.sequences=s.assembly,o.metadata={datetime:WGST.upload.assembly[l].metadata.datetime,geography:{position:{latitude:WGST.upload.assembly[l].metadata.geography.position.latitude,longitude:WGST.upload.assembly[l].metadata.geography.position.longitude},address:WGST.upload.assembly[l].metadata.geography.address},source:WGST.upload.assembly[l].metadata.source},Dt(o)})}).fail(function(e,t,a){console.log("[WGST][ERROR] Failed to get collection id"),console.error(t),console.error(a),console.error(e),g(t)})},Ut)}),WGST.speak){var l=new SpeechSynthesisUtterance("Uploading...");window.speechSynthesis.speak(l)}}),$(".cancel-assembly-upload-button").on("click",function(){$('.assembly-item[data-name="'+H+'"]').remove(),delete V[H],$(".assembly-list-slider").slider("option","max",WGST.dragAndDrop.droppedFiles.length),$(".total-number-of-dropped-assemblies").text(WGST.dragAndDrop.droppedFiles.length),At($(".assembly-list-slider").slider("value")),1===Object.keys(V).length?($(".assembly-upload-total-number-label").text("assembly"),$(".upload-single-assembly-file-name").text(V[Object.getOwnPropertyNames(V)[0]].name),$(".upload-multiple-assemblies-label").hide(),$(".upload-single-assembly-label").show(),$(".assembly-navigator").hide()):Tt($(".assembly-list-slider").slider("value")),kt(),Ct()}),$("body").on("mousedown",".wgst-panel",function(){c($(this).attr("data-panel-name"))}),$(".tree-panel .wgst-tree-controls button").on("click",function(){$(this).blur()});var Ft=function(e,t){if(e!==t){var a=$('.assembly-metadata-timestamp-year[data-file-id="'+e+'"]'),s=a.find("select option:selected").val(),o=$('.assembly-metadata-timestamp-month[data-file-id="'+e+'"]'),l=o.find("select option:selected").val(),n=$('.assembly-metadata-timestamp-day[data-file-id="'+e+'"]'),i=n.find("select option:selected").val(),r=$('.assembly-metadata-timestamp-year[data-file-id="'+t+'"]'),c=$('.assembly-metadata-timestamp-month[data-file-id="'+t+'"]'),d=$('.assembly-metadata-timestamp-day[data-file-id="'+t+'"]'),p=d.find("select");"-1"!==s&&r.find('option[value="'+s+'"]').prop("selected",!0),"-1"!==l&&c.find('option[value="'+l+'"]').prop("selected",!0),"-1"!==i&&(q(p,s,l),p.find('option[value="'+i+'"]').prop("selected",!0)),a.is(":visible")&&r.removeClass("hide-this"),o.is(":visible")&&c.removeClass("hide-this"),n.is(":visible")&&d.removeClass("hide-this")}};$(".wgst-panel__assembly-upload-metadata").on("click",".copy-metadata-to-all-empty-assemblies",function(){var e=$(this).closest(".assembly-metadata"),t=e.find(".assembly-sample-location-input"),a=e.find(".assembly-sample-source-input"),s={fileName:$(this).closest(".assembly-item").attr("data-name"),fileId:$(this).closest(".assembly-item").attr("data-file-id")};s.metadata=WGST.upload.assembly[s.fileName].metadata;var o,l,n=$(".wgst-panel__assembly-upload-metadata");$.each(WGST.upload.assembly,function(e,i){0===Object.keys(i.metadata).length&&(WGST.upload.assembly[e].metadata.datetime=s.metadata.datetime,WGST.upload.assembly[e].metadata.geography={address:"",position:{latitude:"",longitude:""},type:""},WGST.upload.assembly[e].metadata.geography.address=s.metadata.geography.address,WGST.upload.assembly[e].metadata.geography.position.latitude=s.metadata.geography.position.latitude,WGST.upload.assembly[e].metadata.geography.position.longitude=s.metadata.geography.position.longitude,WGST.upload.assembly[e].metadata.geography.type=s.metadata.geography.type,WGST.upload.assembly[e].metadata.source=s.metadata.source,o=n.find('.assembly-item[data-name="'+e+'"]'),l=o.attr("data-file-id"),n.find('.assembly-item[data-name="'+e+'"] .assembly-sample-location-input').val(t.val()),n.find('.assembly-item[data-name="'+e+'"] .assembly-sample-source-input').val(a.val()),Ft(s.fileId,l),$('.assembly-item[data-name="'+e+'"] .assembly-metadata .form-block').show())}),$(".assembly-metadata-block").show(),Ct()}),$(".wgst-panel__collection, .wgst-fullscreen__collection").on("click",".show-on-representative-tree",function(e){return!1}),$(".wgst-panel__collection, .wgst-panel__assembly-upload-progress, .wgst-fullscreen__collection").on("click",".open-assembly-button",function(e){var t=$(this).attr("data-assembly-id");n("assembly")&&(r("assembly"),$(".wgst-panel__assembly .assembly-details .assembly-detail-content").html("")),Bt(t),e.preventDefault()}),$(".wgst-panel__collection").on("click",".wgst-collection-control__show-tree",function(){var e=$(this).attr("data-collection-id"),t=$(this).attr("data-tree-type"),o="collectionTree__"+e+"__"+t;i(o),s(o),a(o),c(o)}),$(".wgst-panel__collection").on("click",".wgst-collection-control__show-data-table",function(){var e=$(this).attr("data-collection-id"),t=WGST.collection[e].assemblies,a=Object.keys(t);$.ajax({type:"POST",url:"/api/assembly/table-data",datatype:"json",data:{assemblyIds:a}}).done(function(e){console.log("[WGST] Got assembly table data"),console.dir(e)})});var Bt=function(e){i("assembly"),c("assembly"),o("assembly"),s("assembly"),$.ajax({type:"POST",url:"/api/assembly",datatype:"json",data:{assemblyId:e}}).done(function(t){console.log("[WGST] Received data for assembly id: "+e),console.dir(t);var a=t.assembly,s=$(".wgst-panel__assembly");s.find(".header-title small").text(a.ASSEMBLY_METADATA.userAssemblyId);var o=t.antibiotics,l=a.PAARSNP_RESULT.paarResult.resistanceProfile,n="",i="",r="";for(var c in o)if(o.hasOwnProperty(c)){i='<table class="antibiotic-group" data-antibiotic-group-name="{{antibioticGroupName}}"><thead><tr><th>{{antibioticGroupName}}</th></tr></thead><tbody><tr><td><table><tbody><tr>{{antibioticResistancesHtml}}</tr></tbody></table></td></tr></tbody></table>',p="",r="";for(var d in o[c])if(o[c].hasOwnProperty(d)){var p=p+"<td>"+d+"</td>";if("undefined"!=typeof l[c])if("undefined"!=typeof l[c][d]){console.log("antibioticName: "+d);var m=l[c][d].resistanceState;r="RESISTANT"===m?r+'<td><div class="antibiotic resistance-fail" data-antibiotic-name="'+d+'" data-antibiotic-resistance-state="'+m+'" data-toggle="tooltip" data-placement="top" title="'+d+'">'+d+"</div></td>":"SENSITIVE"===m?r+'<td><div class="antibiotic resistance-success" data-antibiotic-name="'+d+'" data-antibiotic-resistance-state="'+m+'" data-toggle="tooltip" data-placement="top" title="'+d+'">'+d+"</div></td>":r+'<td><div class="antibiotic resistance-unknown" data-antibiotic-name="'+d+'" data-antibiotic-resistance-state="'+m+'" data-toggle="tooltip" data-placement="top" title="'+d+'">'+d+"</div></td>"}else r=r+'<td><div class="antibiotic resistance-unknown" data-antibiotic-name="'+d+'" data-antibiotic-resistance-state="'+m+'" data-toggle="tooltip" data-placement="top" title="'+d+'">'+d+"</div></td>",console.log(">>> Assembly resistance profile has no antibiotic: "+d);else r=r+'<td><div class="antibiotic resistance-unknown" data-antibiotic-name="'+d+'" data-antibiotic-resistance-state="'+m+'" data-toggle="tooltip" data-placement="top" title="'+d+'">'+d+"</div></td>",console.log(">>> Assembly resistance profile has no antibiotic group: "+c)}i=i.replace(/{{antibioticGroupName}}/g,c),i=i.replace(/{{antibioticResistancesHtml}}/,r),n+=i}$(".wgst-panel__assembly .assembly-detail__resistance-profile .assembly-detail-content").html($(n)),0===a.MLST_RESULT.stType.length?$(".wgst-panel__assembly .assembly-detail__st-type .assembly-detail-content").html("Not found"):$(".wgst-panel__assembly .assembly-detail__st-type .assembly-detail-content").html(a.MLST_RESULT.stType);var g,u,b=a.MLST_RESULT.alleles,f='<table><tbody><tr><td class="row-title">Locus Id</td>{{locusIds}}</tr><tr><td class="row-title">Allele Id</td>{{alleleIds}}</tr></tbody></table>',y="",h="";console.debug("assemblyAlleles:"),console.dir(b);for(u in b)b.hasOwnProperty(u)&&(g=b[u],null===g?(y+="<td>None</td>",h=h+"<td>"+u+"</td>"):(y=y+"<td>"+b[u].locusId+"</td>",h=h+"<td>"+b[u].alleleId+"</td>"));f=f.replace("{{locusIds}}",y),f=f.replace("{{alleleIds}}",h),$(".wgst-panel__assembly .assembly-detail__mlst .assembly-detail-content").html($(f));var v=a.FP_COMP.scores,S=Et(v);$(".wgst-panel__assembly .assembly-detail__nearest-representative .assembly-detail-content").text(S.referenceId);for(var T,w="<table><thead><tr><th>Reference Id</th><th>Score</th></tr></thead><tbody>{{assemblyScoresDataHtml}}</tbody></table>",_="",G=Object.keys(v).sort(function(e,t){return v[e]-v[t]}),W=G.length;0!==W;){W-=1;var k=G[W],A=v[k],T=A.score.toFixed(2)+" = "+Math.round(A.score*parseInt(a.FP_COMP.fingerprintSize,10))+"/"+a.FP_COMP.fingerprintSize;_=_+"<tr><td>"+A.referenceId+"</td><td>"+T+"</td></tr>"}w=w.replace("{{assemblyScoresDataHtml}}",_),$(".wgst-panel__assembly .assembly-detail__score .assembly-detail-content").html(w),$(".wgst-panel__assembly .wgst-panel-loading").hide()}).fail(function(e,t,a){console.log("[WGST][ERROR] Failed to get assembly data"),console.error(t),console.error(a),console.error(e),g(t)})};$("body").on("click",".wgst-tree-control__show-newick",function(){var e,t,a=$(this).closest(".wgst-panel").attr("data-collection-id"),s=$(this).closest(".wgst-panel").attr("data-collection-tree-type");e=WGST.collection[a].tree[s].newickStringWithLabels,t=window.open(),t.document.write(e)}),$("body").on("click",".wgst-tree-control__decrease-label-font-size",function(){var e,t,a=$(this).closest(".wgst-panel").attr("data-collection-id"),s=$(this).closest(".wgst-panel").attr("data-collection-tree-type");t=WGST.collection[a].tree[s].canvas,e=t.textSize,t.setTextSize(e-3)}),$("body").on("click",".wgst-tree-control__increase-label-font-size",function(){var e,t,a=$(this).closest(".wgst-panel").attr("data-collection-id"),s=$(this).closest(".wgst-panel").attr("data-collection-tree-type");t=WGST.collection[a].tree[s].canvas,e=t.textSize,t.setTextSize(e+3)
}),$("body").on("click",".wgst-tree-control__decrease-node-size",function(){var e,t,a=$(this).closest(".wgst-panel").attr("data-collection-id"),s=$(this).closest(".wgst-panel").attr("data-collection-tree-type");e=WGST.collection[a].tree[s].canvas,t=e.baseNodeSize,t>3?(e.setNodeSize(t-3),t=e.baseNodeSize,3>t&&$(this).attr("disabled",!0)):$(this).attr("disabled",!0)}),$("body").on("click",".wgst-tree-control__increase-node-size",function(){var e,t,a=$(this).closest(".wgst-panel").attr("data-collection-id"),s=$(this).closest(".wgst-panel").attr("data-collection-tree-type");e=WGST.collection[a].tree[s].canvas,t=e.baseNodeSize,e.setNodeSize(t+3),e.baseNodeSize>3&&$(this).closest(".wgst-tree-control").find(".wgst-tree-control__decrease-node-size").attr("disabled",!1)}),$("body").on("change",".wgst-tree-control__show-node-labels",function(){var e,t=$(this).closest(".wgst-panel").attr("data-collection-id"),a=$(this).closest(".wgst-panel").attr("data-collection-tree-type");e=WGST.collection[t].tree[a].canvas,e.toggleLabels()}),$("body").on("click",".wgst-tree-control__merge-collection-trees",function(){var e=$(this);e.attr("disabled",!0),e.find(".wgst-spinner-label").hide(),e.find(".wgst-spinner").show();var t={collectionId:e.closest(".wgst-panel").attr("data-collection-id"),mergeWithCollectionId:"b8d3aab1-625f-49aa-9857-a5e97f5d6be5",collectionTreeType:e.attr("data-collection-tree-type"),socketRoomId:WGST.socket.roomId};console.log("[WGST] Requesting to merge collection trees: "+t.collectionId+", "+t.mergeWithCollectionId),$.ajax({type:"POST",url:"/api/collection/tree/merge",datatype:"json",data:t}).done(function(){console.log("[WGST] Requested to merge collection trees: "+t.collectionId+", "+t.mergeWithCollectionId)})});var jt=function(){console.log("[WGST] Rendering representative collection tree");var e="representative";$(".wgst-panel__representative-collection-tree .wgst-tree-content").html(""),$(".wgst-panel__representative-collection-tree .wgst-tree-content").attr("id","phylocanvas_"+e),console.log("WGST.collection.representative:"),console.dir(WGST.collection.representative),WGST.collection.representative.tree.canvas=new PhyloCanvas.Tree($('[data-panel-name="representativeCollectionTree"] .wgst-tree-content').get(0),{history_collapsed:!0}),WGST.collection.representative.tree.canvas.load("/data/reference_tree.nwk"),WGST.collection.representative.tree.canvas.treeType="rectangular"};$(".wgst-navigation-item").on("click",function(e){e.preventDefault()}),$(".wgst-navigation-item__map").on("click",function(){var e=$(".wgst-fullscreen--active");"map"===e.attr("data-fullscreen-name")&&Yt(!1),d("map"),google.maps.event.trigger(WGST.geo.map.canvas,"resize")}),$(".wgst-navigation-item__representative-tree").on("click",function(){return!1}),$(".wgst-navigation-item__collection").on("click",function(){if(y("collection")){var e=$(".wgst-fullscreen--active");"collection"===e.attr("data-fullscreen-name")&&Yt(!1),d("collection")}}),google.maps.event.addDomListener(window,"resize",function(){var e=WGST.geo.map.canvas,t=e.getCenter();google.maps.event.trigger(e,"resize"),e.setCenter(t)});var zt=function(e){console.log("[WGST] Maximizing collection "+e),Yt("map"),$('[data-toggle="tooltip"]').tooltip("destroy"),qt("collection_"+e,function(){$('[data-toggle="tooltip"]').tooltip(),d("map")}),google.maps.event.trigger(WGST.geo.map.canvas,"resize")},Yt=function(e,t){var o=$(".wgst-fullscreen--active"),l=o.attr("data-fullscreen-name");o.removeClass("wgst-fullscreen--active").removeClass("wgst-fullscreen--visible"),"undefined"!=typeof l&&e&&(a(l),s(l)),"map"===l&&$('.wgst-panel[data-panel-name="'+l+'"] .wgst-panel-body-content').html("").append(WGST.geo.map.canvas.getDiv()),o.html(""),"function"==typeof t&&t()},qt=function(e,t){var a=$('[data-panel-id="'+e+'"]'),s=a.attr("data-panel-name"),o=$('[data-fullscreen-name="'+s+'"]').addClass("wgst-fullscreen--active").addClass("wgst-fullscreen--visible");"collection"===s&&o.append($(".collection-details").clone(!0)),r(s),"function"==typeof t&&t()},Vt=function(e,t){Pt(e)||(Yt(!1),qt(t,function(){$('[data-fullscreen-name="'+e+'"]').html("").append(WGST.geo.map.canvas.getDiv()),google.maps.event.trigger(WGST.geo.map.canvas,"resize")}))};$("body").on("click",".wgst-panel-control-button__maximize",function(){if($(this).hasClass("wgst-panel-control-button--active")){var e=$(this).closest(".wgst-panel"),t=e.attr("data-panel-name"),a=e.attr("data-panel-id");"collection"===t?($('[data-toggle="tooltip"]').tooltip("destroy"),Yt(!1),qt(a,function(){$('[data-fullscreen-name="'+t+'"]').html("").append($(".collection-details").clone(!0)),$('[data-toggle="tooltip"]').tooltip()})):"map"===t?Vt(t,a):"collectionTree"===t&&qt(t,function(){var e=$(".wgst-panel__collection-tree").find(".wgst-tree-content"),t=$(".wgst-fullscreen__collection-tree");t.append(e.clone(!0));var a=$(".wgst-panel__collection-tree").attr("data-collection-id");$(".wgst-panel__collection-tree").html(""),console.log(a),WGST.collection[a].tree.canvas.draw()})}}),$("body").on("click",".wgst-panel-control-button__close",function(){if($(this).hasClass("wgst-panel-control-button--active")){var e=$(this).closest(".wgst-panel"),t=e.attr("data-panel-name");if(r(t),"collection"===t);else if("representativeCollectionTree"===t){var a=e.attr("data-collection-id");M(a)}}}),$("body").on("click",".wgst-panel-control-button__opacity",function(){if($(this).hasClass("wgst-panel-control-button--active")){var e=$(this).closest(".wgst-panel");"1"!==e.css("opacity")?e.css("opacity","1"):e.css("opacity","0.85")}});var Ht=function(e){for(var t,a,s=e,o=s.offset(),l=s.closest(".wgst-panel").attr("data-collection-id"),n=WGST.collection[l].tree.CORE_TREE_RESULT.canvas,i=n.leaves,r={top:n.translateClickY(o.top),left:n.translateClickX(o.left)},c={bottom:n.translateClickY(o.top+s.height()),right:n.translateClickX(o.left+s.width())},d=$(".collection-assembly-list"),p=$(".collection-assembly-list-full"),m=document.createDocumentFragment(),g=0,u=0;u<i.length;)a=i[u],a.centerx>=r.left&&a.centerx<=c.right&&a.centery>=r.top&&a.centery<=c.bottom&&(t=p.find('.assembly-list-item[data-assembly-id="'+a.id+'"]')[0],m.appendChild(t.cloneNode(!0)),g+=1),u+=1;g>7?$(".collection-assembly-list-more-assemblies").show():$(".collection-assembly-list-more-assemblies").hide();for(var b=d[0];b.firstChild;)b.removeChild(b.firstChild);b.appendChild(m),d.find('.antibiotic[data-toggle="tooltip"]').tooltip()};$(".collection-assembly-list-view-all-assemblies").on("click",function(e){var t=$(this).closest(".wgst-panel").attr("data-collection-id"),a=$(".collection-assembly-list");WGST.collection[t].tree.canvas.redrawOriginalTree(),WGST.collection[t].tree.canvas.setZoom(-.05),a.find(".assembly-list-item").remove(),a.append($(".collection-assembly-list-full .assembly-list-item").clone()),a.find('.antibiotic[data-toggle="tooltip"]').tooltip(),$(".collection-assembly-list-all-assemblies").hide(),$(".collection-assembly-list-more-assemblies").show(),e.preventDefault()}),$("body").on("click",".tree-controls-match-assembly-list",function(){var e=$(this).closest(".wgst-panel-body-content").find("canvas.phylocanvas");Ht(e)}),WGST.geo.map.init()});