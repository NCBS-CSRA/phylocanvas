$(function(){window.onerror=function(av){console.error("[WGST][Error] "+av);ab(av)};var R=window.WGST||{};R.panels={assembly:{top:80,left:90},collection:{top:80,left:90},collectionTree:{top:160,left:180},representativeCollectionTree:{top:80,left:90},assemblyUploadNavigator:{top:70,left:110},assemblyUploadAnalytics:{top:70,left:726},assemblyUploadMetadata:{top:225,left:110},assemblyUploadProgress:{top:80,left:90},map:{top:80,left:90}};R.assembly={analysis:{UPLOAD_OK:"UPLOAD_OK",METADATA_OK:"METADATA_OK",MLST_RESULT:"MLST_RESULT",PAARSNP_RESULT:"PAARSNP_RESULT",FP_COMP:"FP_COMP"}};R.collection={analysis:{COLLECTION_TREE:"COLLECTION_TREE"},representative:{tree:{},metadata:{}}};R.upload={collection:{},assembly:{}};R.settings=R.settings||{};R.settings.representativeCollectionId="1fab53b0-e7fe-4660-b34e-21d501017397";R.antibioticNameRegex=/[\W]+/g;R.socket={connection:io.connect(R.config.socketAddress),roomId:""};R.geo={map:{canvas:{},options:{zoom:5,center:new google.maps.LatLng(48.6908333333,9.14055555556),mapTypeId:google.maps.MapTypeId.ROADMAP,minZoom:2,maxZoom:6},markers:{assembly:{},metadata:{},representativeTree:[]},markerBounds:new google.maps.LatLngBounds(),searchBoxBounds:new google.maps.LatLngBounds(),init:function(){R.geo.map.canvas=new google.maps.Map($(".wgst-map")[0],R.geo.map.options);R.geo.map.markers.metadata=new google.maps.Marker({position:new google.maps.LatLng(51.511214,-0.119824),map:R.geo.map.canvas,visible:false});google.maps.event.addListener(R.geo.map.canvas,"bounds_changed",function(){R.geo.map.searchBoxBounds=R.geo.map.canvas.getBounds()})}},placeSearchBox:{}};R.alert={status:{SUCCESS:"success",FAILURE:"failure"}};R.init={all:{SOCKET_CONNECT:"Socket connected",SOCKET_ROOM_ID:"Received socket room id",REPRESENTATIVE_COLLECTION_TREE_METADATA:"Loaded representative collectiontree metadata"},loaded:[]};R.dragAndDrop=window.WGST.dragAndDrop||{};R.dragAndDrop.files=[];R.dragAndDrop.fastaFileNameRegex=/^.+(.fa|.fas|.fna|.ffn|.faa|.frn|.fasta|.contig)$/i;var Z=function(av){R.init.loaded.push(av);if(R.init.loaded.length===Object.keys(R.init.all).length){var aw=$(".wgst-init");aw.find(".wgst-init-status").html("");setTimeout(function(){aw.fadeOut("fast")},500);delete R.init}};var m=function(av){var ax=function(aA){var az=$('[data-panel-name="'+aA+'"] .wgst-panel-body-content');az.css("visibility","visible")};if($.isArray(av)){var aw=av.length,ay;for(;aw!==0;){aw=aw-1;ay=av[aw];ax(ay)}}else{ax(av)}};var ao=function(av){var ay=function(az){$('[data-panel-name="'+az+'"]').css("visibility","visible")};if($.isArray(av)){var aw=av.length,ax;for(;aw!==0;){aw=aw-1;ax=av[aw];ay(ax)}}else{ay(av)}};var ap=function(av){var ax=function(aA){var az=$('[data-panel-name="'+aA+'"] .wgst-panel-body-content');az.css("visibility","hidden")};if($.isArray(av)){var aw=av.length,ay;for(;aw!==0;){aw=aw-1;ay=av[aw];ax(ay)}}else{ax(av)}};var at=function(av){var ax=function(az){$('[data-panel-name="'+az+'"]').css("visibility","hidden")};if($.isArray(av)){var aw=av.length,ay;for(;aw!==0;){aw=aw-1;ay=av[aw];ax(ay)}}else{ax(av)}};var g=function(aw){var av=$('[data-panel-name="'+aw+'"] .wgst-panel-loading');av.show()};var T=function(aw){var av=$('[data-panel-name="'+aw+'"] .wgst-panel-loading');av.hide()};$(".tree-controls-draw-subtree").on("click",function(){var aw=$(this).closest(".wgst-panel").attr("data-collection-id"),av=$(this).attr("data-selected-node");console.log("collectionId: "+aw);console.log("selectedNode: "+av);window.WGST.collection[aw].tree.canvas.redrawFromBranch(av)});$(".collection-view-horizontal-split").on("click",function(){var av=$(".wgst-paper__collection-tree"),aw=$(".wgst-paper__collection-metadata")});var b=function(aw){var av=$('[data-panel-name="'+aw+'"]');if(av.hasClass("wgst-panel--active")){return true}else{return false}};var B=function(aw){var av=$('[data-panel-name="'+aw+'"]');if(av.hasClass("wgst-panel--visible")){return true}else{return false}};var l=function(aw,az){var av=function(aB){var aA=$('[data-panel-name="'+aB+'"]');aA.css("top",R.panels[aB].top);aA.css("left",R.panels[aB].left);aA.css("visibility","hidden");aA.fadeIn("fast");aA.addClass("wgst-panel--active")};if($.isArray(aw)){var ax=aw.length,ay;for(;ax!==0;){ax=ax-1;ay=aw[ax];av(ay)}}else{av(aw)}if(typeof az==="function"){az()}};var a=function(aw,az){var av=function(aC){var aB=$('[data-panel-name="'+aC+'"]'),aA=aB.find(".wgst-panel-body-content");aB.hide();aB.removeClass("wgst-panel--active")};if($.isArray(aw)){var ax=aw.length,ay;for(;ax!==0;){ax=ax-1;ay=aw[ax];av(ay)}}else{av(aw)}if(typeof az==="function"){az()}};var am=function(aw){var av=0;$(".wgst-panel").each(function(){var ax=parseInt($(this).css("zIndex"),10);if(ax>av){av=ax}});$('[data-panel-name="'+aw+'"]').css("zIndex",av+1)};var o=function(av){l(av);T(av);m(av);ao(av);am(av)};var ar=function(av){console.log("[WGST] Getting representative collection tree metadata");$.ajax({type:"GET",url:"/api/collection/representative/metadata",datatype:"json"}).done(function(aw,ay,ax){console.log("[WGST] Got representative collection metadata");av(null,aw)}).fail(function(aw,ay,ax){console.error("✗ [WGST][Error] Failed to get representative collection metadata");console.error(ay);console.error(ax);console.error(aw);av(ay,null)})};var u=function(ax,av,ay){console.error("✗ [WGST][Error] "+ax);var aw=$(".wgst-alert");aw.attr("class","wgst-alert").addClass("wgst-alert__"+av);aw.html(ax).show();if(ay){setTimeout(function(){aw.fadeOut("fast")},3000)}};var ab=function(av){console.error("✗ [WGST][Error] "+av);var aw=$(".wgst-notification__error");aw.html(av).show()};var P=function(av){console.log("• [WGST][Warning] "+av);var aw=$(".wgst-notification__warning");aw.html(av).show();setTimeout(function(){aw.hide();aw.html("")},5000)};(function(){$(".wgst-draggable").draggable({handle:".wgst-draggable-handle",appendTo:"body",scroll:false,stop:function(av,aw){var ax=aw.helper.attr("data-panel-name");R.panels[ax].top=aw.position.top;R.panels[ax].left=aw.position.left}});$(".assembly-list-slider").slider({range:"max",min:1,max:10,value:1,animate:"fast",slide:function(av,aw){$(".selected-assembly-counter").text(aw.value)}});$(".add-data button").popover({html:true,placement:"bottom",title:"Add your data",content:'<div class="upload-data"><span>You can drag and drop your CSV files anywhere on the map.</span><input type="file" id="exampleInputFile"></div>'});$(".timeline-toggle-button").on("click",function(){if($(this).hasClass("active")){$("#timeline").hide()}else{$("#timeline").css("bottom","0");$("#timeline").show()}});$(".graph-toggle-button").on("click",function(){if($(this).hasClass("active")){$(".tree-panel").hide()}else{$(".tree-panel").show()}});$(".all-panels-toggle-button").on("click",function(){if($(this).hasClass("active")){$(".wgst-panel--active").hide()}else{$(".wgst-panel--active").show()}});$(".graph-toggle-button").trigger("click");R.socket.connection.on("roomId",function(av){console.log("[WGST][Socket.io] Received room uuid");console.log("[WGST][Socket.io] Ready");window.WGST.socket.roomId=av;Z(R.init.all.SOCKET_ROOM_ID)});R.socket.connection.emit("getRoomId");R.socket.connection.on("connect",function(){if(typeof R.init!=="undefined"){Z(R.init.all.SOCKET_CONNECT)}});R.socket.connection.on("error",function(){u("Unexpected error has occured.",R.alert.status.FAILURE,false)});R.socket.connection.on("disconnect",function(){u("Disconnected from the server.",R.alert.status.FAILURE,false)});R.socket.connection.on("reconnecting",function(){u("Reconnecting to the server...",R.alert.status.FAILURE,false)});R.socket.connection.on("reconnect",function(){u("Reconnected to the server.",R.alert.status.SUCCESS,true)});R.socket.connection.on("reconnect_failed",function(){u("Failed to reconnect to the server.",R.alert.status.FAILURE,false)});ar(function(av,aw){if(av){ab(av);return}R.collection.representative.metadata=aw;l("representativeCollectionTree",function(){g("representativeCollectionTree");N()});Z(R.init.all.REPRESENTATIVE_COLLECTION_TREE_METADATA)})})();var aa=function(aC,av){var ax="",aB,aE,ay,az,aD,aw,aA;for(aE in av){if(av.hasOwnProperty(aE)){aB=av[aE];ay="  ";aw="";for(az in aB){if(aB.hasOwnProperty(az)){aD="";if(typeof aC[aE]!=="undefined"){if(typeof aC[aE][az]!=="undefined"){aA=aC[aE][az].resistanceState;if(aA==="RESISTANT"){aD=aD+"⦿"}else{if(aA==="SENSITIVE"){aD=aD+"○"}else{aD=aD+"○"}}}else{aD=aD+"○"}}else{aD=aD+"○"}aw=aw+aD}}ay=ay+aw;ax=ax+ay}}return ax};var n=function(aC,av){var ax="",aB,aE,ay,az,aD,aw,aA;for(aE in av){if(av.hasOwnProperty(aE)){aB=av[aE];ay='<div class="antibiotic-group" data-antibiotic-group-name="'+aE+'">{{antibioticsHtml}}</div>';aw="";for(az in aB){if(aB.hasOwnProperty(az)){aD="";if(typeof aC[aE]!=="undefined"){if(typeof aC[aE][az]!=="undefined"){aA=aC[aE][az].resistanceState;if(aA==="RESISTANT"){aD=aD+'<span class="antibiotic resistance-fail" data-antibiotic-name="'+az+'" data-antibiotic-resistance-state="'+aA+'" data-toggle="tooltip" data-placement="top" title="'+az+'"></span>'}else{if(aA==="SENSITIVE"){aD=aD+'<span class="antibiotic resistance-success" data-antibiotic-name="'+az+'" data-antibiotic-resistance-state="'+aA+'" data-toggle="tooltip" data-placement="top" title="'+az+'"></span>'}else{aD=aD+'<span class="antibiotic resistance-unknown" data-antibiotic-name="'+az+'" data-antibiotic-resistance-state="'+aA+'" data-toggle="tooltip" data-placement="top" title="'+az+'"></span>'}}}else{aD=aD+'<span class="antibiotic resistance-unknown" data-antibiotic-name="'+az+'" data-antibiotic-resistance-state="'+aA+'" data-toggle="tooltip" data-placement="top" title="'+az+'"></span>';console.error("[!] Assembly resistatance profile has no antibiotic: "+az)}}else{aD=aD+'<span class="antibiotic no-resistance-data" data-antibiotic-name="'+az+'" data-antibiotic-resistance-state="'+aA+'" data-toggle="tooltip" data-placement="top" title="'+az+'"></span>';console.error("[!] Assembly resistatance profile has no antibiotic group: "+aE)}aw=aw+aD}}ay=ay.replace(/{{antibioticsHtml}}/g,aw);ax=ax+ay}}return ax};var S=function(aH,av){console.log("[WGST] Rendering assembly analysis list");var ax=R.collection[aH].assemblies,aB=R.collection[aH].sortedAssemblyIds,aJ,aI,ay,aF,aA,aw,az=0;var aG=$(".collection-assembly-list"),aC=$(".collection-assembly-list-full"),aE,aD=document.createDocumentFragment();for(;az<aB.length;){aJ=aB[az];console.log("[?] Assembly resistance profile:");console.dir(ax[aJ].PAARSNP_RESULT.paarResult.resistanceProfile);aI=ax[aJ].PAARSNP_RESULT.paarResult.resistanceProfile;ay=n(aI,av);aF=aj(ax[aJ]["FP_COMP"].scores);R.collection[aH].assemblies[aJ]["FP_COMP"].topScore=aF;aA=ax[aJ]["ASSEMBLY_METADATA"].geography.position.latitude;aw=ax[aJ]["ASSEMBLY_METADATA"].geography.position.longitude;aE=$(((az%2===0)?'<div class="row-stripe assembly-list-item" data-assembly-id="'+ax[aJ]["FP_COMP"].assemblyId+'">':'<div class="assembly-list-item" data-assembly-id="'+ax[aJ]["FP_COMP"].assemblyId+'">')+'<div class="show-on-tree-radio-button assembly-list-header-tree"><input type="radio" data-reference-id="'+aF.referenceId+'" data-assembly-id="'+ax[aJ]["FP_COMP"].assemblyId+'" name="optionsRadios" value="'+aF.referenceId+'"></div><div class="show-on-map-checkbox assembly-list-header-map"><input type="checkbox" data-reference-id="'+aF.referenceId+'" data-assembly-id="'+ax[aJ]["FP_COMP"].assemblyId+'" data-latitude="'+aA+'" data-longitude="'+aw+'"></div><div class="assembly-list-header-id"><a href="#" class="open-assembly-button" data-assembly-id="'+ax[aJ]["FP_COMP"].assemblyId+'" title="">'+ax[aJ]["ASSEMBLY_METADATA"]["userAssemblyId"]+'</a></div><div class="assembly-list-header-nearest-representative"><a href="#" class="show-on-representative-tree" data-assembly-id="'+ax[aJ]["FP_COMP"].assemblyId+'">'+aF.referenceId+"</a> ("+Math.round(aF.score.toFixed(2)*100)+'%)</div><div class="assembly-list-header-st">'+(ax[aJ]["MLST_RESULT"].stType.length===0?"Not found":ax[aJ]["MLST_RESULT"].stType)+'</div><div class="assembly-list-header-resistance-profile"><div class="assembly-resistance-profile-container">'+ay+"</div></div></div>");aD.appendChild(aE[0]);az=az+1}aG[0].appendChild(aD.cloneNode(true));aC[0].appendChild(aD.cloneNode(true));$('.antibiotic[data-toggle="tooltip"]').tooltip()};var z=function(aw){var av=$(".wgst-navigation-item__"+aw);if(av.hasClass("wgst-navigation-item--active")){return true}else{return false}};var f=function(aw){var av=$(".wgst-navigation-item__"+aw);if(!z(aw)){av.addClass("wgst-navigation-item--active")}};var O=function(aw){var av=$(".wgst-navigation-item__"+aw);if(z(aw)){av.removeClass("wgst-navigation-item--active")}};var D=function(av){console.log("[WGST] Clearing "+av+" collection assembly list");$(".wgst-panel__collection .collection-assembly-list").html("")};var t=function(av){console.log("[WGST] Closing collection "+av);D(av);a(["collection","collectionTree"],function(){delete window.WGST.collection[av];window.history.replaceState("Object","WGST Collection","")});O("collection")};var w=function(av){console.log("[WGST] Getting collection "+av);$(".wgst-panel__collection").attr("data-panel-id","collection_"+av);$(".wgst-panel__collection").attr("data-collection-id",av);$(".wgst-panel__collection .collection-details").attr("data-collection-id",av);$(".wgst-panel__collection-tree").attr("data-collection-id",av);l("collection",function(){g("collection");ao("collection")});l("collectionTree",function(){g("collectionTree")});window.WGST.collection[av]={assemblies:{},tree:{data:{}}};$.ajax({type:"POST",url:"/collection/",datatype:"json",data:{collectionId:av}}).done(function(aC,aA,aJ){console.log("[WGST] Got collection "+av+" data");console.dir(aC);R.collection[av].tree.data=aC.collection.tree;R.collection[av].assemblies=aC.collection.assemblies;R.antibiotics=aC.antibiotics;var aL,aD,aF={},aK,aI,aE,aG;for(aL in R.collection[av].assemblies){aD=R.collection[av].assemblies[aL];aF=aD.PAARSNP_RESULT.paarResult.resistanceProfile;aE={};console.log("resistanceProfileGroups: "+aF);console.dir(aF);for(aK in aF){aI=aF[aK];for(aG in aI){aE[aG]=aI[aG]}}R.collection[av].assemblies[aL].PAARSNP_RESULT.paarResult.ungroupedResistanceProfile=aE;console.log("WGST.collection[collectionId].assemblies[assemblyId].PAARSNP_RESULT.paarResult.ungroupedResistanceProfile:");console.dir(R.collection[av].assemblies[aL].PAARSNP_RESULT.paarResult.ungroupedResistanceProfile)}$(".wgst-panel__collection-tree .wgst-tree-content").html("");$(".wgst-panel__collection-tree .wgst-tree-content").attr("id","phylocanvas_"+av);C(av);T("collectionTree");var ax=window.WGST.collection[av].assemblies,aB=[],az=[];$.each(window.WGST.collection[av].tree.leavesOrder,function(aN,aM){aB.push(ax[aM.id]);az.push(aM.id)});R.collection[av].sortedAssemblyIds=az;S(av,R.antibiotics);console.log("[WGST] Collection "+av+" has "+Object.keys(ax).length+" assemblies");var aH=Object.keys(ax),aw=aH[aH.length-1],ay=ax[aw]["FP_COMP"].timestamp;$(".assembly-created-datetime").attr("title",moment(ay,"YYYYMMDD_HHmmss").format("YYYY-MM-DD HH:mm:ss"));$(".timeago").timeago();$(".wgst-stats__collection .wgst-stats-value__total-number-of-assemblies").html(aB.length);$(".wgst-stats__collection .wgst-stats-value__number-of-displayed-assemblies").html(aB.length);$(".wgst-stats__collection .wgst-stats-value__number-of-selected-assemblies").html("0");$(".wgst-stats__collection .wgst-stats-value__created-on").html(moment(new Date()).format("DD/MM/YYYY"));$(".wgst-stats__collection .wgst-stats-value__author").html("Anonymous");$(".wgst-stats__collection .wgst-stats-value__privacy").html("Public");T("collection");m("collection");if(Object.keys(R.collection[av].assemblies).length>100){console.log("[WGST] Collection "+av+" will be displayed fullscreen");ad(av);a("collection")}f("collection")}).fail(function(aw,ay,ax){console.log("[WGST][ERROR] Failed to get collection id");console.error(ay);console.error(ax);console.error(aw);ab(ay)})};if(typeof window.WGST.requestedCollectionId!=="undefined"){w(window.WGST.requestedCollectionId)}$(".tree-controls-show-labels").on("click",function(){var av=$(this).closest(".wgst-panel").attr("data-collection-id");window.WGST.collection[av].tree.canvas.displayLabels()});$(".tree-controls-hide-labels").on("click",function(){var av=$(this).closest(".wgst-panel").attr("data-collection-id");window.WGST.collection[av].tree.canvas.hideLabels()});var au=function(aw,av){var ax=window.WGST.collection[aw].assemblies;$('.collection-assembly-list .assembly-list-item [type="radio"]').prop("checked",false);$.each(ax,function(az,ay){if($.inArray(az,av.split(","))!==-1){$('.collection-assembly-list .assembly-list-item[data-assembly-id="'+az+'"]').addClass("row-selected")}else{$('.collection-assembly-list .assembly-list-item[data-assembly-id="'+az+'"]').removeClass("row-selected")}});if(av.split(",").length===1){$('.collection-assembly-list .assembly-list-item[data-assembly-id="'+av+'"] [type="radio"]').prop("checked",true)}};$(".wgst-tree-control__change-node-label").on("change",function(){var ax=$(this),az=ax.closest(".wgst-panel").attr("data-collection-id");var av=R.collection[az].tree.canvas,aB=R.collection[az].assemblies,aw;if(ax.val()==="1"){for(aw in aB){if(aB.hasOwnProperty(aw)){if(av.branches[aw].leaf){av.branches[aw].label=aB[aw].ASSEMBLY_METADATA.userAssemblyId}}}}else{if(ax.val()==="2"){for(aw in aB){if(aB.hasOwnProperty(aw)){if(av.branches[aw].leaf){av.branches[aw].label=R.collection[az].assemblies[aw]["FP_COMP"].topScore.referenceId}}}}else{if(ax.val()==="3"){for(aw in aB){if(aB.hasOwnProperty(aw)){if(av.branches[aw].leaf){av.branches[aw].label=(aB[aw]["MLST_RESULT"].stType.length===0?"Not found":aB[aw]["MLST_RESULT"].stType)}}}}else{if(ax.val()==="4"){var ay,aA;for(aw in aB){if(aB.hasOwnProperty(aw)){ay=aB[aw].PAARSNP_RESULT.paarResult.resistanceProfile,aA=aa(ay,R.antibiotics);if(av.branches[aw].leaf){av.branches[aw].label=aA}}}}else{if(ax.val()==="5"){for(aw in aB){if(aB.hasOwnProperty(aw)){if(av.branches[aw].leaf){av.branches[aw].label=aB[aw]["ASSEMBLY_METADATA"].geography.address}}}}}}}}R.collection[az].tree.canvas.draw()});$(".wgst-tree-control__change-node-colour").on("change",function(){var az=$(this).find("option:selected"),aA=az.closest(".wgst-panel").attr("data-collection-id");var aw=R.collection[aA].tree.canvas,aB=R.collection[aA].assemblies,ay;if(az.val()==="0"){for(ay in aB){if(aB.hasOwnProperty(ay)){aw.setNodeColourAndShape(ay,"#ffffff")}}}else{var av,ax;for(ay in aB){if(aB.hasOwnProperty(ay)){av=aB[ay].PAARSNP_RESULT.paarResult.ungroupedResistanceProfile;ax=av[az.text()];if(typeof ax!=="undefined"){if(aw.branches[ay].leaf){if(ax.resistanceState==="RESISTANT"){aw.setNodeColourAndShape(ay,"#ff0000")}else{if(ax.resistanceState==="SENSITIVE"){aw.setNodeColourAndShape(ay,"#4dbd33")}else{if(ax.resistanceState==="UNKNOWN"){aw.setNodeColourAndShape(ay,"#ffffff")}}}}}else{if(aw.branches[ay].leaf){aw.setNodeColourAndShape(ay,"#ffffff")}}}}}});$(".wgst-tree-control__change-tree-type").on("change",function(){var aw=$(this).find("option:selected"),ax=aw.closest(".wgst-panel").attr("data-collection-id"),av=R.collection[ax].tree.canvas;av.setTreeType(aw.val())});var C=function(aD){console.log("[WGST] Rendering "+aD+" collection tree");console.dir(R.collection[aD].tree);R.collection[aD].tree.canvas=new PhyloCanvas.Tree(document.getElementById("phylocanvas_"+aD));R.collection[aD].tree.canvas.parseNwk(R.collection[aD].tree.data);R.collection[aD].tree.canvas.treeType="rectangular";var aF=R.collection[aD].tree.canvas,av=R.collection[aD].assemblies,aE;R.collection[aD].tree.canvas.onselected=function(aH){au(aD,aH)};for(aE in av){if(av.hasOwnProperty(aE)){if(aF.branches[aE].leaf){aF.branches[aE].label=av[aE].ASSEMBLY_METADATA.userAssemblyId}}}R.collection[aD].tree.canvas.draw();var az=aF.leaves;az.sort(function(aI,aH){return aI.centery-aH.centery});R.collection[aD].tree.leavesOrder=az;var aw=window.WGST.collection[aD].tree.data;for(aE in av){if(av.hasOwnProperty(aE)){aw=aw.replace(aE,av[aE].ASSEMBLY_METADATA.userAssemblyId)}}console.debug("» [WGST][DEV] Parsed Newick String:");console.log("» Uncomment to see.");var ax=$("#select-tree-node-antibiotic"),aG,aA,aC=[],ay={};for(aG in R.antibiotics){for(aA in R.antibiotics[aG]){aC.push(aA);ay[aA]='<option value="'+aA.replace(R.antibioticNameRegex,"_").toLowerCase()+'">'+aA+"</option>"}}aC.sort();var aB=aC.length;for(aB=0;aB<aC.length;){aA=aC[aB];ax.append($(ay[aA]));aB=aB+1}};R.geo.map.init();var I=function(aw){var av=window.WGST.collection[aw].tree.canvas;av.selectNodes("")};$(".tree-controls-select-none").on("click",function(){var av=$(this).closest(".wgst-panel").attr("data-collection-id");I(av)});$(".tree-controls-select-all").on("click",function(){var az=$(this).closest(".wgst-panel").attr("data-collection-id"),av=window.WGST.collection[az].tree.canvas;var aA=av.leaves,ay=aA.length,ax=[],aw;for(;ay!==0;){ay=ay-1;aw=aA[ay].id;ax.push(aw)}av.root.setSelected(true,true);av.draw();e(az,ax)});var e=function(aD,aA){window.WGST.collection[aD].geo=window.WGST.collection[aD].geo||{};var ax=window.WGST.collection[aD].tree.canvas,aB=window.WGST.collection[aD].geo.markers,aF=aB.length;for(;aF!==0;){aF=aF-1;aB[aF].setMap(null)}window.WGST.collection[aD].geo.markers=[];window.WGST.geo.map.markerBounds=new google.maps.LatLngBounds();if(aA.length>0){console.log("[WGST] Selected assembly ids:");console.dir(aA);var aw=aA.length,aE,az,aC,av;for(;aw!==0;){aw=aw-1;aE=aA[aw];az=window.WGST.collection[aD].assemblies[aE]["ASSEMBLY_METADATA"];aC=az.geography.position.latitude;av=az.geography.position.longitude;if(aC&&av){console.log("[WGST] Marker's latitude: "+aC);console.log("[WGST] Marker's longitude: "+av);var ay=new google.maps.Marker({position:new google.maps.LatLng(aC,av),map:window.WGST.geo.map.canvas,icon:"http://maps.google.com/mapfiles/ms/icons/blue-dot.png",optimized:true});window.WGST.collection[aD].assemblies[aE].geo=window.WGST.collection[aD].assemblies[aE].geo||{};window.WGST.collection[aD].assemblies[aE].geo.marker=ay;window.WGST.collection[aD].geo.markers.push(aA);window.WGST.geo.map.markerBounds.extend(ay.getPosition())}}}else{console.log("[WGST] No selected assemblies");window.WGST.geo.map.canvas.panTo(new google.maps.LatLng(48.6908333333,9.14055555556));window.WGST.geo.map.canvas.setZoom(5)}};var H={},ag="",ak=document.getElementsByTagName("body")[0],ah=[],s=/^[CTAGNUX]+$/i,d=0;var V=function(aX,aI,aZ,aH,aQ){window.WGST.upload.assembly[aZ.name]={metadata:{}};var aK=[],aL=[],aC=0,az=0,aU=[],aY="",aW="",aG=$(),ax=[];aK=aX.target.result.trim().split(">").filter(function(a1){return(a1.length>0)});aI=aI+1;ah[aI]={name:aZ.name,id:"",contigs:{total:aK.length,invalid:0,individual:[]}};aU=[];aY="";aW="";for(;az<aK.length;az++){aL=aK[az].split(/\n/).filter(function(a1){return(a1.length>0)});var a0=0;for(;a0<aL;i++){aL[a0]=aL[a0].trim()}if(aL.length>1){var aN=aL.splice(1,aL.length);if(!s.test(aN[0].trim())){aN=aN.splice(1,aN.length)}aY=aN.join("").replace(/\s/g,"");aW=aL[0].trim().replace(">","");if(s.test(aY)){aU.push(aY);ah[aI]["contigs"]["individual"][az]={};ah[aI]["contigs"]["individual"][az]["id"]=aW;ah[aI]["contigs"]["individual"][az]["sequence"]=aY}else{ah[aI]["contigs"]["invalid"]=ah[aI]["contigs"]["invalid"]+1}}else{ah[aI]["contigs"]["invalid"]=ah[aI]["contigs"]["invalid"]+1}}H[aZ.name]={name:aZ.name,assembly:aX.target.result,metadata:{}};var aD=aU.sort(function(a2,a1){return a1.length-a2.length});var aE=[],aP=0;for(;aP<aD.length;aP++){if(aE.length>0){aE.push(aD[aP].length+aE[aE.length-1])}else{aE.push(aD[aP].length)}}var aM=Math.floor(aE[aE.length-1]/2);var aA=0,aV={},aP=0;for(;aP<aD.length;aP++){aA=aA+aD[aP].length;if(aA>=aM){aV.sequenceNumber=aP+1;aV.sum=aA;aV.sequenceLength=aD[aP].length;break}}var aJ=Math.floor(aE[aE.length-1]/aU.length);d=d+aK.length;$(".assembly-sequences-average").text(Math.floor(d/aH.length));aG=$('<li class="assembly-item hide-this" data-name="'+ah[aI]["name"]+'" id="assembly-item-'+aI+'"><div class="assembly-overview"><div class="assembly-stats-container"><div class="assembly-stats-label">total nt</div><div class="assembly-stats-number">'+aE[aE.length-1].toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+'</div></div><div class="assembly-stats-container"><div class="assembly-stats-label">total contigs</div><div class="assembly-stats-number assembly-stats-number-contigs">'+ah[aI]["contigs"]["total"].toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+'</div></div><div class="assembly-stats-container"><div class="assembly-stats-label">min contig</div><div class="assembly-stats-number">'+aD[aD.length-1].length.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+'<small>nt</small></div></div><div class="assembly-stats-container"><div class="assembly-stats-label">mean contig</div><div class="assembly-stats-number">'+aJ.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+'<small>nt</small></div></div><div class="assembly-stats-container"><div class="assembly-stats-label">max contig</div><div class="assembly-stats-number">'+aD[0].length.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+'<small>nt</small></div></div><div class="assembly-stats-container"><div class="assembly-stats-label">contig N50</div><div class="assembly-stats-number assembly-stats-n50-number">'+aV.sequenceLength.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+'<small>nt</small></div></div></div><div class="assembly-content-data"><div class="sequence-length-distribution-chart-'+aI+'"></div></div></li>');var aR=$('<div class="assembly-metadata"></div>'),aO=$("<h4>Please provide mandatory assembly metadata:</h4>"),aw=$("<div></div>"),aS=$('<div class="form-block assembly-metadata-'+aI+' assembly-metadata-block"><div class="form-group"><label for="assemblySampleDatetimeInput'+aI+'">When this assembly was sampled?</label><input type="text" class="form-control assembly-sample-datetime-input" id="assemblySampleDatetimeInput'+aI+'" placeholder=""></div></div>'),ay=$('<div class="form-block assembly-metadata-'+aI+' assembly-metadata-block hide-this"><div class="form-group"><label for="assemblySampleLocationInput'+aI+'">Where this assembly was sampled?</label><input type="text" class="form-control assembly-sample-location-input" id="assemblySampleLocationInput'+aI+'" placeholder="E.g.: London, United Kingdom"></div></div>'),aF=$('<div class="form-block assembly-metadata-'+aI+' assembly-metadata-block hide-this"><div class="form-group"><label for="assemblySampleSourceInput'+aI+'">What is the source of this sample?</label><select name="select" class="form-control assembly-sample-source-input" id="assemblySampleSourceInput'+aI+'"><option value="0" selected>Choose source</option><option value="1">Human</option><option value="2">Livestock</option><option value="3">Biosphere</option><option value="4">Environment</option></select></div></div>'),aB=$('<div class="form-block assembly-metadata-'+aI+' hide-this"><button class="btn btn-default next-assembly-button" class="show-next-assembly">Next empty metadata</button> <button class="btn btn-default apply-to-all-assemblies-button">Copy to all assemblies</button></div>'),aT=$('<div class="form-block assembly-metadata-'+aI+' hide-this">Ready? Click "Upload" button to upload your assemblies and metadata.</div>');aw.append(aS);aw.append(ay);aw.append(aF);if(aI<aH.length){aw.append(aB)}else{}aR.append(aO);aR.append(aw);var av=$('<li class="assembly-item hide-this" data-name="'+ah[aI]["name"]+'" id="assembly-metadata-item-'+aI+'"></li>');av.append(aR);$(".assembly-metadata-list-container ul").append(av);$(".assembly-list-container ul").append(aG);q(aE,aV,aI);$("#assembly-item-1").show();$("#assembly-metadata-item-1").show();$(".wgst-panel__assembly-upload-metadata .header-title small").text($("#assembly-metadata-item-1").attr("data-name"));$(".wgst-panel__assembly-upload-analytics .header-title small").text($("#assembly-item-1").attr("data-name"));ag=$(".assembly-item").eq("0").attr("data-name");(function(a2){var a1=$('.assembly-metadata-list-container li[data-name="'+a2+'"] .assembly-sample-location-input');R.geo.placeSearchBox[a2]=new google.maps.places.SearchBox(a1[0],{bounds:R.geo.map.searchBoxBounds});google.maps.event.addListener(R.geo.placeSearchBox[a2],"places_changed",function(){var a6=R.geo.placeSearchBox[a2].getPlaces(),a5=a6[0];if(typeof a5.geometry==="undefined"){return}var a8=a5.geometry.location.lat(),a7=a5.geometry.location.lng(),a4=a5.formatted_address;console.log("[WGST] Google Places API first SearchBox place:");console.log(a4);var a3=$('.wgst-panel__assembly-upload-metadata .assembly-item[data-name="'+a2+'"]').find(".assembly-sample-location-input");if(a3.val().length>0){a3.closest(".form-block").next(".form-block").fadeIn();a3.closest(".assembly-metadata").animate({scrollTop:a3.closest(".assembly-metadata").height()},400)}X();a3.blur().val(a4);R.geo.map.canvas.setCenter(a5.geometry.location);R.geo.map.markers.metadata.setMap(R.geo.map.canvas);R.geo.map.markers.metadata.setPosition(a5.geometry.location);R.geo.map.markers.metadata.setVisible(true);R.upload.assembly[a2]=R.upload.assembly[a2]||{};R.upload.assembly[a2].metadata=R.upload.assembly[a2].metadata||{};R.upload.assembly[a2].metadata.geography={address:a4,position:{latitude:a8,longitude:a7},type:a5.types[0]}});$('li.assembly-item[data-name="'+a2+'"] .assembly-sample-datetime-input').datetimepicker({useCurrent:false,language:"en-gb"}).on("change",function(){R.upload.assembly[a2].metadata=R.upload.assembly[a2].metadata||{};R.upload.assembly[a2].metadata.datetime=$(this).val()});$('li.assembly-item[data-name="'+a2+'"] .assembly-sample-source-input').on("change",function(){R.upload.assembly[a2].metadata=R.upload.assembly[a2].metadata||{};R.upload.assembly[a2].metadata.source=$(this).val()})}(aZ.name))};var q=function(aw,aK,aD){var aI=460,az=312;var ay=d3.extent(aw,function(aO){return aO.sequenceLength});var aN=d3.scale.linear().domain([0,aw.length]).range([40,aI-50]);var ax=d3.scale.linear().domain([aw[aw.length-1],0]).range([30,az-52]);var aA=d3.svg.axis().scale(aN).orient("bottom").ticks(10);var av=d3.svg.axis().scale(ax).orient("left").ticks(10);var aF=d3.select(".sequence-length-distribution-chart-"+aD).append("svg").attr("width",aI).attr("height",az);aF.append("g").attr("class","x axis").attr("transform","translate(20, 260)").call(aA);aF.append("g").attr("class","y axis").attr("transform","translate(60, 0)").call(av);aF.select(".x.axis").append("text").text("Ordered contigs").attr("class","axis-label").attr("text-anchor","end").attr("x",(aI/2)+49).attr("y",45);aF.select(".y.axis").append("text").text("Nucleotides sum").attr("class","axis-label").attr("transform","rotate(-90)").attr("x",-(az/2)-44).attr("y",398);aF.selectAll("circle").data(aw).enter().append("circle").attr("cx",function(aO,aP){return aN(aP+1)+20}).attr("cy",function(aO){return ax(aO)}).attr("r",5);var aC=d3.svg.line().x(function(aO,aP){return aN(aP+1)+20}).y(function(aO){return ax(aO)});aF.append("path").attr("d",aC(aw));var aH=[{x:aN(0)+20,y:ax(0)},{x:aN(1)+20,y:ax(aw[0])}];var aG=d3.svg.line().x(function(aO){return aO.x}).y(function(aO){return aO.y}).interpolate("linear");var aL=aF.append("path").attr("d",aG(aH));var aJ=aF.selectAll(".n50-circle").data([aK]).enter().append("g").attr("class","n50-group");var aM=aJ.append("circle").attr("cx",function(aO){return aN(aO.sequenceNumber)+20}).attr("cy",function(aO){return ax(aO.sum)}).attr("r",6);aJ.append("text").attr("dx",function(aO){return aN(aO.sequenceNumber)+20+9}).attr("dy",function(aO){return ax(aO.sum)+5}).attr("text-anchor","right").text("N50");var aB=[{x:54,y:ax(aK.sum)},{x:aN(aK.sequenceNumber)+20,y:ax(aK.sum)},{x:aN(aK.sequenceNumber)+20,y:az-46}];var aE=d3.svg.line().x(function(aO){return aO.x}).y(function(aO){return aO.y}).interpolate("linear");aJ.append("path").attr("d",aE(aB))};var v=function(av){av.stopPropagation();av.preventDefault();av.dataTransfer.dropEffect="copy"};var p=function(az){if(az.dataTransfer.files.length>0){az.stopPropagation();az.preventDefault();var aA="";if(b("collection")){aA=$(".wgst-panel__collection").attr("data-collection-id");$(".wgst-panel__assembly-upload-navigator").attr("data-collection-id",aA);a("collection");D(aA)}else{if(G("collection")){aA=$(".wgst-fullscreen__collection .wgst-collection").attr("data-collection-id");$(".wgst-panel__assembly-upload-navigator").attr("data-collection-id",aA);D(aA);h("map","map")}}if(!b("assemblyUploadNavigator")){l("assemblyUploadNavigator");ao("assemblyUploadNavigator")}if(!b("assemblyUploadAnalytics")){l("assemblyUploadAnalytics");ao("assemblyUploadAnalytics")}if(!b("assemblyUploadMetadata")){l("assemblyUploadMetadata");ao("assemblyUploadMetadata")}$(".assembly-upload-panel").trigger("mousedown");var ay=az.dataTransfer.files;R.dragAndDrop.files=$.merge(R.dragAndDrop.files,ay);var aw=R.dragAndDrop.files,ax=aw[0],aB=ax.name,av=new FileReader();if(aw.length===1){$(".upload-multiple-assemblies-label").hide();$(".upload-single-assembly-file-name").text(aB);$(".upload-single-assembly-label").show()}else{$(".upload-single-assembly-label").hide();$(".upload-multiple-assemblies-label").show()}$(".total-number-of-dropped-assemblies").text(aw.length);$(".assembly-list-slider").slider("option","max",aw.length);$(".assembly-file-name").text(aB);if(aw.length>1){$(".assembly-navigator").show();$(".ui-slider-handle").focus()}$.each(aw,function(aD,aC){if(aC.name.match(R.dragAndDrop.fastaFileNameRegex)){if($('.wgst-panel__assembly-upload-analytics .assembly-item[data-name="'+aC.name+'"]').length===0){(function(){var aE=new FileReader();aE.addEventListener("load",function(aF){V(aF,aD,aC,ay,aA)});aE.readAsText(aC)})()}}else{console.log("[WGST] File not supported")}});$(".assembly-upload-total-number").text(aw.length);$(".assembly-upload-total-number-label").html((aw.length===1?"assembly":"assemblies"))}};ak.addEventListener("dragover",v,false);ak.addEventListener("drop",p,false);var Y=function(av){if(av===1){$(".nav-prev-item").attr("disabled","disabled");$(".nav-next-item").removeAttr("disabled","disabled")}else{if(av===parseInt($(".total-number-of-dropped-assemblies").text())){$(".nav-next-item").attr("disabled","disabled");$(".nav-prev-item").removeAttr("disabled","disabled")}else{$(".nav-next-item").removeAttr("disabled","disabled");$(".nav-prev-item").removeAttr("disabled","disabled")}}};var af=function(av){$(".selected-assembly-counter").text(av);$(".assembly-item").hide();var ax=$("#assembly-item-"+av);ax.show();var aw=$("#assembly-metadata-item-"+av);aw.show();var ay=$(".assembly-item").eq(av-1).attr("data-name");$(".wgst-panel__assembly-upload-navigator .assembly-file-name").text(ay);$(".wgst-panel__assembly-upload-metadata .header-title small").text(ay);$(".wgst-panel__assembly-upload-analytics .header-title small").text(ay);Y(av);ag=ax.attr("data-name")};var y=function(){var av=$(".wgst-panel__assembly-upload-navigator");av.find(".assembly-sequences-average").text("0");av.find(".assembly-upload-total-number").text("0")};var J=function(){var av=$(".wgst-panel__assembly-upload-progress");av.find(".assemblies-upload-progress .progress-bar").attr("class","progress-bar").attr("aria-valuenow","0");av.find(".assemblies-upload-progress .progress-bar").attr("style","width: 0%");av.find(".assemblies-upload-progress .progress-bar").html("");av.find(".assemblies-upload-progress .assemblies-upload-processed").html("0");av.find(".assembly-list-upload-progress tbody").html("")};var aq=function(){var av=$(".wgst-panel__assembly-upload-metadata");av.find(".assembly-metadata-list-container ul").html("");av.find(".adding-metadata-progress-container .progress-container").show();av.find(".adding-metadata-progress-container .upload-controls-container").hide();av.find(".adding-metadata-progress-container .progress-bar").width("0%");av.find(".adding-metadata-progress-container .progress-bar").attr("aria-valuenow",0);av.find(".adding-metadata-progress-container .progress-percentage").text("0%")};var F=function(){var av=$(".wgst-panel__assembly-upload-analytics");av.find(".assembly-list-container ul").html("")};var x=function(){H={};y();F();aq()};var U=function(){var av=0;$.each($(".assembly-item"),function(aw,ax){av=av+parseInt($(ax).find(".assembly-stats-number-contigs").text(),10)});$(".assembly-sequences-average").text(Math.floor(av/Object.keys(H).length));$(".assembly-upload-total-number").text(Object.keys(H).length)};var A=function(av,aw){af(aw.value)};$(".assembly-list-slider").on("slide",A);$(".assembly-list-slider").on("slidechange",A);$(".nav-prev-item").on("click",function(av){if($(".assembly-list-slider").slider("value")>1){$(".assembly-list-slider").slider("value",$(".assembly-list-slider").slider("value")-1)}av.preventDefault()});$(".nav-next-item").on("click",function(av){if($(".assembly-list-slider").slider("value")<parseInt($(".total-number-of-dropped-assemblies").text(),10)){$(".assembly-list-slider").slider("value",$(".assembly-list-slider").slider("value")+1)}av.preventDefault()});$(".assembly-metadata-list-container").on("click",".not-sure-checkbox",function(){$(this).closest("label").find(".not-sure-hint").toggleClass("hide-this")});var X=function(){var ax=+$(".assembly-sample-datetime-input").length+$(".assembly-sample-location-input").length+$(".assembly-sample-source-input").length;var av=+$(".assembly-sample-datetime-input").filter(function(){return this.value.length!==0}).length+$(".assembly-sample-location-input").filter(function(){return this.value.length!==0}).length+$(".assembly-sample-source-input").filter(function(){return this.value!=="0"}).length;var aw=Math.floor(av*100/ax);$(".adding-metadata-progress-container .progress-bar").width(aw+"%");$(".adding-metadata-progress-container .progress-bar").attr("aria-valuenow",aw);$(".adding-metadata-progress-container .progress-percentage").text(aw+"%");if(aw===100){$(".adding-metadata-progress-container .progress-container").hide();$(".adding-metadata-progress-container .upload-controls-container").show()}};$(".assembly-metadata-list-container").on("change change.dp",".assembly-sample-datetime-input",function(){$(this).closest(".form-block").next(".form-block").fadeIn();$(this).closest(".form-block").next(".form-block").find(".assembly-sample-location-input").focus()});$(".assembly-metadata-list-container").on("change change.dp",".assembly-sample-datetime-input",function(){X()});$(".assembly-metadata-list-container").one("hide.dp",".assembly-sample-datetime-input",function(aw){var av=$(this);setTimeout(function(){av.closest(".assembly-metadata").animate({scrollTop:av.closest(".assembly-metadata").height()},400)},500)});var Q=function(av){console.log(av);if(av.val().length>0){av.closest(".form-block").next(".form-block").fadeIn();av.closest(".assembly-metadata").animate({scrollTop:av.closest(".assembly-metadata").height()},400)}X();$(".adding-metadata-progress-container .progress-hint").fadeOut()};$(".assembly-metadata-list-container").on("change",".assembly-sample-source-input",function(){if($(this).val()!==0){$(this).closest(".form-block").next(".form-block").fadeIn();$(this).closest(".assembly-metadata").animate({scrollTop:$(this).closest(".assembly-metadata").height()},400)}X();$(".adding-metadata-progress-container .progress-hint").fadeOut()});$(".assembly-metadata-list-container").on("click",".assembly-metadata button.next-assembly-button",function(aw){$(".nav-next-item").trigger("click");var av=$(this).closest(".assembly-item").attr("id").replace("assembly-metadata-item-","");$(this).closest(".assembly-metadata-list-container").find('.assembly-metadata-block input:text[value=""]').focus();aw.preventDefault()});var aj=function(ax){var aw=[],av;for(av in ax){if(ax.hasOwnProperty(av)){aw.push({referenceId:ax[av].referenceId,score:ax[av].score})}}aw=aw.sort(function(az,ay){return ay.score-az.score});return aw[0]};var M=function(ax,ay,aw,av){};var K=function(aE,aD,aG,aI){var aB=$('.assembly-list-upload-progress tr[data-assembly-id="'+aD+'"] '),ay=aB.find(".progress-bar"),aF='<span class="glyphicon glyphicon-ok"></span>';if(aI===R.assembly.analysis.UPLOAD_OK){aB.find(".assembly-upload-uploaded").html(aF)}else{if(aI===R.assembly.analysis.MLST_RESULT){aB.find(".assembly-upload-result-mlst").html(aF)}else{if(aI===R.assembly.analysis.PAARSNP_RESULT){aB.find(".assembly-upload-result-paarsnp").html(aF)}else{if(aI===R.assembly.analysis.FP_COMP){aB.find(".assembly-upload-result-fp-comp").html(aF)}}}}if(aI!==R.collection.analysis.COLLECTION_TREE){var ax=Object.keys(R.assembly.analysis).length,aH=100/ax,aA=parseInt(aB.find(".progress-bar").attr("aria-valuenow"),10);ay.css("width",(aA+aH)+"%").attr("aria-valuenow",(aA+aH));if(ay.attr("aria-valuenow")>0){ay.text(ay.attr("aria-valuenow")+"%")}if(ay.attr("aria-valuenow")==="100"){W=W-1;aB.find(".progress").removeClass("active").removeClass("progress-striped");ay.removeClass("progress-bar-info");ay.addClass("progress-bar-success");var az=aB.find(".assembly-upload-name").text();aB.find(".assembly-upload-name").html('<a href="#" class="open-assembly-button" data-assembly-id="'+aG+'">'+az+"</a>");$(".assemblies-upload-processed").text(parseInt($(".assemblies-upload-processed").text(),10)+1)}}var aC=parseFloat($(".assemblies-upload-progress").find(".progress-bar").attr("aria-valuenow")),aw=parseInt($(".assemblies-upload-total").text(),10),ax=Object.keys(R.assembly.analysis).length,aH=0;if(aI===R.collection.analysis.COLLECTION_TREE){if(!R.upload.collection[aE].notifications.tree){aH=10;R.upload.collection[aE].notifications.tree=true}else{aH=0}}else{aH=90/(aw*ax)}var av=(aC+aH).toFixed(2);$(".assemblies-upload-progress").find(".progress-bar").css("width",av+"%");$(".assemblies-upload-progress").find(".progress-bar").attr("aria-valuenow",av);if(av>0){$(".assemblies-upload-progress").find(".progress-bar").text(av+"%")}};R.socket.connection.on("assemblyUploadNotification",function(az){var ay=az.collectionId,ax=az.assemblyId,aA=az.userAssemblyId,av=az.result,aB=Object.keys(H),aw=aB.length*Object.keys(R.assembly.analysis).length+aB.length;console.log("[WGST][Socket.io] Received "+ax+" assembly upload notification: "+av);if(av===R.assembly.analysis.UPLOAD_OK){console.log("[WGST] Successfully uploaded "+ax+" assembly");H[ax].uploaded=true}R.upload.collection[ay].notifications.all.push(ay+"__"+ax+"__"+av);K(ay,aA,ax,av);console.debug("» Received "+R.upload.collection[ay].notifications.all.length+" out of "+aw+" assembly results");if(aw===R.upload.collection[ay].notifications.all.length){$(".assemblies-upload-progress").find(".progress-bar").addClass("progress-bar-success");setTimeout(function(){a("assemblyUploadProgress",function(){x();window.history.replaceState("Object","WGST Collection","/collection/"+ay);w(ay)})},1000)}});var k=function(av){$(".uploading-assembly-progress-container .progress-bar").width("100%");$(".uploading-assembly-progress-container .progress-bar").attr("aria-valuenow",100);$(".uploading-assembly-progress-container .progress-percentage").text("100%");setTimeout(function(){$(".uploading-assembly-progress-container .progress-percentage").text("All done!");$(".uploading-assembly-progress-container .progress").slideUp(function(){})},500)};var G=function(aw){var av=$('[data-fullscreen-name="'+aw+'"]');if(av.hasClass("wgst-fullscreen--active")){return true}else{return false}};var j=function(aw){var av=$('[data-fullscreen-name="'+aw+'"]');if(av.hasClass("wgst-fullscreen--visible")){return true}else{return false}};$('input[type="checkbox"].show-all-assemblies-on-map').on("change",function(av){var aw=$(this).closest(".collection-details").find('.collection-assembly-list .assembly-list-header-map input[type="checkbox"]');if($(this).prop("checked")){aw.prop("checked",true).trigger("change")}else{aw.prop("checked",false).trigger("change")}});$(".wgst-panel__collection .collection-assembly-list").on("change",'input[type="checkbox"]',function(aw){var av=$(this).attr("data-assembly-id");if($(this).is(":checked")){console.log("[WGST] Creating marker for assembly id: "+av);window.WGST.geo.map.markers.assembly[av]=new google.maps.Marker({position:new google.maps.LatLng($(this).attr("data-latitude"),$(this).attr("data-longitude")),map:window.WGST.geo.map.canvas,icon:"http://maps.google.com/mapfiles/ms/icons/green-dot.png",optimized:true});google.maps.event.addListener(window.WGST.geo.map.markers.assembly[av],"click",function(){ae(av)});$(this).closest("tr").addClass("row-highlighted");if(!j("map")){if(!B("map")){o("map");google.maps.event.trigger(R.geo.map.canvas,"resize")}}}else{console.log("[WGST] Removing marker for assembly id: "+av);window.WGST.geo.map.markers.assembly[av].setMap(null);$(this).closest("tr").removeClass("row-highlighted")}window.WGST.geo.map.markerBounds.extend(window.WGST.geo.map.markers.assembly[av].getPosition());window.WGST.geo.map.canvas.panToBounds(window.WGST.geo.map.markerBounds);window.WGST.geo.map.canvas.fitBounds(window.WGST.geo.map.markerBounds);if($(this).closest(".collection-assembly-list").find('input[type="checkbox"]:not(:checked)').length===0){$('input[type="checkbox"].show-all-assemblies-on-map').prop("checked",true)}});$(".collection-assembly-list").on("change",'input[type="radio"]',function(ax){var av=$(this).attr("data-assembly-id"),aw=$(this).closest(".wgst-collection-info").attr("data-collection-id");$(".collection-assembly-list .assembly-list-item.row-selected").removeClass("row-selected");$('.collection-assembly-list .assembly-list-item[data-assembly-id="'+av+'"]').addClass("row-selected");window.WGST.collection[aw].tree.canvas.selectNodes(av);l("collectionTree");ao("collectionTree");m("collectionTree");am("collectionTree")});$(".assemblies-upload-cancel-button").on("click",function(){$(".assembly-upload-panel").hide();H={};ag="";$(".assembly-list-container ul").html("");$(".assembly-metadata-list-container ul").html("");$(".adding-metadata-progress-container .progress-bar").width("0%");$(".adding-metadata-progress-container .progress-bar").attr("aria-valuenow",0);$(".adding-metadata-progress-container .progress-percentage").text("0%");window.WGST.geo.map.markers.metadata.setMap(null)});var W=0,ac=5,al=2000;var r=function(aw,av){if(W<ac){console.log("[WGST] Uploading "+av+" assembly");W=W+1;H[av].socketRoomId=window.WGST.socket.roomId;H[av].assemblyId=av;$.ajax({type:"POST",url:"/assembly/add/",datatype:"json",data:H[av]}).done(function(ay,az,ax){}).fail(function(ax,az,ay){console.log("[WGST][ERROR] Failed to send FASTA file object to server or received error message");console.error(az);console.error(ay);console.error(ax);ab(az)})}else{setTimeout(r,al,aw,av)}};var an=2000;$(".assemblies-upload-ready-button").on("click",function(){console.log("[WGST] Getting ready to upload assemblies and metadata");aq();J();window.WGST.geo.map.markers.metadata.setMap(null);a(["assemblyUploadNavigator","assemblyUploadAnalytics","assemblyUploadMetadata"]);window.WGST.dragAndDrop.files=[];var ay,ax,aw;for(ay in H){if(H.hasOwnProperty(ay)){ax='<tr data-assembly-id="{{userAssemblyId}}"><td class="assembly-upload-name">{{userAssemblyId}}</td><td class="assembly-upload-progress"><div class="progress progress-striped active"><div class="progress-bar progress-bar-info"  role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div></div></td><td class="assembly-upload-result assembly-upload-uploaded"><span class="glyphicon glyphicon-record"></span></td><td class="assembly-upload-result assembly-upload-result-mlst"><span class="glyphicon glyphicon-record"></span></td><td class="assembly-upload-result assembly-upload-result-fp-comp"><span class="glyphicon glyphicon-record"></span></td><td class="assembly-upload-result assembly-upload-result-paarsnp"><span class="glyphicon glyphicon-record"></span></td></tr>';aw=ax.replace(/{{userAssemblyId}}/g,ay);$(".assembly-list-upload-progress tbody").append(aw)}}var av=Object.keys(H).length;$(".wgst-panel__assembly-upload-progress .header-title small").text(av);$(".wgst-panel__assembly-upload-progress .assemblies-upload-total").text(av);l("assemblyUploadProgress",function(){ao("assemblyUploadProgress");var az=$(".wgst-panel__assembly-upload-navigator").attr("data-collection-id");console.log("[WGST] Getting collection id");setTimeout(function(){$.ajax({type:"POST",url:"/collection/add/",datatype:"json",data:{collectionId:az,userAssemblyIds:Object.keys(H)}}).done(function(aI,aC,aF){var aG=aI.collectionId,aA=aI.userAssemblyIdToAssemblyIdMap,aH;R.upload.collection[aG]={};R.upload.collection[aG].notifications={};R.upload.collection[aG].notifications.all=[];R.upload.collection[aG].notifications.tree=false;var aB={};$.each(aA,function(aJ){console.log("==============================================");console.dir(aA);console.log(aJ);var aK=aA[aJ];if(typeof H[aK]!=="undefined"){aB[aJ]=H[aK]}});H=aB;console.dir(H);for(aH in H){if(H.hasOwnProperty(aH)){var aE=H[aH].name;H[aH].collectionId=aG;var aD=$('li[data-name="'+aE+'"] .assembly-sample-location-input');console.debug("userAssemblyId: "+aE);console.dir(window.WGST.upload);H[aH].metadata={datetime:R.upload.assembly[aE].metadata.datetime,geography:{position:{latitude:R.upload.assembly[aE].metadata.geography.position.latitude,longitude:R.upload.assembly[aE].metadata.geography.position.longitude},address:R.upload.assembly[aE].metadata.geography.address},source:R.upload.assembly[aE].metadata.source};console.log("[WGST] Metadata for "+aH+":");console.debug(H[aH].metadata);(function(){console.log("===================================================================");console.log("collectionId: "+aG+" assemblyId: "+aH);console.log("===================================================================");r(aG,aH)})()}}}).fail(function(aA,aC,aB){console.log("[WGST][ERROR] Failed to get collection id");console.error(aC);console.error(aB);console.error(aA);ab(aC)})},an)})});$(".cancel-assembly-upload-button").on("click",function(){$('.assembly-item[data-name="'+ag+'"]').remove();delete H[ag];$(".assembly-list-slider").slider("option","max",Object.keys(H).length);$(".total-number-of-dropped-assemblies").text(Object.keys(H).length);af($(".assembly-list-slider").slider("value"));if(Object.keys(H).length===1){$(".assembly-upload-total-number-label").text("assembly");$(".upload-single-assembly-file-name").text(H[Object.getOwnPropertyNames(H)[0]].name);$(".upload-multiple-assemblies-label").hide();$(".upload-single-assembly-label").show();$(".assembly-navigator").hide()}else{Y($(".assembly-list-slider").slider("value"))}U();X()});$(".wgst-panel").on("mousedown",function(){am($(this).attr("data-panel-name"))});$(".tree-panel .wgst-tree-controls button").on("click",function(){$(this).blur()});$(".wgst-panel__assembly-upload-metadata").on("click",".apply-to-all-assemblies-button",function(){var ax=$(this).closest(".assembly-item").attr("data-name"),az=window.WGST.upload.assembly[ax].metadata;$.each(window.WGST.upload.assembly,function(aA,aB){window.WGST.upload.assembly[aA].metadata=az});var aw=$(this).closest(".assembly-metadata").find(".assembly-sample-datetime-input"),ay=$(this).closest(".assembly-metadata").find(".assembly-sample-location-input"),av=$(this).closest(".assembly-metadata").find(".assembly-sample-source-input");$(".assembly-metadata").find(".assembly-sample-datetime-input").val(aw.val());$(".assembly-metadata").find(".assembly-sample-location-input").val(ay.val());$(".assembly-metadata").find(".assembly-sample-source-input").val(av.val());$(".assembly-metadata-block").show();X()});$(".wgst-panel__collection, .wgst-fullscreen__collection").on("click",".show-on-representative-tree",function(aw){L();var ax=$(this).closest(".wgst-collection-info").attr("data-collection-id"),av=$(this).attr("data-assembly-id"),ay=window.WGST.collection[ax].assemblies[av].FP_COMP.topScore.referenceId;window.WGST.collection.representative.tree.canvas.selectNodes(ay);aw.preventDefault()});$(".wgst-panel__collection, .wgst-panel__assembly-upload-progress, .wgst-fullscreen__collection").on("click",".open-assembly-button",function(aw){var av=$(this).attr("data-assembly-id");if(b("assembly")){a("assembly",function(){$(".wgst-panel__assembly .assembly-details .assembly-detail-content").html("");ae(av)})}else{ae(av)}aw.preventDefault()});$(".wgst-panel__collection .collection-controls-show-tree").on("click",function(){l("collectionTree");ao("collectionTree");m("collectionTree");am("collectionTree")});var ae=function(av){l("assembly");am("assembly");g("assembly");ao("assembly");$.ajax({type:"POST",url:"/api/assembly",datatype:"json",data:{assemblyId:av}}).done(function(aY,aA,aQ){console.log("[WGST] Received data for assembly id: "+av);console.dir(aY);var aO=aY.assembly,aI=$(".wgst-panel__assembly");aI.find(".header-title small").text(aO.ASSEMBLY_METADATA.userAssemblyId);var ax=aY.antibiotics,aT=aO.PAARSNP_RESULT.paarResult.resistanceProfile,aU="",aS="",aD="";for(var aG in ax){if(ax.hasOwnProperty(aG)){aS='<table class="antibiotic-group" data-antibiotic-group-name="{{antibioticGroupName}}"><thead><tr><th>{{antibioticGroupName}}</th></tr></thead><tbody><tr><td><table><tbody><tr>{{antibioticResistancesHtml}}</tr></tbody></table></td></tr></tbody></table>',aw="",aD="";for(var aX in ax[aG]){if(ax[aG].hasOwnProperty(aX)){var aw=aw+"<td>"+aX+"</td>";if(typeof aT[aG]!=="undefined"){if(typeof aT[aG][aX]!=="undefined"){console.log("antibioticName: "+aX);var aF=aT[aG][aX].resistanceState;if(aF==="RESISTANT"){aD=aD+'<td><div class="antibiotic resistance-fail" data-antibiotic-name="'+aX+'" data-antibiotic-resistance-state="'+aF+'" data-toggle="tooltip" data-placement="top" title="'+aX+'">'+aX+"</div></td>"}else{if(aF==="SENSITIVE"){aD=aD+'<td><div class="antibiotic resistance-success" data-antibiotic-name="'+aX+'" data-antibiotic-resistance-state="'+aF+'" data-toggle="tooltip" data-placement="top" title="'+aX+'">'+aX+"</div></td>"}else{aD=aD+'<td><div class="antibiotic resistance-unknown" data-antibiotic-name="'+aX+'" data-antibiotic-resistance-state="'+aF+'" data-toggle="tooltip" data-placement="top" title="'+aX+'">'+aX+"</div></td>"}}}else{aD=aD+'<td><div class="antibiotic resistance-unknown" data-antibiotic-name="'+aX+'" data-antibiotic-resistance-state="'+aF+'" data-toggle="tooltip" data-placement="top" title="'+aX+'">'+aX+"</div></td>";console.log(">>> Assembly resistance profile has no antibiotic: "+aX)}}else{aD=aD+'<td><div class="antibiotic resistance-unknown" data-antibiotic-name="'+aX+'" data-antibiotic-resistance-state="'+aF+'" data-toggle="tooltip" data-placement="top" title="'+aX+'">'+aX+"</div></td>";console.log(">>> Assembly resistance profile has no antibiotic group: "+aG)}}}aS=aS.replace(/{{antibioticGroupName}}/g,aG);aS=aS.replace(/{{antibioticResistancesHtml}}/,aD);aU=aU+aS}}$(".wgst-panel__assembly .assembly-detail__resistance-profile .assembly-detail-content").html($(aU));if(aO.MLST_RESULT.stType.length===0){$(".wgst-panel__assembly .assembly-detail__st-type .assembly-detail-content").html("Not found")}else{$(".wgst-panel__assembly .assembly-detail__st-type .assembly-detail-content").html(aO.MLST_RESULT.stType)}var aK=aO.MLST_RESULT.alleles,az,aB,aV='<table><tbody><tr><td class="row-title">Locus Id</td>{{locusIds}}</tr><tr><td class="row-title">Allele Id</td>{{alleleIds}}</tr></tbody></table>',aW="",ay="";console.debug("assemblyAlleles:");console.dir(aK);for(aB in aK){if(aK.hasOwnProperty(aB)){az=aK[aB];if(az===null){aW=aW+"<td>None</td>";ay=ay+"<td>"+aB+"</td>"}else{aW=aW+"<td>"+aK[aB].locusId+"</td>";ay=ay+"<td>"+aK[aB].alleleId+"</td>"}}}aV=aV.replace("{{locusIds}}",aW);aV=aV.replace("{{alleleIds}}",ay);$(".wgst-panel__assembly .assembly-detail__mlst .assembly-detail-content").html($(aV));var aH=aO.FP_COMP.scores,aL=aj(aH);$(".wgst-panel__assembly .assembly-detail__nearest-representative .assembly-detail-content").text(aL.referenceId);var aM="<table><thead><tr><th>Reference Id</th><th>Score</th></tr></thead><tbody>{{assemblyScoresDataHtml}}</tbody></table>",aR="",aE;var aN=Object.keys(aH).sort(function(a0,aZ){return aH[a0]-aH[aZ]});var aC=aN.length;for(;aC!==0;){aC=aC-1;var aJ=aN[aC],aP=aH[aJ],aE=aP.score.toFixed(2)+" = "+Math.round(aP.score*parseInt(aO.FP_COMP["fingerprintSize"],10))+"/"+aO.FP_COMP["fingerprintSize"];aR=aR+"<tr><td>"+aP.referenceId+"</td><td>"+aE+"</td></tr>"}aM=aM.replace("{{assemblyScoresDataHtml}}",aR);$(".wgst-panel__assembly .assembly-detail__score .assembly-detail-content").html(aM);$(".wgst-panel__assembly .wgst-panel-loading").hide()}).fail(function(aw,ay,ax){console.log("[WGST][ERROR] Failed to get assembly data");console.error(ay);console.error(ax);console.error(aw);ab(ay)})};$(".wgst-tree-control__decrease-label-font-size").on("click",function(){var av=$(this).closest(".wgst-panel").attr("data-collection-id"),aw=R.collection[av].tree.canvas.textSize;R.collection[av].tree.canvas.setTextSize(aw-3)});$(".wgst-tree-control__increase-label-font-size").on("click",function(){var av=$(this).closest(".wgst-panel").attr("data-collection-id"),aw=R.collection[av].tree.canvas.textSize;R.collection[av].tree.canvas.setTextSize(aw+3)});$(".wgst-tree-control__decrease-node-size").on("click",function(){var aw=$(this).closest(".wgst-panel").attr("data-collection-id"),av=R.collection[aw].tree.canvas.baseNodeSize;R.collection[aw].tree.canvas.setNodeSize(av-3)});$(".wgst-tree-control__increase-node-size").on("click",function(){var aw=$(this).closest(".wgst-panel").attr("data-collection-id"),av=R.collection[aw].tree.canvas.baseNodeSize;R.collection[aw].tree.canvas.setNodeSize(av+3)});$(".wgst-tree-control__show-node-labels").on("change",function(){var av=$(this).closest(".wgst-panel").attr("data-collection-id");R.collection[av].tree.canvas.toggleLabels()});var N=function(){console.log("[WGST] Rendering representative collection tree");var av="representative";$(".wgst-panel__representative-collection-tree .wgst-tree-content").html("");$(".wgst-panel__representative-collection-tree .wgst-tree-content").attr("id","phylocanvas_"+av);R.collection.representative.tree.canvas=new PhyloCanvas.Tree($('[data-panel-name="representativeCollectionTree"] .wgst-tree-content')[0]);R.collection.representative.tree.canvas.load("/data/reference_tree.nwk");R.collection.representative.tree.canvas.treeType="rectangular"};var L=function(){console.log("[WGST] Opening representative collection tree");var av="representative";$(".wgst-panel__representative-collection-tree").attr("data-collection-id",av);l("representativeCollectionTree");T("representativeCollectionTree");m("representativeCollectionTree");ao("representativeCollectionTree");am("representativeCollectionTree")};$(".wgst-navigation-item").on("click",function(av){av.preventDefault()});$(".wgst-navigation-item__map").on("click",function(){var av=$(".wgst-fullscreen--active");if(av.attr("data-fullscreen-name")==="map"){E(false)}o("map");google.maps.event.trigger(R.geo.map.canvas,"resize")});$(".wgst-navigation-item__representative-tree").on("click",function(){L()});$(".wgst-navigation-item__collection").on("click",function(){if(z("collection")){var av=$(".wgst-fullscreen--active");if(av.attr("data-fullscreen-name")==="collection"){E(false)}o("collection")}});google.maps.event.addDomListener(window,"resize",function(){var aw=R.geo.map.canvas;var av=aw.getCenter();google.maps.event.trigger(aw,"resize");aw.setCenter(av)});var ad=function(av){console.log("[WGST] Maximizing collection "+av);$('[data-toggle="tooltip"]').tooltip("destroy");$(".wgst-fullscreen__collection").append($(".collection-details").clone(true)).addClass("wgst-fullscreen--active").addClass("wgst-fullscreen--visible");a("collection");google.maps.event.trigger(R.geo.map.canvas,"resize");$('[data-toggle="tooltip"]').tooltip()};var E=function(ax,ay){var aw=$(".wgst-fullscreen--active"),av=aw.attr("data-fullscreen-name");aw.removeClass("wgst-fullscreen--active").removeClass("wgst-fullscreen--visible");if(typeof av!=="undefined"){if(ax){m(av);ao(av)}}if(av==="map"){$('.wgst-panel[data-panel-name="'+av+'"] .wgst-panel-body-content').html("").append(R.geo.map.canvas.getDiv());google.maps.event.trigger(R.geo.map.canvas,"resize")}aw.html("");if(typeof ay==="function"){ay()}};var c=function(aw,ay){var av=$('[data-panel-id="'+aw+'"]'),ax=av.attr("data-panel-name");$('[data-fullscreen-name="'+ax+'"]').addClass("wgst-fullscreen--active").addClass("wgst-fullscreen--visible");a(ax);if(typeof ay==="function"){ay()}};var h=function(aw,av){if(!G(aw)){E(false);c(av,function(){$('[data-fullscreen-name="'+aw+'"]').html("").append(R.geo.map.canvas.getDiv());google.maps.event.trigger(R.geo.map.canvas,"resize")})}};$("body").on("click",".wgst-panel-control-button__maximize",function(){if($(this).hasClass("wgst-panel-control-button--active")){var av=$(this).closest(".wgst-panel"),ax=av.attr("data-panel-name"),aw=av.attr("data-panel-id");if(ax==="collection"){$('[data-toggle="tooltip"]').tooltip("destroy");E(false);c(aw,function(){$('[data-fullscreen-name="'+ax+'"]').html("").append($(".collection-details").clone(true));$('[data-toggle="tooltip"]').tooltip()})}else{if(ax==="map"){h(ax,aw)}else{if(ax==="collectionTree"){c(ax,function(){var aA=$(".wgst-panel__collection-tree").find(".wgst-tree-content"),ay=$(".wgst-fullscreen__collection-tree");ay.append(aA.clone(true));var az=$(".wgst-panel__collection-tree").attr("data-collection-id");$(".wgst-panel__collection-tree").html("");console.log(az);R.collection[az].tree.canvas.draw()})}}}}});$("body").on("click",".wgst-panel-control-button__close",function(){if($(this).hasClass("wgst-panel-control-button--active")){var av=$(this).closest(".wgst-panel"),aw=av.attr("data-panel-name");a(aw,function(){if(aw==="collection"){var ax=av.attr("data-collection-id");t(ax)}else{if(aw==="representativeCollectionTree"){var ax=av.attr("data-collection-id");I(ax)}}})}});$("body").on("click",".wgst-panel-control-button__opacity",function(){if($(this).hasClass("wgst-panel-control-button--active")){var av=$(this).closest(".wgst-panel");if(av.css("opacity")!=="1"){av.css("opacity","1")}else{av.css("opacity","0.85")}}});var ai=function(aH){var av=$(aH),aJ=av.offset(),aI=av.closest(".wgst-panel").attr("data-collection-id"),aK=window.WGST.collection[aI].tree.canvas,aE=aK.leaves,aw={top:aK.translateClickY(aJ.top),left:aK.translateClickX(aJ.left)},aG={bottom:aK.translateClickY(aJ.top+av.height()),right:aK.translateClickX(aJ.left+av.width())},aD=$(".collection-assembly-list"),ay=$(".collection-assembly-list-full");var ax=document.createDocumentFragment(),aA,aC=0,aF,aB=0;for(;aB<aE.length;){aF=aE[aB];if(aF.centerx>=aw.left&&aF.centerx<=aG.right&&aF.centery>=aw.top&&aF.centery<=aG.bottom){aA=ay.find('.assembly-list-item[data-assembly-id="'+aF.id+'"]')[0];ax.appendChild(aA.cloneNode(true));aC=aC+1}aB=aB+1}if(aC>7){$(".collection-assembly-list-more-assemblies").show()}else{$(".collection-assembly-list-more-assemblies").hide()}var az=aD[0];while(az.firstChild){az.removeChild(az.firstChild)}az.appendChild(ax);aD.find('.antibiotic[data-toggle="tooltip"]').tooltip()};$(".collection-assembly-list-view-all-assemblies").on("click",function(ax){var aw=$(this).closest(".wgst-panel").attr("data-collection-id"),av=$(".collection-assembly-list");window.WGST.collection[aw].tree.canvas.redrawOriginalTree();window.WGST.collection[aw].tree.canvas.setZoom(-0.05);av.find(".assembly-list-item").remove();av.append($(".collection-assembly-list-full .assembly-list-item").clone());av.find('.antibiotic[data-toggle="tooltip"]').tooltip();$(".collection-assembly-list-all-assemblies").hide();$(".collection-assembly-list-more-assemblies").show();ax.preventDefault()});$(".tree-controls-match-assembly-list").on("click",function(){var av=$(this).closest(".wgst-panel-body-content").find("canvas.phylocanvas");ai(av)})});