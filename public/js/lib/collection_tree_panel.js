$(function(){!function(){$(".tree-controls-show-labels").on("click",function(){var e=$(this).closest("[data-collection-tree-content]").attr("data-collection-id");WGST.collection[e].tree.CORE_TREE_RESULT.canvas.displayLabels()}),$(".tree-controls-hide-labels").on("click",function(){var e=$(this).closest("[data-collection-tree-content]").attr("data-collection-id");WGST.collection[e].tree.CORE_TREE_RESULT.canvas.hideLabels()}),$("body").on("change",".wgst-tree-control__change-node-label",function(){var e,o=$(this),n=o.closest("[data-collection-tree-content]").attr("data-collection-id"),c=o.closest("[data-collection-tree-content]").attr("data-collection-tree-type"),a=WGST.collection[n].tree[c].canvas,l=WGST.collection[n].assemblies;if("1"===o.val())for(e in l)l.hasOwnProperty(e)&&a.branches[e]&&a.branches[e].leaf&&(a.branches[e].label=l[e].ASSEMBLY_METADATA.userAssemblyId);else if("2"===o.val())for(e in l)l.hasOwnProperty(e)&&a.branches[e]&&a.branches[e].leaf&&(a.branches[e].label=WGST.collection[n].assemblies[e].FP_COMP.topScore.referenceId);else if("3"===o.val())for(e in l)l.hasOwnProperty(e)&&a.branches[e]&&a.branches[e].leaf&&(a.branches[e].label=0===l[e].MLST_RESULT.stType.length?"Not found":l[e].MLST_RESULT.stType);else if("4"===o.val()){var s,i;for(e in l)l.hasOwnProperty(e)&&(s=l[e].PAARSNP_RESULT.paarResult.resistanceProfile,i=t(s,WGST.antibiotics),a.branches[e]&&a.branches[e].leaf&&(a.branches[e].label=i))}else if("5"===o.val())for(e in l)l.hasOwnProperty(e)&&a.branches[e]&&a.branches[e].leaf&&(a.branches[e].label=l[e].ASSEMBLY_METADATA.geography.address);a.draw()}),$("body").on("change",".wgst-tree-control__change-node-colour",function(){var e,t=$(this).find("option:selected"),o=t.closest("[data-collection-tree-content]").attr("data-collection-id"),n=t.closest("[data-collection-tree-content]").attr("data-collection-tree-type"),c=WGST.collection[o].tree[n].canvas,a=WGST.collection[o].assemblies;if("0"===t.val())for(e in a)a.hasOwnProperty(e)&&c.setNodeColourAndShape(e,"#ffffff");else{var l,s;for(e in a)a.hasOwnProperty(e)&&(l=a[e].PAARSNP_RESULT.paarResult.ungroupedResistanceProfile,s=l[t.text()],"undefined"!=typeof s?c.branches[e]&&c.branches[e].leaf&&("RESISTANT"===s.resistanceState?c.setNodeColourAndShape(e,"#ff0000"):"SENSITIVE"===s.resistanceState?c.setNodeColourAndShape(e,"#4dbd33"):"UNKNOWN"===s.resistanceState&&c.setNodeColourAndShape(e,"#ffffff")):c.branches[e]&&c.branches[e].leaf&&c.setNodeColourAndShape(e,"#ffffff"))}}),$("body").on("change",".wgst-tree-control__change-tree-type",function(){var e,t=$(this).find("option:selected"),o=t.closest("[data-collection-tree-content]").attr("data-collection-id"),n=t.closest("[data-collection-tree-content]").attr("data-collection-tree-type");e=window.WGST.collection[o].tree[n].canvas,e.setTreeType(t.val())}),$("body").on("click",".wgst-tree-control__show-newick",function(){var e,t,o=$(this).closest("[data-collection-tree-content]").attr("data-collection-id"),n=$(this).closest("[data-collection-tree-content]").attr("data-collection-tree-type");e=WGST.collection[o].tree[n].newickStringWithLabels,t=window.open(),t.document.write(e)}),$("body").on("click",".wgst-tree-control__decrease-label-font-size",function(){var e,t,o=$(this).closest("[data-collection-tree-content]").attr("data-collection-id"),n=$(this).closest("[data-collection-tree-content]").attr("data-collection-tree-type");t=WGST.collection[o].tree[n].canvas,e=t.textSize,t.setTextSize(e-3)}),$("body").on("click",".wgst-tree-control__increase-label-font-size",function(){var e,t,o=$(this).closest("[data-collection-tree-content]").attr("data-collection-id"),n=$(this).closest("[data-collection-tree-content]").attr("data-collection-tree-type");t=WGST.collection[o].tree[n].canvas,e=t.textSize,t.setTextSize(e+3)}),$("body").on("click",".wgst-tree-control__decrease-node-size",function(){var e,t,o=$(this).closest("[data-collection-tree-content]").attr("data-collection-id"),n=$(this).closest("[data-collection-tree-content]").attr("data-collection-tree-type");e=WGST.collection[o].tree[n].canvas,t=e.baseNodeSize,t>3?(e.setNodeSize(t-3),t=e.baseNodeSize,3>t&&$(this).attr("disabled",!0)):$(this).attr("disabled",!0)}),$("body").on("click",".wgst-tree-control__increase-node-size",function(){var e,t,o=$(this).closest("[data-collection-tree-content]").attr("data-collection-id"),n=$(this).closest("[data-collection-tree-content]").attr("data-collection-tree-type");e=WGST.collection[o].tree[n].canvas,t=e.baseNodeSize,e.setNodeSize(t+3),e.baseNodeSize>3&&$(this).closest(".wgst-tree-control").find(".wgst-tree-control__decrease-node-size").attr("disabled",!1)}),$("body").on("change",".wgst-tree-control__show-node-labels",function(){var e,t=$(this).closest("[data-collection-tree-content]").attr("data-collection-id"),o=$(this).closest("[data-collection-tree-content]").attr("data-collection-tree-type");e=WGST.collection[t].tree[o].canvas,e.toggleLabels()}),window.WGST.socket.connection.on("collectionTreeMergeNotification",function(e){if(console.log("[WGST] Received merged tree notification"),WGST.speak){var t=new SpeechSynthesisUtterance("Merged collections");window.speechSynthesis.speak(t)}var o=e.mergedCollectionTreeId,n=e.tree,c=e.assemblies,a=[];a=c.map(function(e){return e.assemblyId}),console.log("[WGST] Getting merged collection assemblies"),console.dir(a),$.ajax({type:"POST",url:"/api/assemblies/",datatype:"json",data:{assemblyIds:a}}).done(function(e){console.log("[WGST] Got merged collection assemblies"),console.dir(e),window.WGST.exports.setCollectionData(o,e,n),window.WGST.exports.renderCollectionTrees(o,{matchAssemblyListButton:!0,mergeWithButton:!0,panelLabel:"Merge Tree"});var t,c,a;for(t in window.WGST.collection[o].assemblies)WGST.collection[o].assemblies.hasOwnProperty(t)&&(c=window.WGST.collection[o].assemblies[t],a=c.FP_COMP.scores,window.WGST.collection[o].assemblies[t].FP_COMP.topScore=window.WGST.exports.calculateAssemblyTopScore(a));window.WGST.exports.addResistanceProfileDataToCollection(o),window.WGST.exports.populateListOfAntibiotics($("#select-tree-node-antibiotic-merged")),function(){var e=$(".wgst-tree-control__merge-collection-trees");e.find(".wgst-spinner").addClass("wgst--hide-this"),e.find(".wgst-spinner-label").removeClass("wgst--hide-this"),e.attr("disabled",!1)}();var l="MERGED",s="collection-tree__"+o+"__"+l;window.WGST.exports.showPanel(s),window.WGST.exports.bringPanelToFront(s)}).fail(function(e,t,o){console.error("[WGST][Error] ✗ Failed to get assemblies"),console.error(t),console.error(o),console.error(e)})}),$("body").on("click",".wgst-tree-control__merge-collection-trees",function(){var t=$(this);t.attr("disabled",!0),t.find(".wgst-spinner-label").addClass("wgst--hide-this"),t.find(".wgst-spinner").removeClass("wgst--hide-this");var o={"5324c298-4cd0-4329-848b-30d7fe28a560":"ab66c759-2242-42c2-a245-d364fcbc7c4f","c0ca8c57-11b9-4e27-93a5-6ffe841e7768":"2b3ad477-323c-4c54-b6f2-abc420ba0399"},n=$(this).closest("[data-collection-tree-content]").attr("data-collection-id");if(o.hasOwnProperty(n))return e(o[n]),void 0;var c={collectionId:t.closest("[data-collection-tree-content]").attr("data-collection-id"),mergeWithCollectionId:window.WGST.settings.referenceCollectionId,collectionTreeType:t.attr("data-collection-tree-type"),socketRoomId:WGST.socket.roomId};console.log("[WGST] Requesting to merge collection trees: "+c.collectionId+", "+c.mergeWithCollectionId),$.ajax({type:"POST",url:"/api/collection/tree/merge",datatype:"json",data:c}).done(function(){console.log("[WGST] Requested to merge collection trees: "+c.collectionId+", "+c.mergeWithCollectionId)})});var e=function(e){var t=$(this);t.attr("disabled",!0),t.find(".wgst-spinner-label").addClass("wgst--hide-this"),t.find(".wgst-spinner").removeClass("wgst--hide-this");var o={mergeTreeId:e,socketRoomId:WGST.socket.roomId};console.log("[WGST] Requesting merge tree"),$.ajax({type:"POST",url:"/api/collection/merged",datatype:"json",data:o}).done(function(){console.log("[WGST] Requested merge tree")})},t=function(e,t){var o,n,c,a,l,s,i,r="";for(n in t)if(t.hasOwnProperty(n)){o=t[n],c="  ",s="";for(a in o)o.hasOwnProperty(a)&&(l="","undefined"!=typeof e[n]?"undefined"!=typeof e[n][a]?(i=e[n][a].resistanceState,l+="RESISTANT"===i?"⦿":"SENSITIVE"===i?"○":"○"):l+="○":l+="○",s+=l);c+=s,r+=c}return r}}()});