$(function(){!function(){$(".tree-controls-show-labels").on("click",function(){var e=$(this).closest(".wgst-panel").attr("data-collection-id");WGST.collection[e].tree.CORE_TREE_RESULT.canvas.displayLabels()}),$(".tree-controls-hide-labels").on("click",function(){var e=$(this).closest(".wgst-panel").attr("data-collection-id");WGST.collection[e].tree.CORE_TREE_RESULT.canvas.hideLabels()}),$("body").on("change",".wgst-tree-control__change-node-label",function(){var e,t=$(this),n=t.closest(".wgst-panel").attr("data-collection-id"),s=t.closest(".wgst-panel").attr("data-collection-tree-type"),a=WGST.collection[n].tree[s].canvas,l=WGST.collection[n].assemblies;if("1"===t.val())for(e in l)l.hasOwnProperty(e)&&a.branches[e]&&a.branches[e].leaf&&(a.branches[e].label=l[e].ASSEMBLY_METADATA.userAssemblyId);else if("2"===t.val())for(e in l)l.hasOwnProperty(e)&&a.branches[e]&&a.branches[e].leaf&&(a.branches[e].label=WGST.collection[n].assemblies[e].FP_COMP.topScore.referenceId);else if("3"===t.val())for(e in l)l.hasOwnProperty(e)&&a.branches[e]&&a.branches[e].leaf&&(a.branches[e].label=0===l[e].MLST_RESULT.stType.length?"Not found":l[e].MLST_RESULT.stType);else if("4"===t.val()){var r,c;for(e in l)l.hasOwnProperty(e)&&(r=l[e].PAARSNP_RESULT.paarResult.resistanceProfile,c=o(r,WGST.antibiotics),a.branches[e]&&a.branches[e].leaf&&(a.branches[e].label=c))}else if("5"===t.val())for(e in l)l.hasOwnProperty(e)&&a.branches[e]&&a.branches[e].leaf&&(a.branches[e].label=l[e].ASSEMBLY_METADATA.geography.address);a.draw()}),$("body").on("change",".wgst-tree-control__change-node-colour",function(){var e,o=$(this).find("option:selected"),t=o.closest(".wgst-panel").attr("data-collection-id"),n=o.closest(".wgst-panel").attr("data-collection-tree-type"),s=WGST.collection[t].tree[n].canvas,a=WGST.collection[t].assemblies;if("0"===o.val())for(e in a)a.hasOwnProperty(e)&&s.setNodeColourAndShape(e,"#ffffff");else{var l,r;for(e in a)a.hasOwnProperty(e)&&(l=a[e].PAARSNP_RESULT.paarResult.ungroupedResistanceProfile,r=l[o.text()],"undefined"!=typeof r?s.branches[e]&&s.branches[e].leaf&&("RESISTANT"===r.resistanceState?s.setNodeColourAndShape(e,"#ff0000"):"SENSITIVE"===r.resistanceState?s.setNodeColourAndShape(e,"#4dbd33"):"UNKNOWN"===r.resistanceState&&s.setNodeColourAndShape(e,"#ffffff")):s.branches[e]&&s.branches[e].leaf&&s.setNodeColourAndShape(e,"#ffffff"))}}),$("body").on("change",".wgst-tree-control__change-tree-type",function(){var e,o=$(this).find("option:selected"),t=o.closest(".wgst-panel").attr("data-collection-id"),n=o.closest(".wgst-panel").attr("data-collection-tree-type");console.debug("$$$ collectionId: "+t),console.debug("$$$ collectionTreeType: "+n),e=window.WGST.collection[t].tree[n].canvas,e.setTreeType(o.val())}),window.WGST.socket.connection.on("collectionTreeMergeNotification",function(e){if(console.log("[WGST] Received merged tree notification"),WGST.speak){var o=new SpeechSynthesisUtterance("Merged collections");window.speechSynthesis.speak(o)}console.debug("mergedCollectionTreeData:"),console.dir(e);var t=e.mergedCollectionTreeId,n=e.tree,s=e.assemblies,a=[];a=s.map(function(e){return e.assemblyId}),console.log("[WGST] Getting merged collection assemblies"),console.dir(a),$.ajax({type:"POST",url:"/api/assemblies/",datatype:"json",data:{assemblyIds:a}}).done(function(e){console.log("[WGST] Got merged collection assemblies"),console.dir(e),window.WGST.exports.setCollectionData(t,e,n),window.WGST.exports.renderCollectionTrees(t,{matchAssemblyListButton:!0,mergeWithButton:!0});var o,s,a;for(o in window.WGST.collection[t].assemblies)WGST.collection[t].assemblies.hasOwnProperty(o)&&(s=window.WGST.collection[t].assemblies[o],a=s.FP_COMP.scores,window.WGST.collection[t].assemblies[o].FP_COMP.topScore=window.WGST.exports.calculateAssemblyTopScore(a));window.WGST.exports.addResistanceProfileDataToCollection(t),window.WGST.exports.populateListOfAntibiotics($("#select-tree-node-antibiotic-merged")),function(){var e=$(".wgst-tree-control__merge-collection-trees");e.find(".wgst-spinner").addClass("wgst--hide-this"),e.find(".wgst-spinner-label").removeClass("wgst--hide-this"),e.attr("disabled",!1)}();var l="MERGED",r="collection-tree__"+t+"__"+l;window.WGST.exports.showPanel(r),window.WGST.exports.bringPanelToFront(r)}).fail(function(e,o,t){console.error("[WGST][Error] ✗ Failed to get assemblies"),console.error(o),console.error(t),console.error(e)})}),$("body").on("click",".wgst-tree-control__merge-collection-trees",function(){var o=$(this);o.attr("disabled",!0),o.find(".wgst-spinner-label").addClass("wgst--hide-this"),o.find(".wgst-spinner").removeClass("wgst--hide-this");var t={"5324c298-4cd0-4329-848b-30d7fe28a560":"ab66c759-2242-42c2-a245-d364fcbc7c4f","c0ca8c57-11b9-4e27-93a5-6ffe841e7768":"2b3ad477-323c-4c54-b6f2-abc420ba0399"},n=$(this).closest(".wgst-panel").attr("data-collection-id");if(t.hasOwnProperty(n))return e(t[n]),void 0;var s={collectionId:o.closest(".wgst-panel").attr("data-collection-id"),mergeWithCollectionId:"b8d3aab1-625f-49aa-9857-a5e97f5d6be5",collectionTreeType:o.attr("data-collection-tree-type"),socketRoomId:WGST.socket.roomId};console.log("[WGST] Requesting to merge collection trees: "+s.collectionId+", "+s.mergeWithCollectionId),$.ajax({type:"POST",url:"/api/collection/tree/merge",datatype:"json",data:s}).done(function(){console.log("[WGST] Requested to merge collection trees: "+s.collectionId+", "+s.mergeWithCollectionId)})});var e=function(e){var o=$(this);o.attr("disabled",!0),o.find(".wgst-spinner-label").addClass("wgst--hide-this"),o.find(".wgst-spinner").removeClass("wgst--hide-this");var t={mergeTreeId:e,socketRoomId:WGST.socket.roomId};console.log("[WGST] Requesting merge tree"),$.ajax({type:"POST",url:"/api/collection/merged",datatype:"json",data:t}).done(function(){console.log("[WGST] Requested merge tree")})},o=function(e,o){var t,n,s,a,l,r,c,i="";for(n in o)if(o.hasOwnProperty(n)){t=o[n],s="  ",r="";for(a in t)t.hasOwnProperty(a)&&(l="","undefined"!=typeof e[n]?"undefined"!=typeof e[n][a]?(c=e[n][a].resistanceState,l+="RESISTANT"===c?"⦿":"SENSITIVE"===c?"○":"○"):l+="○":l+="○",r+=l);s+=r,i+=s}return i}}()});