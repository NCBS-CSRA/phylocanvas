$(function(){!function(){window.WGST.exports.mapCollectionIdToCollectionName={"5324c298-4cd0-4329-848b-30d7fe28a560":"EMRSA15","c0ca8c57-11b9-4e27-93a5-6ffe841e7768":"ST239","b8d3aab1-625f-49aa-9857-a5e97f5d6be5":"Reference"},window.WGST.exports.initCollectionDataStructure=function(e,t){WGST.collection[e]={assemblies:{},tree:{}},$.isArray(t)&&t.forEach(function(t){window.WGST.collection[e].tree[t]={}})},window.WGST.exports.setCollectionData=function(e,t,o){window.WGST.exports.initCollectionDataStructure(e),window.WGST.collection[e].assemblies=t,$.each(o,function(t,o){window.WGST.collection[e].tree[t]={type:t,data:o.data,name:o.name}})};var e=function(e){var t=window.WGST.collection[e].assemblies,o=[],a=[],s="COLLECTION_TREE",i=window.WGST.collection[e].tree[s];$.each(i.leavesOrder,function(e,s){o.push(t[s.id]),a.push(s.id)}),window.WGST.collection[e].sortedAssemblyIds=a};window.WGST.exports.getCollection=function(o){if(console.log("[WGST] Getting collection "+o),window.WGST.speak){var a=new SpeechSynthesisUtterance("Loading collection");window.speechSynthesis.speak(a)}window.WGST.exports.showBackground("get-collection"),$.ajax({type:"POST",url:"/collection/",datatype:"json",data:{collectionId:o}}).done(function(a){if(console.log("[WGST] Got collection "+o+" data"),Object.keys(a).length>0){console.log("[WGST] Collection "+o+" has "+Object.keys(a.collection.assemblies).length+" assemblies"),window.WGST.antibiotics=a.antibiotics,window.WGST.exports.setCollectionData(o,a.collection.assemblies,a.collection.tree);{var s=window.WGST.exports.createCollectionDataPanel(o);$('.wgst-panel[data-panel-id="'+s+'"]')}window.WGST.exports.createFullscreen("collection-map",{fullscreenId:"collection-map",fullscreenType:"collection-map"}),window.WGST.exports.showFullscreen("collection-map"),window.WGST.geo.map.init(),window.WGST.exports.bringPanelToFront(s),window.WGST.exports.renderCollectionTrees(o),window.WGST.exports.renderCollectionTreeButtons(o,s),window.WGST.exports.addResistanceProfileDataToCollection(o),e(o),window.WGST.exports.renderAssemblyAnalysisList(o,s,WGST.antibiotics),window.WGST.exports.showPanel(s),"undefined"!=typeof window.WGST.exports.mapCollectionIdToCollectionName[o]?$(".wgst-header-collection-name").text(window.WGST.exports.mapCollectionIdToCollectionName[o]):$(".wgst-header-collection-name").text(o),Object.keys(window.WGST.collection[o].assemblies).length>100&&(console.log("[WGST] Collection "+o+" will be displayed fullscreen"),t(o)),window.history.replaceState("Object","WGST Collection","/collection/"+o),window.WGST.exports.hideBackground("get-collection")}}).fail(function(e,t,o){console.log("[WGST][ERROR] Failed to get collection id"),console.error(t),console.error(o),console.error(e),showNotification(t)})};window.WGST.exports.addResistanceProfileDataToCollection=function(e){var t,o,a,s,i,n,l={};for(t in WGST.collection[e].assemblies){o=WGST.collection[e].assemblies[t],l=o.PAARSNP_RESULT.paarResult.resistanceProfile,i={};for(a in l){s=l[a];for(n in s)i[n]=s[n]}WGST.collection[e].assemblies[t].PAARSNP_RESULT.paarResult.ungroupedResistanceProfile=i}},window.WGST.exports.renderAssemblyAnalysisList=function(e,t){console.log("[WGST] Rendering assembly analysis list");var o,a,s=window.WGST.collection[e].assemblies,i=window.WGST.collection[e].sortedAssemblyIds,n=i.map(function(e){return o=s[e],a=window.WGST.exports.prepareAssemblyDataForRendering(o,window.WGST.antibiotics),{assemblyId:e,assemblyUserId:a.assemblyUserId,antibioticResistanceData:a.resistanceProfile,sequenceTypeData:a.sequenceType,mlstData:a.mlst,nearestRepresentativeData:a.nearestRepresentative,scoresData:a.scores,topScore:a.topScore,topScorePercentage:a.topScorePercentage,metadata:{latitude:a.metadata.latitude,longitude:a.metadata.longitude}}}),l={collectionId:e,assemblies:n};console.log(">>> !!! templateContext:"),console.dir(l);var c=$('.wgst-template[data-template-id="panel-body__collection-data__assemblies"]').html(),d=Handlebars.compile(c),r=$('.wgst-template[data-template-id="panel-body__collection-data__assemblies__assembly"]').html();Handlebars.registerPartial("assembly",r);var p=d(l),m=$('.wgst-panel[data-panel-id="'+t+'"]'),w=m.find(".wgst-panel-body-container");w.prepend(p),$(".wgst-assembly-show-on-map").prop("checked",!0).change()},window.WGST.exports.__old_remove__renderAssemblyAnalysisList=function(e,t,o){console.log("[WGST] Rendering assembly analysis list");for(var a,s,i,n,l,c,d,r=WGST.collection[e].assemblies,p=WGST.collection[e].sortedAssemblyIds,m=0,w=$('.wgst-panel[data-panel-id="'+t+'"]'),b=w.find(".collection-assembly-list"),S=w.find(".collection-assembly-list-full"),T=document.createDocumentFragment();m<p.length;)a=p[m],s=r[a].PAARSNP_RESULT.paarResult.resistanceProfile,i=window.WGST.exports.createAssemblyResistanceProfilePreviewHtml(s,o),n=window.WGST.exports.calculateAssemblyTopScore(r[a].FP_COMP.scores),WGST.collection[e].assemblies[a].FP_COMP.topScore=n,l=r[a].ASSEMBLY_METADATA.geography.position.latitude,c=r[a].ASSEMBLY_METADATA.geography.position.longitude,d=$((m%2===0?'<div class="row-stripe assembly-list-item" data-assembly-id="'+r[a].FP_COMP.assemblyId+'">':'<div class="assembly-list-item" data-assembly-id="'+r[a].FP_COMP.assemblyId+'">')+'<div class="show-on-map-checkbox assembly-list-header-map"><input type="checkbox" data-reference-id="'+n.referenceId+'" data-assembly-id="'+r[a].FP_COMP.assemblyId+'" data-latitude="'+l+'" data-longitude="'+c+'"></div><div class="assembly-list-header-id"><a href="#" class="open-assembly-button" data-assembly-id="'+r[a].FP_COMP.assemblyId+'" title="'+r[a].ASSEMBLY_METADATA.userAssemblyId+'" data-mixpanel-open-assembly-panel="'+r[a].ASSEMBLY_METADATA.userAssemblyId+'">'+r[a].ASSEMBLY_METADATA.userAssemblyId+'</a></div><div class="assembly-list-header-nearest-representative">'+n.referenceId+" ("+Math.round(100*n.score.toFixed(2))+'%)</div><div class="assembly-list-header-st">'+(0===r[a].MLST_RESULT.stType.length?"Not found":r[a].MLST_RESULT.stType)+'</div><div class="assembly-list-header-resistance-profile"><div class="assembly-resistance-profile-container">'+i+"</div></div></div>"),T.appendChild(d[0]),m+=1;b[0].appendChild(T.cloneNode(!0)),S[0].appendChild(T.cloneNode(!0)),$('.show-on-map-checkbox input[type="checkbox"]').prop("checked",!0).change()},window.WGST.exports.__old_remove__createAssemblyResistanceProfilePreviewHtml=function(e,t){var o,a,s,i,n,l,c,d="";for(a in t)if(t.hasOwnProperty(a)){o=t[a],s='<div class="antibiotic-group" data-antibiotic-group-name="'+a+'">{{antibioticsHtml}}</div>',l="";for(i in o)o.hasOwnProperty(i)&&(n="","undefined"!=typeof e[a]?"undefined"!=typeof e[a][i]?(c=e[a][i].resistanceState,n="RESISTANT"===c?n+'<span class="antibiotic resistance-fail" data-antibiotic-name="'+i+'" data-antibiotic-resistance-state="'+c+'" data-toggle="tooltip" data-placement="top" title="'+i+'"></span>':"SENSITIVE"===c?n+'<span class="antibiotic resistance-success" data-antibiotic-name="'+i+'" data-antibiotic-resistance-state="'+c+'" data-toggle="tooltip" data-placement="top" title="'+i+'"></span>':n+'<span class="antibiotic resistance-unknown" data-antibiotic-name="'+i+'" data-antibiotic-resistance-state="'+c+'" data-toggle="tooltip" data-placement="top" title="'+i+'"></span>'):(n=n+'<span class="antibiotic resistance-unknown" data-antibiotic-name="'+i+'" data-antibiotic-resistance-state="'+c+'" data-toggle="tooltip" data-placement="top" title="'+i+'"></span>',console.warn("[!] Assembly resistatance profile has no antibiotic: "+i)):(n=n+'<span class="antibiotic no-resistance-data" data-antibiotic-name="'+i+'" data-antibiotic-resistance-state="'+c+'" data-toggle="tooltip" data-placement="top" title="'+i+'"></span>',console.warn("[!] Assembly resistatance profile has no antibiotic group: "+a)),l+=n);s=s.replace(/{{antibioticsHtml}}/g,l),d+=s}return d};var t=function(e){console.log("[WGST] Maximizing collection "+e),window.WGST.exports.maximizePanel("collection-data__"+e)}}()});