$(function(){!function(){window.WGST.exports.initCollectionDataStructure=function(e,t){WGST.collection[e]={assemblies:{},tree:{}},$.isArray(t)&&t.forEach(function(t){window.WGST.collection[e].tree[t]={}})},window.WGST.exports.setCollectionData=function(e,t,o){window.WGST.exports.initCollectionDataStructure(e),window.WGST.collection[e].assemblies=t,$.each(o,function(t,o){window.WGST.collection[e].tree[t]={type:t,data:o.data,name:o.name}})};var e=function(e){var t=WGST.collection[e].assemblies,o=[],i=[];$.each(window.WGST.collection[e].tree.CORE_TREE_RESULT.leavesOrder,function(e,s){o.push(t[s.id]),i.push(s.id)}),WGST.collection[e].sortedAssemblyIds=i};window.WGST.exports.getCollection=function(o){if(console.log("[WGST] Getting collection "+o),WGST.speak){var i=new SpeechSynthesisUtterance("Loading collection");window.speechSynthesis.speak(i)}$.ajax({type:"POST",url:"/collection/",datatype:"json",data:{collectionId:o}}).done(function(i){if(console.log("[WGST] Got collection "+o+" data"),Object.keys(i).length>0){console.log("[WGST] Collection "+o+" has "+Object.keys(i.collection.assemblies).length+" assemblies"),window.WGST.antibiotics=i.antibiotics,window.WGST.exports.setCollectionData(o,i.collection.assemblies,i.collection.tree),console.debug("[IMPORTANT]"),console.dir(window.WGST.collection[o]);{var s=window.WGST.exports.createCollectionDataPanel(o);$('.wgst-panel[data-panel-id="'+s+'"]')}window.WGST.exports.bringPanelToTop(s),window.WGST.exports.renderCollectionTrees(o),window.WGST.exports.renderCollectionTreeButtons(o,s),window.WGST.exports.addResistanceProfileDataToCollection(o),e(o),window.WGST.exports.renderAssemblyAnalysisList(o,s,WGST.antibiotics),window.WGST.exports.showPanel(s),Object.keys(window.WGST.collection[o].assemblies).length>100&&(console.log("[WGST] Collection "+o+" will be displayed fullscreen"),t(o)),window.history.replaceState("Object","WGST Collection","/collection/"+o),WGST.collection.opened=o,$(".wgst-navigation__collection-panels").toggleClass("hide-this")}}).fail(function(e,t,o){console.log("[WGST][ERROR] Failed to get collection id"),console.error(t),console.error(o),console.error(e),showNotification(t)})};window.WGST.exports.addResistanceProfileDataToCollection=function(e){var t,o,i,s,a,n,l={};for(t in WGST.collection[e].assemblies){o=WGST.collection[e].assemblies[t],l=o.PAARSNP_RESULT.paarResult.resistanceProfile,a={};for(i in l){s=l[i];for(n in s)a[n]=s[n]}WGST.collection[e].assemblies[t].PAARSNP_RESULT.paarResult.ungroupedResistanceProfile=a}},window.WGST.exports.renderAssemblyAnalysisList=function(e,t,o){console.log("[WGST] Rendering assembly analysis list");for(var i,s,a,n,l,c,r,d=WGST.collection[e].assemblies,p=WGST.collection[e].sortedAssemblyIds,b=0,T=$('.wgst-panel[data-panel-id="'+t+'"]'),S=T.find(".collection-assembly-list"),w=T.find(".collection-assembly-list-full"),m=document.createDocumentFragment();b<p.length;)i=p[b],s=d[i].PAARSNP_RESULT.paarResult.resistanceProfile,a=window.WGST.exports.createAssemblyResistanceProfilePreviewHtml(s,o),n=window.WGST.exports.calculateAssemblyTopScore(d[i].FP_COMP.scores),WGST.collection[e].assemblies[i].FP_COMP.topScore=n,l=d[i].ASSEMBLY_METADATA.geography.position.latitude,c=d[i].ASSEMBLY_METADATA.geography.position.longitude,r=$((b%2===0?'<div class="row-stripe assembly-list-item" data-assembly-id="'+d[i].FP_COMP.assemblyId+'">':'<div class="assembly-list-item" data-assembly-id="'+d[i].FP_COMP.assemblyId+'">')+'<div class="show-on-map-checkbox assembly-list-header-map"><input type="checkbox" data-reference-id="'+n.referenceId+'" data-assembly-id="'+d[i].FP_COMP.assemblyId+'" data-latitude="'+l+'" data-longitude="'+c+'"></div><div class="assembly-list-header-id"><a href="#" class="open-assembly-button" data-assembly-id="'+d[i].FP_COMP.assemblyId+'" title="'+d[i].ASSEMBLY_METADATA.userAssemblyId+'">'+d[i].ASSEMBLY_METADATA.userAssemblyId+'</a></div><div class="assembly-list-header-nearest-representative">'+n.referenceId+" ("+Math.round(100*n.score.toFixed(2))+'%)</div><div class="assembly-list-header-st">'+(0===d[i].MLST_RESULT.stType.length?"Not found":d[i].MLST_RESULT.stType)+'</div><div class="assembly-list-header-resistance-profile"><div class="assembly-resistance-profile-container">'+a+"</div></div></div>"),m.appendChild(r[0]),b+=1;S[0].appendChild(m.cloneNode(!0)),w[0].appendChild(m.cloneNode(!0)),$('.show-on-map-checkbox input[type="checkbox"]').prop("checked",!0).change()},window.WGST.exports.createAssemblyResistanceProfilePreviewHtml=function(e,t){var o,i,s,a,n,l,c,r="";for(i in t)if(t.hasOwnProperty(i)){o=t[i],s='<div class="antibiotic-group" data-antibiotic-group-name="'+i+'">{{antibioticsHtml}}</div>',l="";for(a in o)o.hasOwnProperty(a)&&(n="","undefined"!=typeof e[i]?"undefined"!=typeof e[i][a]?(c=e[i][a].resistanceState,n="RESISTANT"===c?n+'<span class="antibiotic resistance-fail" data-antibiotic-name="'+a+'" data-antibiotic-resistance-state="'+c+'" data-toggle="tooltip" data-placement="top" title="'+a+'"></span>':"SENSITIVE"===c?n+'<span class="antibiotic resistance-success" data-antibiotic-name="'+a+'" data-antibiotic-resistance-state="'+c+'" data-toggle="tooltip" data-placement="top" title="'+a+'"></span>':n+'<span class="antibiotic resistance-unknown" data-antibiotic-name="'+a+'" data-antibiotic-resistance-state="'+c+'" data-toggle="tooltip" data-placement="top" title="'+a+'"></span>'):(n=n+'<span class="antibiotic resistance-unknown" data-antibiotic-name="'+a+'" data-antibiotic-resistance-state="'+c+'" data-toggle="tooltip" data-placement="top" title="'+a+'"></span>',console.warn("[!] Assembly resistatance profile has no antibiotic: "+a)):(n=n+'<span class="antibiotic no-resistance-data" data-antibiotic-name="'+a+'" data-antibiotic-resistance-state="'+c+'" data-toggle="tooltip" data-placement="top" title="'+a+'"></span>',console.warn("[!] Assembly resistatance profile has no antibiotic group: "+i)),l+=n);s=s.replace(/{{antibioticsHtml}}/g,l),r+=s}return r};var t=function(e){console.log("[WGST] Maximizing collection "+e);var t=$(".wgst-fullscreen").attr("data-fullscreen-id"),o=t;console.debug("fullscreenId: "+t),console.debug("panelId: "+o),window.WGST.exports.bringFullscreenToPanel(t,o);var o="collection-data__"+e,t="collection-data";window.WGST.exports.bringPanelToFullscreen(o,t),google.maps.event.trigger(window.WGST.geo.map.canvas,"resize")}}()});