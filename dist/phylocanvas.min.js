!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):"object"==typeof exports?exports.PhyloCanvas=e():t.PhyloCanvas=e()}(this,function(){return function(t){function e(a){if(s[a])return s[a].exports;var i=s[a]={exports:{},id:a,loaded:!1};return t[a].call(i.exports,i,i.exports,e),i.loaded=!0,i.exports}var s={};return e.m=t,e.c=s,e.p="/dist/",e(0)}([function(t,e,s){function a(t){this.tree=t,this.injectCss(),this.div=this.createDiv(t.canvasEl),this.resizeTree(t),this.tree.addListener("subtree",function(t){this.addSnapshot(t.node)}.bind(this)),this.tree.addListener("loaded",this.reset.bind(this)),this.tree.addListener("typechanged",function(){this.addSnapshot(this.tree.root.id)}.bind(this)),t.historyCollapsed&&this.collapse()}var i=s(2).addClass,n=s(2).hasClass,r=s(2).removeClass,o=s(5).fireEvent,h=s(5).addEvent,l=s(5).killEvent,c=s(3);a.prototype.reset=function(){this.clear(),this.tree.drawn&&this.addSnapshot(this.tree.root.id)},a.prototype.collapse=function(){i(this.div,"collapsed"),this.toggleDiv.firstChild.data=">",this.resizeTree()},a.prototype.expand=function(){r(this.div,"collapsed"),this.toggleDiv.firstChild.data="<",this.resizeTree()},a.prototype.isCollapsed=function(){return n(this.div,"collapsed")},a.prototype.toggle=function(){this.isCollapsed()?this.expand():this.collapse(),o(this.tree.canvasEl,"historytoggle",{isOpen:!this.isCollapsed()})},a.prototype.createDiv=function(t){var e=document.createElement("div");e.className="pc-history",h(e,"click",l),h(e,"contextmenu",l);var s=document.createElement("div");s.innerHTML="History",s.className="pc-history-title",e.appendChild(s);var a=document.createElement("div");a.appendChild(document.createTextNode("<")),a.className="toggle",h(a,"click",this.toggle.bind(this)),e.appendChild(a),this.toggleDiv=a;var i=document.createElement("ul");return i.className="pc-history-snapshots",e.appendChild(i),this.snapshotList=i,t.appendChild(e),e},a.prototype.resizeTree=function(){var t=this.tree;this.width=this.div.offsetWidth,t.setSize(t.canvasEl.offsetWidth-this.width,t.canvasEl.offsetHeight),this.isCollapsed()?t.canvasEl.getElementsByTagName("canvas")[0].style.marginLeft=this.width+"px":t.canvasEl.getElementsByTagName("canvas")[0].style.marginLeft="20%"},a.prototype.addSnapshot=function(t){var e="phylocanvas-history-",s=this.tree.treeType,a=!1;if(this.tree.historySnapshots.forEach(function(i){i.getAttribute("data-tree-type");i.style.background="transparent",i.id==e+t&&i.getAttribute("data-tree-type")==s&&(a=!0,i.style.background="lightblue")}),!a){var i=this.tree.getPngUrl(),n=document.createElement("li"),r=document.createElement("img");r.width=this.width,r.src=i,r.id=e+t,r.setAttribute("data-tree-type",this.tree.treeType),r.style.background="lightblue",this.tree.historySnapshots.push(r),n.appendChild(r),this.snapshotList.appendChild(n),h(r,"click",this.goBackTo.bind(this))}},a.prototype.clear=function(){for(var t=this.snapshotList.getElementsByTagName("li"),e=t.length;e--;)this.snapshotList.removeChild(t[0])},a.prototype.goBackTo=function(t){var e=t.target;this.tree.treeType=e.getAttribute("data-tree-type"),this.tree.redrawFromBranch(this.tree.origBranches[e.id.replace("phylocanvas-history-","")])},a.prototype.injectCss=function(){var t=".pc-history { position: absolute; top: 0; bottom: 0; left: 0; box-sizing: border-box; width: 20%; overflow: hidden; background: #EEE }.pc-history .pc-history-title { box-sizing: border-box; height: 20px; text-align: center; font-size: 13px; color: #666; padding: 2px; border-bottom: 1px solid #bbb }.pc-history .toggle { position: absolute; top: 0; right: 0; padding: 2px 8px; cursor: pointer; border-top-left-radius: 50%; border-bottom-left-radius: 50%; background-color: #666; color: #FFF; box-sizing: border-box; height: 20px; }.pc-history.collapsed .toggle { border-radius: 0 50% 50% 0 }.pc-history .toggle:hover { background-color: #FFF; color: #CCC }.pc-history.collapsed { width: 25px }.pc-history.collapsed .pc-history-snapshots { display: none }.pc-history.collapsed .pc-history-title { writing-mode: tb-rl; -webkit-transform: rotate(270deg); -moz-transform: rotate(270deg); -o-transform: rotate(270deg); -ms-transform: rotate(270deg); transform: rotate(270deg); margin-top: 70px; background: 0 0; color: #666; letter-spacing: 1.2px; border-bottom: none }.pc-history-snapshots { position: absolute; top: 20px; bottom: 0; margin: 0; padding: 0; overflow-x: hidden; overflow-y: scroll; }.pc-history-snapshots li { list-style: outside none none }.pc-history img { border: 0px solid #CCC; border-top-width: 1px; cursor: pointer; width: 100%; box-sizing: border-box; transition: background-color .25s ease; display: block }.pc-history img:hover { background-color: #fff }",e=document.head||document.getElementsByTagName("head")[0],s=document.createElement("style");s.type="text/css",s.styleSheet?s.styleSheet.cssText=t:s.appendChild(document.createTextNode(t)),e.appendChild(s)},c.prototype.initialiseHistory=function(t){var e;(t.history||"undefined"==typeof t.history)&&(e=t.history&&"undefined"!=typeof t.history.collapsed,this.historyCollapsed=e?t.history.collapsed:!0,this.historySnapshots=[],this.history=new a(this))},t.exports={Tree:c,Branch:s(4),Loader:s(1),ContextMenu:s(6),History:a}},function(t,e,s){function a(t){this.div=t,this.cl=document.createElement("canvas"),this.cl.id=t.id+"Loader",this.cl.style.position="absolute",this.cl.style.backgroundColor="#FFFFFF",this.cl.style.top=t.offsetHeight/4+"px",this.cl.style.left=t.offsetWidth/4+"px",this.cl.height=t.offsetHeight/2,this.cl.width=t.offsetWidth/2,this.cl.style.zIndex="1000",t.appendChild(this.cl),this.ctx=document.getElementById(t.id+"Loader").getContext("2d"),this.drawer=null,this.loaderRadius=null,this.loaderStep=2*Math.PI/360,this.message="Loading ..."}a.prototype.run=function(){var t=0,e=this;this.cl.style.diangle="block",this.initLoader(),this.drawer=setInterval(function(){e.drawLoader(t),t++},10)},a.prototype.resize=function(){this.cl.style.top="2px",this.cl.style.left="2px",this.cl.height=.75*this.div.offsetHeight,this.cl.width=.75*this.div.offsetWidth,this.ctx.strokeStyle="rgba(180,180,255,1)",this.ctx.fillStyle="rgba(180,180,255,1)",this.ctx.lineWidth=10,this.ctx.font="24px sans-serif",this.ctx.shadowOffsetX=2,this.ctx.shadowOffsetY=2},a.prototype.initLoader=function(){this.ctx.strokeStyle="rgba(180,180,255,1)",this.ctx.fillStyle="rgba(180,180,255,1)",this.ctx.lineWidth=10,this.ctx.font="24px sans-serif",this.ctx.shadowOffsetX=2,this.ctx.shadowOffsetY=2},a.prototype.drawLoader=function(t){this.ctx.restore(),this.ctx.translate(0,0),this.loaderRadius=Math.min(this.ctx.canvas.width/4,this.ctx.canvas.height/4),this.ctx.save(),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.translate(this.ctx.canvas.width/2,this.ctx.canvas.height/2),this.ctx.beginPath(),this.ctx.arc(0,0,this.loaderRadius,this.loaderStep*t,this.loaderStep*t+2),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(0,0,this.loaderRadius,this.loaderStep*t+3,this.loaderStep*t+5),this.ctx.stroke(),this.ctx.fillText(this.message,-(this.ctx.measureText(this.message).width/2),this.loaderRadius+50,this.cl.width)},a.prototype.stop=function(){clearInterval(this.drawer),this.cl.style.display="none"},a.prototype.fail=function(t){clearInterval(this.drawer),this.loaderRadius=Math.min(this.ctx.canvas.width/4,this.ctx.canvas.height/4),this.ctx.restore(),this.ctx.translate(0,0),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(255,180,180,1)",this.ctx.fillStyle="rgba(255,180,180,1)",this.ctx.translate(this.ctx.canvas.width/2,this.ctx.canvas.height/2),this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(this.loaderRadius,this.loaderRadius),this.ctx.moveTo(0,0),this.ctx.lineTo(-this.loaderRadius,this.loaderRadius),this.ctx.moveTo(0,0),this.ctx.lineTo(-this.loaderRadius,-this.loaderRadius),this.ctx.moveTo(0,0),this.ctx.lineTo(this.loaderRadius,-this.loaderRadius),this.ctx.stroke(),this.ctx.fillText(t,-(this.ctx.measureText(t).width/2),this.loaderRadius+50,2*this.loaderRadius)},t.exports=a},function(t,e,s){function a(t,e){var s=new Blob([t],{type:"text/csv;charset=utf-8"}),a=window.URL||window.webkitURL,i=document.createElement("a"),n="undefined"!=typeof i.download;i.href=a.createObjectURL(s),i.target="_blank",n&&(i.download=e?e:"pc-download.txt"),l(i,"click")}function i(t){for(var e=0;null!=t;)e+=t.offsetLeft,t=t.offsetParent;return e}function n(t){for(var e=0;t;)e+=t.offsetTop,t=t.offsetParent;return e}function r(t,e){var s=t.className.split(" ");-1===s.indexOf(e)&&(s.push(e),t.className=s.join(" "))}function o(t,e){var s=t.className.split(" "),a=s.indexOf(e);-1!==a&&(s.splice(a,1),t.className=s.join(" "))}function h(t,e){var s=t.className.split(" "),a=s.indexOf(e);return-1!==a}var l=s(5).fireEvent;t.exports.setupDownloadLink=a,t.exports.getX=i,t.exports.getY=n,t.exports.addClass=r,t.exports.removeClass=o,t.exports.hasClass=h},function(t,e,s){function a(t,e){e||(e={}),"string"==typeof t&&(t=document.getElementById(t)),this.branches={},this.leaves=[],this.root=!1,this.lastId=0,this.backColour=!1,this.origBL={},this.origP={},this.canvasEl=t,c(this.canvasEl,"pc-container"),"static"===window.getComputedStyle(this.canvasEl).position&&(this.canvasEl.style.position="relative"),this.canvasEl.style.boxSizing="border-box";var s=document.createElement("canvas");s.id=t.id+"pCanvas",s.className="phylocanvas",s.style.position="relative",s.style.backgroundColor="#FFFFFF",s.height=t.clientHeight||400,s.width=t.clientWidth||400,s.style.zIndex="1",this.canvasEl.appendChild(s);var a=[];void 0!==e.contextMenu&&(a=e.contextMenu),this.contextMenu=new n(this,a),this.defaultCollapsedOptions={},this.defaultCollapsed=!1,void 0!==e.defaultCollapsed&&e.defaultCollapsed.min&&e.defaultCollapsed.max&&(this.defaultCollapsedOptions=e.defaultCollapsed,this.defaultCollapsed=!0),this.tooltip=new r(this),this.drawn=!1,this.selectedNodes=[],this.zoom=1,this.pickedup=!1,this.dragging=!1,this.startx=null,this.starty=null,this.pickedup=!1,this.baseNodeSize=1,this.curx=null,this.cury=null,this.origx=null,this.origy=null,this.canvas=s.getContext("2d"),this.canvas.canvas.onselectstart=function(){return!1},this.canvas.fillStyle="#000000",this.canvas.strokeStyle="#000000",this.canvas.save(),this.offsetx=this.canvas.canvas.width/2,this.offsety=this.canvas.canvas.height/2,this.selectedColour="rgba(49,151,245,1)",this.highlightColour="rgba(49,151,245,1)",this.highlightWidth=5,this.selectedNodeSizeIncrease=0,this.branchColour="rgba(0,0,0,1)",this.branchScalar=1,this.hoverLabel=!1,this.internalNodesSelectable=!0,this.showLabels=!0,this.showBootstraps=!1,this.treeType="radial",this.maxBranchLength=0,this.lineWidth=1,this.textSize=7,this.font="sans-serif",this.unselectOnClickAway=!0,this.rightClickZoom=!0,this.useNavigator&&(this.navigator=new o(this)),this.adjustForPixelRatio(),this.initialiseHistory(e),this.addListener("contextmenu",this.clicked.bind(this)),this.addListener("click",this.clicked.bind(this)),this.addListener("mousedown",this.pickup.bind(this)),this.addListener("mouseup",this.drop.bind(this)),this.addListener("mouseout",this.drop.bind(this)),g(this.canvas.canvas,"mousemove",this.drag.bind(this)),g(this.canvas.canvas,"mousewheel",this.scroll.bind(this)),g(this.canvas.canvas,"DOMMouseScroll",this.scroll.bind(this)),g(window,"resize",function(t){this.resizeToContainer()}.bind(this)),this.addListener("loaded",function(t){this.origBranches=this.branches,this.origLeaves=this.leaves,this.origRoot=this.root}.bind(this)),this.nodeAlign=!1,this.farthestNodeFromRootX=0,this.farthestNodeFromRootY=0,this.showMetadata=!1,this.selectedMetadataColumns=[],this.colour1="rgba(206,16,16,1)",this.colour0="#ccc",this.maxLabelLength={},this.metadataXStep=15,this.metadataHeadingDrawn=!1}var i=s(4),n=s(6),r=s(7),o=s(8),h=s(9).Angles,l=s(9).Shapes,c=s(2).addClass,d=s(2).getX,p=s(2).getY,v=s(5).fireEvent,g=s(5).addEvent,f=s(10).getBackingStorePixelRatio;a.prototype.AJAX=function(t,e,s,a,i,n,r){var o;o=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),o.onreadystatechange=function(){4===o.readyState&&(200===o.status?a(o,i,n):r&&r(o,i,n))},o.open(e,t,!0),"GET"===e?o.send():o.send(s)},a.prototype.checkInitialTreeCollapseRange=function(t){var e=t.getChildIds();e&&e.length>this.defaultCollapsedOptions.min&&e.length<this.defaultCollapsedOptions.max&&(t.collapsed=!0)},a.prototype.branchRenderers={rectangular:function(t,e,s){var a=e.branchLength*t.branchScalar;e.angle=0,e.parent&&(e.centerx=e.startx+a),e.selected?e.canvas.fillStyle=t.selectedColour:e.canvas.fillStyle=e.colour,e.canvas.strokeStyle=e.getColour(),e.canvas.beginPath(),s||(e.canvas.moveTo(e.startx,e.starty),e.canvas.lineTo(e.startx,e.centery),e.canvas.lineTo(e.centerx,e.centery),e.canvas.stroke(),e.canvas.closePath(),t.defaultCollapsed&&t.defaultCollapsedOptions&&t.checkInitialTreeCollapseRange(e),e.drawNode()),e.canvas.closePath();for(var i=0;i<e.children.length&&!s;i++)e.children[i].startx=e.centerx,e.children[i].starty=e.centery,t.branchRenderers.rectangular(t,e.children[i],e.collapsed||s)},circular:function(t,e,s){var a=e.totalBranchLength*t.branchScalar;if(e.canvas.strokeStyle=e.getColour(),e.selected?e.canvas.fillStyle=e.tree.selectedColour:e.canvas.fillStyle=e.colour,!s){if(e.canvas.beginPath(),e.canvas.moveTo(e.startx,e.starty),e.leaf){e.canvas.lineTo(e.interx,e.intery),e.canvas.stroke();var i=e.getColour();e.canvas.strokeStyle=e.selected?e.tree.selectedColour:"rgba(0,0,0,0.5)",e.canvas.lineTo(e.centerx,e.centery),e.canvas.stroke(),e.canvas.strokeStyle=i}else e.canvas.lineTo(e.centerx,e.centery),e.canvas.stroke();e.canvas.strokeStyle=e.getColour(),t.defaultCollapsed&&t.defaultCollapsedOptions&&t.checkInitialTreeCollapseRange(e),e.children.length>1&&!e.collapsed&&(e.canvas.beginPath(),e.canvas.arc(0,0,a,e.minChildAngle,e.maxChildAngle,e.maxChildAngle<e.minChildAngle),e.canvas.stroke(),e.canvas.closePath()),e.drawNode()}for(var n=0;n<e.children.length&&!s;n++)t.branchRenderers.circular(t,e.children[n],e.collapsed||s)},radial:function(t,e,s){e.canvas.strokeStyle=e.getColour(),e.selected?e.canvas.fillStyle=e.tree.selectedColour:e.canvas.fillStyle=e.colour,e.parent&&!s&&(e.canvas.beginPath(),e.canvas.moveTo(e.startx,e.starty),e.canvas.lineTo(e.centerx,e.centery),e.canvas.stroke(),e.canvas.closePath(),t.defaultCollapsed&&t.defaultCollapsedOptions&&t.checkInitialTreeCollapseRange(e),e.drawNode());for(var a=0;a<e.children.length&&!s;a++)t.branchRenderers.radial(t,e.children[a],e.collapsed||s)},diagonal:function(t,e,s){e.angle=0,e.canvas.strokeStyle=e.getColour(),e.selected?e.canvas.fillStyle=e.tree.selectedColour:e.canvas.fillStyle=e.colour,e.canvas.beginPath(),s||(e.canvas.moveTo(e.startx,e.starty),e.canvas.lineTo(e.centerx,e.centery),e.canvas.stroke(),e.canvas.closePath(),t.defaultCollapsed&&t.defaultCollapsedOptions&&t.checkInitialTreeCollapseRange(e),e.drawNode()),e.canvas.closePath();for(var a=0;a<e.children.length&&!s;a++)e.children[a].startx=e.centerx,e.children[a].starty=e.centery,t.branchRenderers.diagonal(t,e.children[a],e.collapsed||s)},hierarchy:function(t,e,s){e.canvas.strokeStyle=e.getColour(),e.selected?e.canvas.fillStyle=e.tree.selectedColour:e.canvas.fillStyle=e.colour,s||(e.canvas.beginPath(),e!==e.tree.root&&(e.canvas.moveTo(e.startx,e.starty),e.canvas.lineTo(e.centerx,e.starty)),e.canvas.lineTo(e.centerx,e.centery),e.canvas.stroke(),t.defaultCollapsed&&t.defaultCollapsedOptions&&t.checkInitialTreeCollapseRange(e),e.drawNode()),e.canvas.closePath();for(var a=0;a<e.children.length&&!s;a++)t.branchRenderers.hierarchy(t,e.children[a],e.collapsed||s)}},a.prototype.clicked=function(t){var e,s;if(0===t.button){if(s=[],this.dragging)return void(this.dragging=!1);if(!this.root)return!1;e=this.root.clicked(this.translateClickX(t.clientX),this.translateClickY(t.clientY)),e?(this.root.setSelected(!1,!0),(this.internalNodesSelectable||e.leaf)&&(e.setSelected(!0,!0),s=e.getChildIds()),this.draw()):this.unselectOnClickAway&&this.contextMenu.closed&&!this.dragging&&(this.root.setSelected(!1,!0),this.draw()),this.pickedup||(this.dragging=!1),this.nodesSelected(s)}else 2===t.button&&(t.preventDefault(),e=this.root.clicked(this.translateClickX(t.clientX),this.translateClickY(t.clientY)),this.contextMenu.open(t.clientX,t.clientY,e),this.contextMenu.closed=!1,this.tooltip.close())},a.prototype.dblclicked=function(t){if(!this.root)return!1;var e=this.root.clicked(this.translateClickX(1*t.clientX),this.translateClickY(1*t.clientY));e&&(e.setSelected(!1,!0),e.toggleCollapsed()),this.pickedup||(this.dragging=!1),this.draw()},a.prototype.displayLabels=function(){this.showLabels=!0,this.draw()},a.prototype.drag=function(t){var e=(window.devicePixelRatio||1)/f(this.canvas);if(!this.drawn)return!1;if(this.pickedup){var s=(t.clientX-this.startx)*e,a=(t.clientY-this.starty)*e;Math.abs(s)+Math.abs(a)>5&&(this.dragging=!0,this.offsetx=this.origx+s,this.offsety=this.origy+a,this.draw())}else if(this.zoomPickedUp)this.d=(this.starty-t.clientY)/100,this.setZoom(this.origZoom+this.d),this.draw();else{var i=t,n=this.root.clicked(this.translateClickX(1*i.clientX),this.translateClickY(1*i.clientY));n&&(this.internalNodesSelectable||n.leaf)?(this.root.setHighlighted(!1),n.setHighlighted(!0),!n.leaf&&this.contextMenu.closed&&this.tooltip.open(i.clientX,i.clientY,n)):(this.tooltip.close(),this.contextMenu.close(),this.root.setHighlighted(!1)),this.draw()}},a.prototype.draw=function(t){return this.selectedNodes=[],0===this.maxBranchLength?void this.loadError("All branches in the tree are identical."):(this.canvas.restore(),this.canvas.clearRect(0,0,this.canvas.canvas.width,this.canvas.canvas.height),this.canvas.lineCap="round",this.canvas.lineJoin="round",this.canvas.strokeStyle=this.branchColour,this.canvas.save(),this.canvas.translate(this.canvas.canvas.width/2/f(this.canvas),this.canvas.canvas.height/2/f(this.canvas)),(!this.drawn||t)&&(this.prerenderers[this.treeType](this),t||this.fitInPanel()),this.canvas.lineWidth=this.lineWidth/this.zoom,this.canvas.translate(this.offsetx,this.offsety),this.canvas.scale(this.zoom,this.zoom),this.branchRenderers[this.treeType](this,this.root),this.defaultCollapsed=!1,this.metadataHeadingDrawn=!1,void(this.drawn=!0))},a.prototype.drop=function(){return this.drawn?(this.pickedup=!1,void(this.zoomPickedUp=!1)):!1},a.prototype.findBranch=function(t){this.root.setSelected(!1,!0);for(var e=0;e<this.leaves.length;e++)this.leaves[e].id.match(new RegExp(t,"i"))&&this.leaves[e].setSelected(!0,!0);this.draw()},a.prototype.clearSelect=function(){this.root.setSelected(!1,!0),this.draw()},a.prototype.genId=function(){return"pcn"+this.lastId++},a.prototype.getPngUrl=function(){return this.canvas.canvas.toDataURL()},a.prototype.hideLabels=function(){this.showLabels=!1,this.draw()},a.prototype.dangerouslySetData=function(t){this.parseNwk(t,null),this.draw(),this.loadCompleted()},a.prototype.load=function(t,e,s){s?s.match(/nexus/i)?t.match(/\.\w+$/)?this.AJAX(t,"GET","",this.loadFileCallback,{format:"nexus",name:e},this):this.parseNexus(t,e):s.match(/newick/i)&&(t.match(/\.\w+$/)?this.AJAX(t,"GET","",this.loadFileCallback,{format:"newick"},this):this.parseNwk(t,e)):t.match(/\.n(ex|xs)$/)?this.AJAX(t,"GET","",this.loadFileCallback,{format:"nexus",name:e},this):t.match(/\.nwk$/)?this.AJAX(t,"GET","",this.loadFileCallback,{format:"newick"},this):t.match(/^#NEXUS[\s\n;\w\.\*\:(\),-=\[\]\/&]+$/i)?(this.parseNexus(t,e),this.draw(),this.loadCompleted()):t.match(/^[\w\.\*\:(\),-\/]+;\s?$/gi)?(this.parseNwk(t,e),this.draw(),this.loadCompleted()):this.loadError("PhyloCanvas did not recognise the string as a file or a newick or Nexus format string")},a.prototype.loadFileCallback=function(t,e,s){if(e.format.match(/nexus/i))s.parseNexus(t.responseText,e.name);else{if(!e.format.match(/newick/i))throw new Error("file type not recognised by PhyloCanvas");s.parseNwk(t.responseText)}s.draw(),s.loadCompleted()},a.prototype.nodePrerenderers={radial:function(t,e){e.parent?(e.startx=e.parent.centerx,e.starty=e.parent.centery):(e.startx=0,e.starty=0),e.centerx=e.startx+e.branchLength*t.branchScalar*Math.cos(e.angle),e.centery=e.starty+e.branchLength*t.branchScalar*Math.sin(e.angle);for(var s=0;s<e.children.length;s++)this.radial(t,e.children[s])}},a.prototype.nodeRenderers={circle:function(t){var e=t.getNodeSize();t.canvas.arc(e,0,e,0,h.FULL,!1),t.canvas.stroke(),t.canvas.fill()},square:function(t){var e=t.getNodeSize(),s=0,a=2*e,i=-e,n=e;t.canvas.moveTo(s,i),t.canvas.lineTo(s,n),t.canvas.lineTo(a,n),t.canvas.lineTo(a,i),t.canvas.lineTo(s,i),t.canvas.stroke(),t.canvas.fill()},star:function(t){var e=t.getNodeSize(),s=e,a=0,i=6,n=6,r=2,o=Math.PI/2*3,h=s,l=a,c=Math.PI/i,d=0;for(t.canvas.beginPath(),t.canvas.moveTo(s,a-n),d=0;i>d;d++)h=s+Math.cos(o)*n,l=a+Math.sin(o)*n,t.canvas.lineTo(h,l),o+=c,h=s+Math.cos(o)*r,l=a+Math.sin(o)*r,t.canvas.lineTo(h,l),o+=c;t.canvas.lineTo(s,a-n),t.canvas.stroke(),t.canvas.fill(),t.canvas.moveTo(s,a),t.canvas.lineTo(s-(n-1),a),t.canvas.stroke(),t.canvas.closePath()},triangle:function(t){var e=t.getNodeSize(),s=e,a=0,i=s-e,n=s+e,r=a-e,o=a+e;t.canvas.moveTo(s,r),t.canvas.lineTo(n,o),t.canvas.lineTo(i,o),t.canvas.lineTo(s,r),t.canvas.stroke(),t.canvas.fill(),t.canvas.moveTo(i,(r+o)/2),t.canvas.lineTo((i+n)/2,(r+o)/2),t.canvas.stroke()}},a.prototype.parseNexus=function(t,e){if(!t.match(/^#NEXUS[\s\n;\w\.\*\/\:(\),-=\[\]&]+$/i))throw"The string provided was not a nexus string";if(!t.match(/BEGIN TREES/gi))throw"The nexus file does not contain a tree block";var s=t.match(/BEGIN TREES;[\S\s]+END;/i)[0].replace(/BEGIN TREES;\n/i,"").replace(/END;/i,""),a=s.match(/TRANSLATE[^;]+;/i)[0];s=s.replace(a,""),a=a.replace(/translate|;/gi,"");for(var i,n=a.split(","),r={},o=0;o<n.length;o++)i=n[o].replace("\n","").split(" "),r[i[0].trim()]=i[1].trim();for(var h=s.split("\n"),l={},o=0;o<h.length;o++)if(""!==h[o].trim()){var c=h[o].replace(/tree\s/i,"");l[c.match(/^\w+/)[0]]=c.match(/ [\S]*$/)[0]}if(!l[e])throw"tree "+e+" does not exist in this NEXUS file";this.parseNwk(l[e].trim());for(var d in r){var p=this.branches[d];delete this.branches[d],p.id=r[d],this.branches[p.id]=p}},a.prototype.parseNwk=function(t){this.origBranches=!1,this.origLeaves=!1,this.origRoot=!1,this.origBL={},this.origP={},this.root=!1,this.leaves=[],this.branches={},this.drawn=!1;var e=new i;e.id="root",this.branches.root=e,this.setRoot(e);for(var s=0;s<t.length;s++){var a;switch(t[s]){case"(":a=new i,e.addChild(a),e=a;break;case")":e=e.parent;break;case",":a=new i,e.parent.addChild(a),e=a;break;case";":for(var n=0;n<this.leaves.length;n++)this.leaves[n].totalBranchLength>this.maxBranchLength&&(this.maxBranchLength=this.leaves[n].totalBranchLength);break;default:try{s=e.parseNwk(t,s),s--}catch(r){return void this.loadError("Error parsing nwk file"+r)}}}return this.saveNode(this.root),this.root.saveChildren(),this.root.branchLength=0,this.maxBranchLength=0,this.root.setTotalLength(),0===this.maxBranchLength?void this.loadError("All branches in the tree are identical."):(this.buildLeaves(),void this.loadCompleted())},a.prototype.pickup=function(t){return this.drawn?(this.origx=this.offsetx,this.origy=this.offsety,0===t.button&&(this.pickedup=!0),2===t.button&&this.rightClickZoom&&(this.zoomPickedUp=!0,this.origZoom=Math.log(this.zoom)/Math.log(10),this.oz=this.zoom),this.startx=t.clientX,void(this.starty=t.clientY)):!1},a.prototype.prerenderers={rectangular:function(t,e){t.root.startx=0,t.root.starty=0,t.root.centerx=0,t.root.centery=0,t.farthestNodeFromRootX=0,t.farthestNodeFromRootY=0,t.branchScalar=t.canvas.canvas.width/t.maxBranchLength;for(var s=Math.max(t.canvas.canvas.height/(t.leaves.length+2),2*(t.leaves[0].getNodeSize()+2)),a=0;a<t.leaves.length;a++){t.leaves[a].angle=0,t.leaves[a].centery=a>0?t.leaves[a-1].centery+s:0,t.leaves[a].centerx=t.leaves[a].totalBranchLength*t.branchScalar,t.leaves[a].centerx>t.farthestNodeFromRootX&&(t.farthestNodeFromRootX=t.leaves[a].centerx),t.leaves[a].centery>t.farthestNodeFromRootY&&(t.farthestNodeFromRootY=t.leaves[a].centery);for(var i=t.leaves[a];i.parent;i=i.parent){var n=i.parent.children;i.parent.centery=(n[0].centery+n[n.length-1].centery)/2}}t.root.startx=t.root.centerx,t.root.starty=t.root.centery,t.setFontSize(s),t.setMaxLabelLength()},circular:function(t){t.root.startx=0,t.root.starty=0,t.root.centerx=0,t.root.centery=0,t.branchScalar=Math.min(t.canvas.canvas.width,t.canvas.canvas.height)/t.maxBranchLength;var e=t.leaves.length*t.leaves[0].getNodeSize()*2/h.FULL;t.branchScalar*t.maxBranchLength>e?e=t.branchScalar*t.maxBranchLength:t.branchScalar=e/t.maxBranchLength;for(var s=h.FULL/t.leaves.length,a=0;a<t.leaves.length;a++){t.leaves[a].angle=s*a,t.leaves[a].centery=e*Math.sin(t.leaves[a].angle),t.leaves[a].centerx=e*Math.cos(t.leaves[a].angle),t.leaves[a].starty=t.leaves[a].parent.totalBranchLength*t.branchScalar*Math.sin(t.leaves[a].angle),t.leaves[a].startx=t.leaves[a].parent.totalBranchLength*t.branchScalar*Math.cos(t.leaves[a].angle),t.leaves[a].intery=t.leaves[a].totalBranchLength*t.branchScalar*Math.sin(t.leaves[a].angle),t.leaves[a].interx=t.leaves[a].totalBranchLength*t.branchScalar*Math.cos(t.leaves[a].angle);for(var i=t.leaves[a];i.parent&&(0==i.getChildNo()&&(i.parent.angle=i.angle,i.parent.minChildAngle=i.angle),i.getChildNo()==i.parent.children.length-1);i=i.parent)i.parent.maxChildAngle=i.angle,i.parent.angle=(i.parent.minChildAngle+i.parent.maxChildAngle)/2,i.parent.centery=i.parent.totalBranchLength*t.branchScalar*Math.sin(i.parent.angle),i.parent.centerx=i.parent.totalBranchLength*t.branchScalar*Math.cos(i.parent.angle),i.parent.starty=(i.parent.totalBranchLength-i.parent.branchLength)*t.branchScalar*Math.sin(i.parent.angle),i.parent.startx=(i.parent.totalBranchLength-i.parent.branchLength)*t.branchScalar*Math.cos(i.parent.angle)}t.root.startx=t.root.centerx,t.root.starty=t.root.centery,t.setFontSize(s),t.setMaxLabelLength()},radial:function(t,e){t.branchScalar=Math.min(t.canvas.canvas.width,t.canvas.canvas.height)/t.maxBranchLength;var s=h.FULL/t.leaves.length;t.root.startx=0,t.root.starty=0,t.root.centerx=0,t.root.centery=0;for(var a=0;a<t.leaves.length;a+=1){t.leaves[a].angle=s*a,t.leaves[a].centerx=t.leaves[a].totalBranchLength*t.branchScalar*Math.cos(t.leaves[a].angle),t.leaves[a].centery=t.leaves[a].totalBranchLength*t.branchScalar*Math.sin(t.leaves[a].angle);for(var i=t.leaves[a];i.parent&&(0==i.getChildNo()&&(i.parent.angle=0),i.parent.angle+=i.angle*i.getChildCount(),i.getChildNo()==i.parent.children.length-1);i=i.parent)i.parent.angle=i.parent.angle/i.parent.getChildCount()}t.root.startx=t.root.centerx,t.root.starty=t.root.centery,t.nodePrerenderers.radial(t,t.root),t.setFontSize(s),t.setMaxLabelLength()},diagonal:function(t,e){var s=Math.max(t.canvas.canvas.height/(t.leaves.length+2),2*(t.leaves[0].getNodeSize()+2));t.root.startx=0,t.root.starty=0,t.root.centerx=0,t.root.centery=0;for(var a=0;a<t.leaves.length;a++){t.leaves[a].centerx=0,t.leaves[a].centery=a>0?t.leaves[a-1].centery+s:0,t.leaves[a].angle=0;for(var i=t.leaves[a];i.parent&&i.getChildNo()==i.parent.children.length-1;i=i.parent){i.parent.centery=i.parent.getChildYTotal()/i.parent.getChildCount(),i.parent.centerx=i.parent.children[0].centerx+(i.parent.children[0].centery-i.parent.centery)*Math.tan(h.FORTYFIVE);for(var n=0;n<i.parent.children.length;n++)i.parent.children[n].startx=i.parent.centerx,i.parent.children[n].starty=i.parent.centery}}t.root.startx=t.root.centerx,t.root.starty=t.root.centery,t.setFontSize(s),t.setMaxLabelLength()},hierarchy:function(t){t.root.startx=0,t.root.starty=0,t.root.centerx=0,t.root.centery=0,t.farthestNodeFromRootX=0,t.farthestNodeFromRootY=0,t.branchScalar=t.canvas.canvas.height/t.maxBranchLength;for(var e=Math.max(t.canvas.canvas.width/(t.leaves.length+2),2*(t.leaves[0].getNodeSize()+2)),s=0;s<t.leaves.length;s++){t.leaves[s].angle=h.QUARTER,t.leaves[s].centerx=s>0?t.leaves[s-1].centerx+e:0,t.leaves[s].centery=t.leaves[s].totalBranchLength*t.branchScalar;for(var a=t.leaves[s];a.parent&&(0==a.getChildNo()&&(a.parent.centerx=a.centerx),a.getChildNo()==a.parent.children.length-1);a=a.parent){a.parent.angle=h.QUARTER,a.parent.centerx=(a.parent.centerx+a.centerx)/2,a.parent.centery=a.parent.totalBranchLength*t.branchScalar;for(var i=0;i<a.parent.children.length;i++)a.parent.children[i].startx=a.parent.centerx,a.parent.children[i].starty=a.parent.centery}t.leaves[s].centerx>t.farthestNodeFromRootX&&(t.farthestNodeFromRootX=t.leaves[s].centerx),t.leaves[s].centery>t.farthestNodeFromRootY&&(t.farthestNodeFromRootY=t.leaves[s].centery)}t.root.startx=t.root.centerx,t.root.starty=t.root.centery,t.setFontSize(e),t.setMaxLabelLength()}},a.prototype.redrawGetNodes=function(t,e){for(var s=0;s<t.children.length;s++)this.branches[t.children[s].id]=t.children[s],t.children[s].leaf?(e.push(t.children[s].id),this.leaves.push(t.children[s])):this.redrawGetNodes(t.children[s],e)},a.prototype.redrawFromBranch=function(t){this.drawn=!1,this.totalBranchLength=0,this.resetTree(),this.origBL[t.id]=t.branchLength,this.origP[t.id]=t.parent,this.root=t,this.root.branchLength=0,this.root.parent=!1,this.branches={},this.leaves=[];for(var e=[],s=0;s<this.root.children.length;s++)this.branches[this.root.children[s].id]=this.root.children[s],this.root.children[s].leaf?(this.leaves.push(this.root.children[s]),e.push(this.root.children[s].id)):this.redrawGetNodes(this.root.children[s],e);this.root.setTotalLength(),this.prerenderers[this.treeType](this),this.draw(),this.subtreeDrawn(t.id)},a.prototype.redrawOriginalTree=function(){this.drawn=!1,this.resetTree(),this.root.setTotalLength(),this.prerenderers[this.treeType](this),this.draw(),this.subtreeDrawn(this.root.id)},a.prototype.saveNode=function(t){if(t.id&&""!==t.id||(t.id=t.tree.genId()),this.branches[t.id]){if(t!==this.branches[t.id]){if(this.leaf)throw"Two nodes on this tree share the id "+t.id;t.id=this.genId(),this.branches[t.id]=t}}else this.branches[t.id]=t},a.prototype.scroll=function(t){var e=Math.log(this.zoom)/Math.log(10);this.setZoom(e+(t.detail<0||t.wheelDelta>0?.12:-.12)),t.preventDefault()},a.prototype.selectNodes=function(t){var e,s,a,i=t;if(this.root){this.root.setSelected(!1,!0),"string"==typeof t&&(i=i.split(","));for(s in this.branches)if(this.branches.hasOwnProperty(s))for(e=this.branches[s],a=0;a<i.length;a++)i[a]===e.id&&e.setSelected(!0,!0);this.draw()}},a.prototype.setFont=function(t){isNaN(t)&&(this.font=t,this.draw())},a.prototype.setNodeColourAndShape=function(t,e,s,a,i){if(t)if(this.drawn){var n=[];if(n="string"==typeof t?t.split(","):t,""!==t){for(var r=0;r<n.length;r++)this.branches[n[r]]&&(e&&(this.branches[n[r]].colour=e),s&&(this.branches[n[r]].nodeShape=l[s]?l[s]:s),a&&(this.branches[n[r]].radius=a));this.draw()}}else if(!i)var o=this,h=setInterval(function(){this.drawn&&(o.setNodeColourAndShape(t,e,s,a,!0),clearInterval(h))})},a.prototype.setNodeSize=function(t){this.baseNodeSize=Number(t),this.draw()},a.prototype.setRoot=function(t){t.canvas=this.canvas,t.tree=this,this.root=t},a.prototype.setTextSize=function(t){this.textSize=Number(t),this.draw()},a.prototype.setFontSize=function(t){"circular"===this.treeType?this.textSize=Math.min(100*t+5,40):"radial"===this.treeType?this.textSize=Math.min(50*t+5,20):"diagonal"===this.treeType?this.textSize=Math.min(t/2,10):this.textSize=Math.min(t/2,15),this.canvas.font=this.textSize+"pt "+this.font},a.prototype.setTreeType=function(t){var e=this.treeType;this.treeType=t,this.drawn&&(this.drawn=!1,this.draw()),this.treeTypeChanged(e,t)},a.prototype.setSize=function(t,e){this.canvas.canvas.width=t,this.canvas.canvas.height=e,this.navigator&&this.navigator.resize(),this.adjustForPixelRatio(),this.drawn&&this.draw()},a.prototype.setZoom=function(t){if(t>-2&&2>t){var e=this.zoom;this.zoom=Math.pow(10,t),this.offsetx=this.offsetx/e*this.zoom,this.offsety=this.offsety/e*this.zoom,this.draw()}},a.prototype.toggleLabels=function(){
this.showLabels=!this.showLabels,this.draw()},a.prototype.translateClickX=function(t){var e=(window.devicePixelRatio||1)/f(this.canvas);return t=t-d(this.canvas.canvas)+window.pageXOffset,t*=e,t-=this.canvas.canvas.width/2,t-=this.offsetx,t/=this.zoom},a.prototype.translateClickY=function(t){var e=(window.devicePixelRatio||1)/f(this.canvas);return t=t-p(this.canvas.canvas)+window.pageYOffset,t*=e,t-=this.canvas.canvas.height/2,t-=this.offsety,t/=this.zoom},a.prototype.viewMetadataColumns=function(t){this.showMetadata=!0,void 0===t&&(t=this.getMetadataColumnHeadings()),void 0!==t&&(this.selectedMetadataColumns=t),this.fitInPanel(),this.draw()},a.prototype.getMetadataColumnHeadings=function(){for(var t=[],e=0;e<this.leaves.length;e++)if(Object.keys(this.leaves[e].data).length>0){t=Object.keys(this.leaves[e].data);break}return t},a.prototype.clearMetadata=function(){for(var t=0;t<this.leaves.length;t++)Object.keys(this.leaves[t].data).length>0&&(this.leaves[t].data={})},a.prototype.setMaxLabelLength=function(){var t;void 0===this.maxLabelLength[this.treeType]&&(this.maxLabelLength[this.treeType]=0);for(var e=0;e<this.leaves.length;e++)t=this.canvas.measureText(this.leaves[e].id),t.width>this.maxLabelLength[this.treeType]&&(this.maxLabelLength[this.treeType]=t.width)},a.prototype.loadCompleted=function(){v(this.canvasEl,"loaded")},a.prototype.loadStarted=function(){v(this.canvasEl,"loading")},a.prototype.loadError=function(t){v(this.canvasEl,"error",{message:t})},a.prototype.subtreeDrawn=function(t){v(this.canvasEl,"subtree",{node:t})},a.prototype.nodesSelected=function(t){v(this.canvasEl,"selected",{nodeIds:t})},a.prototype.addListener=function(t,e){g(this.canvasEl,t,e)},a.prototype.getBounds=function(){for(var t=this.root.startx,e=this.root.startx,s=this.root.starty,a=this.root.starty,i=this.leaves.length;i--;){var n=this.leaves[i].centerx,r=this.leaves[i].centery,o=this.leaves[i].angle,h=this.leaves[i].getNodeSize()+(this.showLabels?this.maxLabelLength[this.treeType]+this.leaves[i].getLabelSize():0)+(this.showMetadata?this.getMetadataColumnHeadings().length*this.metadataXStep:0);n+=h*Math.cos(o),r+=h*Math.sin(o),t=Math.min(t,n),e=Math.max(e,n),s=Math.min(s,r),a=Math.max(a,r)}return[[t,s],[e,a]]},a.prototype.fitInPanel=function(){var t=this.getBounds(),e=t[0][0],s=t[1][0],a=t[0][1],i=t[1][1],n=50,r=[this.canvas.canvas.width-n,this.canvas.canvas.height-n];this.zoom=Math.min(r[0]/(s-e),r[1]/(i-a)),this.offsety=(i+a)*this.zoom/-2,this.offsetx=(s+e)*this.zoom/-2},a.prototype.on=a.prototype.addListener,a.prototype.adjustForPixelRatio=function(){var t=(window.devicePixelRatio||1)/f(this.canvas);this.canvas.canvas.style.height=this.canvas.canvas.height+"px",this.canvas.canvas.style.width=this.canvas.canvas.width+"px",t>1&&(this.canvas.canvas.width*=t,this.canvas.canvas.height*=t)},a.prototype.treeTypeChanged=function(t,e){v(this.canvasEl,"typechanged",{oldType:t,newType:e})},a.prototype.resetTree=function(){if(this.origBranches){this.branches=this.origBranches;for(var t in this.origBL)this.branches[t].branchLength=this.origBL[t],this.branches[t].parent=this.origP[t];this.leaves=this.origLeaves,this.root=this.origRoot}},a.prototype.rotateBranch=function(t){this.branches[t.id].rotate()},a.prototype.buildLeaves=function(){this.leaves=[];for(var t=this.root.getChildIds(),e=0;e<t.length;e++)this.leaves.push(this.branches[t[e]])},a.prototype.exportNwk=function(){var t=this.root.getNwk();return t.substr(0,t.lastIndexOf(")")+1)+";"},a.prototype.resizeToContainer=function(){this.setSize(this.canvasEl.offsetWidth,this.canvasEl.offsetHeight),this.draw(),this.history.resizeTree()},a.prototype.downloadAllLeafIds=function(){this.root.downloadLeafIdsFromBranch()},a.prototype.exportCurrentTreeView=function(){var t=this.getPngUrl(),e=document.createElement("a"),s="undefined"!=typeof e.download,a=document.createEvent("Event");e.href=t,e.target="_blank",s&&(e.download="phylocanvas.png"),a.initEvent("click",!0,!0),e.dispatchEvent(a),s&&(window.URL||window.webkitURL).revokeObjectURL(e.href)},t.exports=a},function(t,e,s){function a(){this.angle=0,this.branchLength=!1,this.canvas=null,this.centerx=0,this.centery=0,this.children=[],this.collapsed=!1,this.colour="rgba(0,0,0,1)",this.data={},this.id="",this.interx=0,this.intery=0,this.label=null,this.leaf=!0,this.maxChildAngle=0,this.minChildAngle=i.FULL,this.nodeShape="circle",this.parent=null,this.radius=1,this.selected=!1,this.startx=0,this.starty=0,this.totalBranchLength=0,this.tree={}}var i=s(9).Angles,n=s(9).Shapes,r=s(2).setupDownloadLink;a.prototype.clicked=function(t,e){var s,a;if(!this.dragging){if(t<this.maxx&&t>this.minx&&e<this.maxy&&e>this.miny)return this;for(s=this.children.length-1;s>=0;s--)if(a=this.children[s].clicked(t,e))return a}},a.prototype.drawMetadata=function(){var t,e,s=this.getLabelStartX()+this.tree.maxLabelLength[this.tree.treeType],a=0,n=[],r=this.tree.textSize,o=this.tree.metadataXStep/2;if(this.tree.nodeAlign&&("rectangular"===this.tree.treeType?s+=this.tree.farthestNodeFromRootX-this.centerx:"hierarchy"===this.tree.treeType&&(s+=this.tree.farthestNodeFromRootY-this.centery)),!this.tree.metadataHeadingDrawn&&this.tree.nodeAlign&&"circular"!==this.tree.treeType&&"radial"!==this.tree.treeType&&(this.drawMetadataHeading(s,a),this.tree.metadataHeadingDrawn=!0),Object.keys(this.data).length>0){for(this.canvas.beginPath(),this.angle>i.QUARTER&&this.angle<i.HALF+i.QUARTER&&this.canvas.rotate(i.HALF),n=this.tree.selectedMetadataColumns.length>0?this.tree.selectedMetadataColumns:Object.keys(this.data),a-=r/2,t=0;t<n.length;t++)e=n[t],s+=this.tree.metadataXStep,window.parseInt(this.data[e])?(this.canvas.fillStyle=this.tree.colour1,this.canvas.fillRect(s,a,o,r)):0===window.parseInt(this.data[e])&&(this.canvas.fillStyle=this.tree.colour0,this.canvas.fillRect(s,a,o,r));this.canvas.stroke(),this.canvas.closePath()}},a.prototype.drawMetadataHeading=function(t,e){var s,a,i;for(s=this.tree.selectedMetadataColumns.length>0?this.tree.selectedMetadataColumns:Object.keys(this.data),this.canvas.font="12px Sans-serif",this.canvas.fillStyle="black",i=0;i<s.length;i++)a=s[i],t+=this.tree.metadataXStep,this.canvas.rotate(-Math.PI/2),"rectangular"===this.tree.treeType?(this.canvas.textAlign="left",this.canvas.fillText(a,20,t+6)):"hierarchy"===this.tree.treeType?(this.canvas.textAlign="right",this.canvas.fillText(a,-20,t+8)):"diagonal"===this.tree.treeType&&(this.canvas.textAlign="left",this.canvas.fillText(a,20,t+6)),this.canvas.rotate(Math.PI/2)},a.prototype.drawLabel=function(){var t,e,s,a=this.tree.textSize,n=this.getLabel();this.canvas.font=a+"pt "+this.tree.font,t=this.canvas.measureText(n),void 0===this.tree.maxLabelLength[this.tree.treeType]&&(this.tree.maxLabelLength[this.tree.treeType]=0),t.width>this.tree.maxLabelLength[this.tree.treeType]&&(this.tree.maxLabelLength[this.tree.treeType]=t.width),e=this.getLabelStartX(),s=a/2,this.tree.nodeAlign&&("rectangular"===this.tree.treeType?e+=this.tree.farthestNodeFromRootX-this.centerx:"hierarchy"===this.tree.treeType&&(e+=this.tree.farthestNodeFromRootY-this.centery)),this.angle>i.QUARTER&&this.angle<i.HALF+i.QUARTER&&(this.canvas.rotate(i.HALF),e=-e-1*t.width),this.canvas.beginPath(),this.canvas.fillStyle=this.getTextColour(),this.canvas.fillText(n,e,s),this.canvas.closePath()},a.prototype.setNodeDimensions=function(t,e,s){this.minx=t-s,this.maxx=t+s,this.miny=e-s,this.maxy=e+s},a.prototype.drawNode=function(){var t=this.getNodeSize(),e=t,s=this.leaf?e*Math.cos(this.angle)+this.centerx:this.centerx,a=this.leaf?e*Math.sin(this.angle)+this.centery:this.centery;if(this.canvas.beginPath(),this.canvas.fillStyle=this.selected?this.tree.selectedColour:this.colour,t*this.tree.zoom<5||!this.leaf?this.setNodeDimensions(s,a,5/this.tree.zoom):this.setNodeDimensions(s,a,t),this.collapsed){var n=this.getChildIds(),r=n.length;"radial"===this.tree.treeType&&(r/=7),"circular"===this.tree.treeType&&(r/=3),this.canvas.globalAlpha=.3,this.canvas.beginPath(),this.canvas.arc(s,a,r,0,2*Math.PI,!1),this.canvas.fillStyle=this.tree.defaultCollapsedOptions.color?this.tree.defaultCollapsedOptions.color:"purple",this.canvas.fill(),this.canvas.globalAlpha=1}else if(this.leaf){var o=this.canvas.lineWidth;this.tree.nodeAlign&&(this.canvas.lineWidth=this.canvas.lineWidth/10,this.canvas.beginPath(),"rectangular"===this.tree.treeType&&this.canvas.moveTo(this.tree.farthestNodeFromRootX,this.centery),"hierarchy"===this.tree.treeType&&this.canvas.moveTo(this.centerx,this.tree.farthestNodeFromRootY),this.canvas.closePath(),this.canvas.fill()),this.canvas.save(),this.canvas.translate(this.centerx,this.centery),this.canvas.rotate(this.angle),this.tree.nodeRenderers[this.nodeShape](this),(this.tree.showLabels||this.tree.hoverLabel&&this.highlighted)&&this.drawLabel(),this.tree.showMetadata&&this.drawMetadata(),this.canvas.restore(),this.canvas.lineWidth=o}if(this.canvas.closePath(),this.highlighted){this.canvas.beginPath();var h=this.canvas.lineWidth;this.canvas.strokeStyle=this.tree.highlightColour,this.canvas.lineWidth=this.tree.highlightWidth/this.tree.zoom,this.canvas.arc(s,a,(this.leaf?this.getNodeSize():0)+(5+this.tree.highlightWidth/2)/this.tree.zoom,0,i.FULL,!1),this.canvas.stroke(),this.canvas.lineWidth=h,this.canvas.strokeStyle=this.tree.branchColour,this.canvas.closePath()}},a.prototype.getChildIds=function(){var t,e=[];if(this.leaf)return[this.id];for(e=[],t=0;t<this.children.length;t++)e=e.concat(this.children[t].getChildIds());return e},a.prototype.getChildCount=function(){var t,e=0;if(this.leaf)return 1;for(t=0;t<this.children.length;t++)e+=this.children[t].getChildCount();return e},a.prototype.getChildYTotal=function(){var t,e=0;if(this.leaf)return this.centery;for(t=0;t<this.children.length;t++)e+=this.children[t].getChildYTotal();return e},a.prototype.setSelected=function(t,e){var s=this.id,a=0;if(this.selected=t,e)for(a=0;a<this.children.length;a++)s=s+","+this.children[a].setSelected(t,e);return s},a.prototype.setHighlighted=function(t){var e;if(this.highlighted=t,!t)for(e=0;e<this.children.length;e++)this.children[e].setHighlighted(t)},a.prototype.reset=function(){var t,e;for(this.startx=0,this.starty=0,this.centerx=0,this.centery=0,this.angle=null,this.minChildAngle=i.FULL,this.maxChildAngle=0,e=0;e<this.children.length;e++)try{this.children[t].pcReset()}catch(s){return s}},a.prototype.parseNwk=function(t,e){var e=this.parseLabel(t,e);return":"===t[e]?e=this.parseNodeLength(t,e+1):this.branchLength=0,this.id&&""!==this.id||(this.id=this.tree.genId()),e},a.prototype.parseLabel=function(t,e){var s,a,i="";for(e;":"!==t[e]&&","!==t[e]&&")"!==t[e]&&e<t.length;e++)i+=t[e];if(!i)return e;if(i.match(/\*/)){if(s=i.split("**"),this.id=s[0],1===s.length)return e;for(s=s[1].split("*"),a=0;a<s.length;a+=2)switch(s[a]){case"nsz":this.radius=window.parseInt(s[a+1]);break;case"nsh":n[s[a+1]]?this.nodeShape=n[s[a+1]]:this.nodeRenderers[s[a+1]]?this.nodeShape=s[a+1]:this.nodeShape="circle";break;case"ncol":this.colour=s[a+1];var r="0x"+this.colour.substring(0,2),o="0x"+this.colour.substring(2,4),h="0x"+this.colour.substring(4,6);this.colour="rgba("+parseInt(r,16).toString()+","+parseInt(o,16).toString()+","+parseInt(h,16).toString()+",1)"}}else this.id=i;return e},a.prototype.parseNodeLength=function(t,e){var s="";for(e;")"!==t[e]&&","!==t[e];e++)s+=t[e];return this.branchLength=parseFloat(s),this.branchLength<0&&(this.branchLength=0),e},a.prototype.redrawTreeFromBranch=function(){this.tree.redrawFromBranch(this)},a.prototype.saveChildren=function(){var t;for(t=0;t<this.children.length;t++)this.tree.saveNode(this.children[t]),this.children[t].saveChildren()},a.prototype.collapse=function(){this.collapsed=this.leaf===!1},a.prototype.expand=function(){this.collapsed=!1},a.prototype.toggleCollapsed=function(){this.collapsed?this.expand():this.collapse()},a.prototype.setTotalLength=function(){var t;for(this.parent?(this.totalBranchLength=this.parent.totalBranchLength+this.branchLength,this.totalBranchLength>this.tree.maxBranchLength&&(this.tree.maxBranchLength=this.totalBranchLength)):(this.totalBranchLength=this.branchLength,this.tree.maxBranchLength=this.totalBranchLength),t=0;t<this.children.length;t++)this.children[t].setTotalLength()},a.prototype.addChild=function(t){t.parent=this,t.canvas=this.canvas,t.tree=this.tree,this.leaf=!1,this.children.push(t)},a.prototype.getChildColours=function(){var t=[];return this.children.forEach(function(e){var s=0===e.children.length?e.colour:e.getColour();-1===t.indexOf(s)&&t.push(s)}),t},a.prototype.getColour=function(){var t;return this.selected?this.tree.selectedColour:this.tree.backColour===!0?this.children.length?(t=this.getChildColours(),1===t.length?t[0]:this.tree.branchColour):this.colour:"function"==typeof this.tree.backColour?this.tree.backColour(this):this.tree.branchColour},a.prototype.getNwk=function(){var t,e,s;if(this.leaf)return this.id+":"+this.branchLength;for(t=[],e=0;e<this.children.length;e++)t.push(this.children[e].getNwk());return s="("+t.join(",")+"):"+this.branchLength},a.prototype.getTextColour=function(){var t,e;return this.selected?this.tree.selectedColour:(this.highlighted?t=this.tree.highlightColour:this.tree.backColour?this.children.length?(e=this.getChildColours(),t=1===e.length?e[0]:this.tree.branchColour):t=this.colour:t=this.tree.branchColour,t)},a.prototype.getLabel=function(){return void 0!==this.label&&null!==this.label?this.label:this.id},a.prototype.getLabelSize=function(){return this.tree.canvas.measureText(this.getLabel()).width},a.prototype.getNodeSize=function(){return Math.max(0,this.tree.baseNodeSize*this.radius)},a.prototype.getLabelStartX=function(){return this.getNodeSize()+this.tree.baseNodeSize+2*this.radius},a.prototype.rotate=function(t){var e,s=[];for(e=this.children.length;e--;)s.push(this.children[e]);this.children=s,t.preventredraw||(this.tree.buildLeaves(),this.tree.draw(!0))},a.prototype.getChildNo=function(){return this.parent.children.indexOf(this)},a.prototype.downloadLeafIdsFromBranch=function(){var t,e=this.getChildIds();t=e.join("\n"),r(t,"pc_leaves.txt")},t.exports=a},function(t,e,s){function a(t){return t.preventDefault(),!1}function i(t,e,s){var a,i;if(document.createEvent?(a=document.createEvent("HTMLEvents"),a.initEvent(e,!0,!0)):(a=document.createEventObject(),a.eventType=e),a.eventName=e,a.bubbles=!1,s)for(i in s)s.hasOwnProperty(i)&&(a[i]=s[i]);document.createEvent?t.dispatchEvent(a):t.fireEvent("on"+a.eventType,a)}function n(t,e,s){t.addEventListener?t.addEventListener(e,s,!1):t.attachEvent("on"+e,function(){return s.call(t,window.event)})}function r(t){t.stopPropagation(),t.preventDefault()}function o(t,e){var s;return s="string"==typeof e?function(s){return t[e]?t[e](s):void 0}:function(){return e(t)}}t.exports.preventDefault=a,t.exports.fireEvent=i,t.exports.addEvent=n,t.exports.killEvent=r,t.exports.createHandler=o},function(t,e,s){function a(t,e){n.call(this,t,"pc-context-menu"),e&&e.length?this.menuItems=e.map(function(t){return{handler:t.handler,text:t.text||"New Menu Item",nodeType:t.nodeType||void 0}}):this.menuItems=h,this.fontSize="8pt"}function i(t,e){return e?e.leaf&&"internal"!==t.nodeType?!0:e.leaf||"internal"!==t.nodeType?!1:!0:!t.nodeType}var n=s(7),r=s(5).createHandler,o=s(5).preventDefault,h=[{text:"Redraw Subtree",handler:"redrawTreeFromBranch",nodeType:"internal"},{text:"Show Labels",handler:"displayLabels"},{text:"Hide Labels",handler:"hideLabels"},{text:"Collapse/Expand branch",handler:"toggleCollapsed",nodeType:"internal"},{text:"Rotate Branch",handler:"rotate",nodeType:"internal"},{text:"Export As Image",handler:"exportCurrentTreeView"},{text:"Download All Leaf IDs",handler:"downloadAllLeafIds"},{text:"Download Branch Leaf IDs",handler:"downloadLeafIdsFromBranch",nodeType:"internal"}];a.prototype=Object.create(n.prototype),a.prototype.mouseover=function(t){t.style.backgroundColor="#E2E3DF"},a.prototype.mouseout=function(t){t.style.backgroundColor="transparent"},a.prototype.click=function(){r(this,"close")},a.prototype.createContent=function(t){var e,s,a,h=document.createElement("ul");for(h.style.margin="0",h.style.padding="0",e=0;e<this.menuItems.length;e++)s=this.menuItems[e],i(s,t)&&(a=n.prototype.createElement.call(this,"li",s.text),a.style.listStyle="none outside none",s.nodeType?a.addEventListener("click",r(t,s.handler)):a.addEventListener("click",r(this.tree,s.handler)),a.addEventListener("click",this.click),a.addEventListener("contextmenu",o),a.addEventListener("mouseover",r(a,this.mouseover)),a.addEventListener("mouseout",r(a,this.mouseout)),h.appendChild(a));document.body.addEventListener("click",r(this,"close")),this.element.appendChild(h)},t.exports=a},function(t,e,s){function a(t,e,s){this.tree=t,this.element=s||document.createElement("div"),this.element.style.display="none",this.element.style.position="fixed",this.element.style.border="1px solid #CCCCCC",this.element.style.background="#FFFFFF",this.element.style.letterSpacing="0.5px",this.element.className=e||"pc-tooltip",this.closed=!0,this.tree.canvasEl.appendChild(this.element)}a.prototype.close=function(){this.element.style.display="none",this.closed=!0},a.prototype.createElement=function(t,e){var s=document.createElement(t||"div");return s.style.cursor="pointer",s.style.padding="0.3em 0.5em 0.3em 0.5em",s.style.fontFamily=this.tree.font,s.style.fontSize=this.fontSize||"12pt",s.appendChild(document.createTextNode(e)),s},a.prototype.createContent=function(t){this.element.appendChild(this.createElement("div",t.getChildIds().length))},a.prototype.open=function(t,e,s){for(;this.element.hasChildNodes();)this.element.removeChild(this.element.firstChild);this.createContent(s),t&&e?(this.element.style.top=e+"px",this.element.style.left=t+"px"):(this.element.style.top="100px",this.element.style.left="100px"),this.element.style.zIndex=2e3,this.element.style.display="block",this.element.style.backgroundColor="#FFFFFF",this.closed=!1},t.exports=a},function(t,e,s){function a(t){this.tree=t,this.cel=document.createElement("canvas"),this.cel.id=this.tree.canvasEl.id+"Navi",this.cel.style.zIndex="100",this.cel.style.backgroundColor="#FFFFFF",this.cel.width=this.tree.canvas.canvas.width/3,this.cel.height=this.tree.canvas.canvas.height/3,this.cel.style.position="absolute",this.cel.style.bottom="0px",this.cel.style.right="0px",this.cel.style.border="1px solid #CCCCCC",this.tree.canvasEl.appendChild(this.cel),this.ctx=this.cel.getContext("2d"),this.ctx.translate(this.cel.width/2,this.cel.height/2),this.ctx.save()}a.prototype.drawFrame=function(){var t,e,s,a=this.cel.width,i=this.cel.height,n=a/2,r=i/2;this.ctx.restore(),this.ctx.save(),this.ctx.clearRect(-n,-r,a,i),this.ctx.strokeStyle="rgba(180,180,255,1)",this.tree.drawn?this.ctx.drawImage(this.img,-n,-r,this.cel.width,this.cel.height):(t=this.tree.canvas.canvas.toDataURL(),this.img=document.createElement("img"),this.img.src=t,e=this,this.img.onload=function(){e.ctx.drawImage(e.img,-n,-r,e.cel.width,e.cel.height)},this.baseOffsetx=this.tree.offsetx,this.baseOffsety=this.tree.offsety,this.baseZoom=this.tree.zoom),s=1/(this.tree.zoom/this.baseZoom),this.ctx.lineWidth=this.ctx.lineWidth/s,this.ctx.translate((this.baseOffsetx-this.tree.offsetx*s)*s,(this.baseOffsety-this.tree.offsety*s)*s),this.ctx.scale(s,s),this.ctx.strokeRect(-n,-r,a,i)},a.prototype.resize=function(){this.cel.width=this.tree.canvas.canvas.width/3,this.cel.height=this.tree.canvas.canvas.height/3,this.ctx.translate(this.cel.width/2,this.cel.height/2),this.drawFrame()},t.exports=a},function(t,e,s){t.exports.Angles={FORTYFIVE:Math.PI/4,QUARTER:Math.PI/2,HALF:Math.PI,FULL:2*Math.PI},t.exports.Shapes={x:"star",s:"square",o:"circle",t:"triangle"}},function(t,e,s){function a(t){return t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||1}t.exports.getBackingStorePixelRatio=a}])});